<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Record</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/auth.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
    <div style="width: 60%; max-width: 600px; margin: auto; padding: 2%; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.3);">
        <h4 id="current-datetime"></h4>
        <h1>Attendance Check In/Out</h1>
        
        <div class="input-container">
            <h3>Scan Card</h3>
            <input type="text" id="cardNumber" placeholder="Scan your card" autofocus style="font-size: 16px; width: 100%; padding: 10px;">
        </div>
    </div>

    <div id="attendanceResult" style="margin-top:20px;">
        {% if confirm %}
        <div class="user-table-container">
            <table class="user-data-table" id="attendanceTable">
                <thead>
                    <tr>
                        <th>Exam Details</th>
                        <th>Attendance Record</th>
                        <th>Attendance Remark</th>
                    </tr>
                </thead>
                <tbody>
                    <tr id="attendanceRow">
                        <td>
                            <div class="info-grid" id="examDetails">
                                <div>Course Name</div><div><strong>: {{ confirm.report.exam.course.courseName }}</strong></div>
                                <div>Course Code/Section</div><div><strong>: {{ confirm.report.exam.course.courseCodeSectionIntake }}</strong></div>
                                <div>Number of Students</div><div><strong>: {{ confirm.report.exam.course.courseStudent }}</strong></div>
                                <div>Exam Date</div><div><strong>: {{ confirm.report.exam.examStartTime.strftime("%d/%b/%Y") }} - {{ confirm.report.exam.examEndTime.strftime("%d/%b/%Y") }}</strong></div>
                                <div>Exam Day</div><div><strong>: {{ confirm.report.exam.examStartTime.strftime("%A") }} - {{ confirm.report.exam.examEndTime.strftime("%A") }}</strong></div>
                                <div>Exam Time</div><div><strong>: {{ confirm.report.exam.examStartTime.strftime("%H:%M") }} - {{ confirm.report.exam.examEndTime.strftime("%H:%M") }}</strong></div>
                                <div>Exam Period</div><div><strong>: {{ (confirm.report.exam.examEndTime - confirm.report.exam.examStartTime).seconds // 3600 }}h {{ ((confirm.report.exam.examEndTime - confirm.report.exam.examStartTime).seconds % 3600) // 60 }}m</strong></div>
                                <div>Exam Venue</div><div><strong>: None</strong></div>
                            </div>
                        </td>
                        <td>
                            <div class="info-grid" id="attendanceTimes">
                                <div>Check-in Time</div><div><strong>: {{ confirm.checkIn.strftime("%d/%b/%Y %H:%M:%S") if confirm.checkIn else "None" }}</strong></div>
                                <div>Check-out Time</div><div><strong>: {{ confirm.checkOut.strftime("%d/%b/%Y %H:%M:%S") if confirm.checkOut else "None" }}</strong></div>
                            </div>
                            {% if confirm.checkIn and confirm.checkOut %}
                                {% set exam_start = confirm.report.exam.examStartTime %}
                                {% set exam_end = confirm.report.exam.examEndTime %}
                                {% set check_in = confirm.checkIn %}
                                {% set check_out = confirm.checkOut %}
                                {% set actual_start = [check_in, exam_start] | max %}
                                {% set actual_end = [check_out, exam_end] | min %}
                                {% set total_seconds = (actual_end - actual_start).total_seconds() %}
                                {% if total_seconds < 0 %}
                                    {% set total_seconds = 0 %}
                                {% endif %}
                                <div id="totalTime" style="color: green;">Total Invigilation Time: {{ (total_seconds / 3600) | round(2) }} hours</div>
                            {% endif %}
                        </td>
                        <td>
                            {% set remark_classes = {
                                "PENDING": "frame-pending",
                                "CHECK IN": "frame-completed",
                                "CHECK OUT": "frame-completed",
                                "COMPLETED": "frame-completed",
                                "CHECK IN LATE": "frame-expired",
                                "CHECK OUT EARLY": "frame-expired",
                                "EXPIRED": "frame-expired"
                            } %}
                            <span class="status" id="attendanceRemark" class="{{ remark_classes.get(confirm.remark, '') }}">[{{ confirm.remark }}]</span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        {% else %}
            <p id="noAttendance">No attendance records available.</p>
        {% endif %}
    </div>

    <script>
        // --- Update current datetime every second ---
        function updateDateTime() {
            const now = new Date();
            const options = { weekday: 'long', day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit',  minute: '2-digit',  second: '2-digit', hour12: false };
            const formatted = now.toLocaleString('en-GB', options).replace(',', ':');
            document.getElementById("current-datetime").textContent = formatted;
        }
        updateDateTime();
        setInterval(updateDateTime, 1000);

        // --- Auto-submit card scan ---
        const cardInput = document.getElementById('cardNumber');
        cardInput.addEventListener('input', function() {
            const cardValue = this.value.trim();
            if (cardValue.length > 0) {
                submitCard(cardValue);
                this.value = '';
            }
        });

        function submitCard(cardNumber) {
            fetch('{{ url_for("attendance_record") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({ cardNumber: cardNumber })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const d = data.data;

                    // Update exam details
                    const examDetails = document.getElementById("examDetails");
                    if (examDetails) {
                        examDetails.innerHTML = `
                            <div>Course Name</div><div><strong>: ${d.courseName}</strong></div>
                            <div>Course Code/Section</div><div><strong>: ${d.courseCode}</strong></div>
                            <div>Number of Students</div><div><strong>: ${d.students}</strong></div>
                            <div>Exam Start</div><div><strong>: ${d.examStart}</strong></div>
                            <div>Exam End</div><div><strong>: ${d.examEnd}</strong></div>
                        `;
                    }

                    // Update check-in/out times
                    const attendanceTimes = document.getElementById("attendanceTimes");
                    if (attendanceTimes) {
                        attendanceTimes.innerHTML = `
                            <div>Check-in Time</div><div><strong>: ${d.checkIn}</strong></div>
                            <div>Check-out Time</div><div><strong>: ${d.checkOut}</strong></div>
                        `;
                    }

                    // Update remark
                    const remarkEl = document.getElementById("attendanceRemark");
                    if (remarkEl) {
                        remarkEl.textContent = `[${d.remark}]`;
                    }

                    // Remove "No attendance" message if present
                    const noAtt = document.getElementById("noAttendance");
                    if (noAtt) noAtt.remove();

                } else {
                    alert(data.message || "Error updating attendance!");
                }
            })
            .catch(err => console.error('Error:', err));
        }
    </script>
</body>
</html>

<!-- upload.html -->
{% extends "mainPart/base.html" %}
{% block title %}UploadTimetable{% endblock %}
{% block content %}


{% with messages = get_flashed_messages() %}
  {% if messages %}
    <ul class="flashes">
      {% for message in messages %}
        <li>{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}
{% endwith %}

    <div class="menu-section">
        <div class="big-frame">
            <h2>Upload Masterfile</h2>
            <div class="small-frame">
                <form id="uploadLecturerList" method="POST" enctype="multipart/form-data">
                    <input type="file" id="lecturerList" name="lecturer_file" accept=".xlsx,.xls" required>
                    <button type="submit">Upload</button>
                </form>
            </div>  
        </div>
    </div>  

    <div class="menu-section">
        <h2>Table Record</h2>
        <div class="user-table-container">
            <table class="user-data-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>ID</th>
                        <th>Department</th>
                        <th>Email</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>{{user_name}}</td>
                        <td>{{user_id}}</td>
                        <td>{{user_department}}</td>
                        <td>{{user_email}}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            setupLecturerForm();

            const lecturerLastUploaded = localStorage.getItem('lecturerLastUploaded');
            if (lecturerLastUploaded) {
                const lecturerLastUploadedLabel = document.getElementById('lecturerLastUploadedLabel');
                if (lecturerLastUploadedLabel) {
                    lecturerLastUploadedLabel.textContent = `Last Uploaded: ${lecturerLastUploaded}`;
                }
            }
        });
        
        function setupLecturerForm() {
            const uploadLecturerList = document.getElementById('uploadLecturerList');    
            if (uploadLecturerList && !uploadLecturerList.dataset.listenerAttached) {
                uploadLecturerList.addEventListener('submit', function(e) {
                    e.preventDefault();

                    const formData = new FormData(this);
                    const file = document.getElementById('lecturerList').files[0];

                    if (!file) {
                        alert('Please select a file');
                        return;
                    }

                    fetch('/upload_lecturers', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(data.message);
                            if (data.warnings) {
                                data.warnings.forEach(warning => alert('Warning: ' + warning));
                            }
                            const currentDate = new Date();
                            const formattedDate = currentDate.toLocaleString('en-GB', {
                                weekday: 'short', year: '2-digit', month: 'short', day: '2-digit',
                                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true
                            });
                            localStorage.setItem('lecturerLastUploaded', formattedDate);
                            window.location.reload(true);
                        } else {
                            alert(data.message || 'Upload failed');
                        }
                    })
                    .catch(error => {
                        alert('Upload failed: ' + error.message);
                    });

                });
                uploadLecturerList.dataset.listenerAttached = "true";
            }
        }
    </script>



    
{% endblock %}

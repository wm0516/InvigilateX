{% extends "user/userBase.html" %}
{% block title %}Timetable{% endblock %}
{% block head_title %}<h2>{{ user_department }} - School Timetable</h2>{% endblock %}

{% block content %}
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <div style="position: relative;">
                <input type="text" id="searchInput" name="search_mergeTimetable" placeholder="Search..." value="{{ search_mergeTimetable }}" style="border-radius: 6px; width: 100%;">
                <i class="fa fa-search" id="searchBtn" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer;"></i>
            </div>
            <div class="button-wrapper" style="margin-bottom: auto;">
                <button id="generatePDF" style="background-color: black;">Download as PDF</button>
            </div>
        </div>
    </div>
    <div id="noResults" style="display: none; text-align: center; margin-top: 10px; font-weight: bold; color: #b00;">No results found.</div>

    <form method="get" style="display:flex; align-items:center; gap:8px; width:50%; margin-top: 1%;">
        <label for="lecturer">Select_Lecturer:</label>
        <select name="lecturer" id="lecturer" onchange="this.form.submit()">
            <option value="">All Lecturers</option>
            {% for lecturer in lecturers %}
                <option value="{{ lecturer }}" {% if lecturer == selected_lecturer %}selected{% endif %}>
                    {{ lecturer }}
                </option>
            {% endfor %}
        </select>

        {% if selected_lecturer %}
            <button type="button" onclick="window.location.href='{{ url_for('user_mergeTimetable') }}'" style="padding: 1%; background-color: #edd5ff;">
                Clear_Filter
            </button>
        {% endif %}
    </form>

    <br><div id="dayLegend" style="display:flex;gap:15px;align-items:center;"></div>
    <div class="user-table-container">
        <table class="user-data-table" id="mergeTimetable" border="1">
            <thead>
                <tr>
                    <th>Day / Time</th>
                    {% for time in ["07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"] %}
                        <th>{{ time }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody> 
                {% set day_colors = {
                    "MON": "#e3f2fd", 
                    "TUE": "#fce4ec", 
                    "WED": "#e8f5e9",  
                    "THU": "#fff3e0",  
                    "FRI": "#ede7f6" 
                } %}
                {% for day in ["MON", "TUE", "WED", "THU", "FRI"] %}
                <tr style="background-color: {{ day_colors[day] }}">
                    <td><strong>{{ day }}</strong><br></td>

                    {% for time in ["07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"] %}
                    <td>
                        {% for row in timetable_rows %}
                            {% if row.classDay == day %}
                                {% set start = row.classTime.split('-')[0].strip() %}
                                {% set end = row.classTime.split('-')[1].strip() %}
                                {% if time >= start and time < end %}
                                    <div style="border:1px solid #ccc; padding:4px; background:#f8f9fa; margin-bottom: 1%;">
                                        <strong>Lecturer</strong>: <i>{{ row.lecturerName }}</i><br>
                                        <strong>Course</strong>:<br><i>{{ row.courseName }}</i><br>
                                        <strong>Class Type</strong>: <i>{{ row.classType }}</i><br>
                                        <strong>Room</strong>: <i>{{ row.classRoom }}</i><br>
                                    </div>
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
const days = {
    Monday: '#e3f2fd',
    Tuesday: '#fce4ec',
    Wednesday: '#e8f5e9',
    Thursday: '#fff3e0',
    Friday: '#ede7f6'
};
const container = document.getElementById('dayLegend');
Object.entries(days).forEach(([day, color]) => {
    const div = document.createElement('div');
    div.style.display = 'flex';
    div.style.alignItems = 'center';
    div.style.gap = '5px';
    div.innerHTML = `<span style="width:20px; height:20px; background:${color}; display:inline-block; border-radius:4px; border: 1px solid black;"></span><span>${day}</span>`;
    container.appendChild(div);
});

document.getElementById('generatePDF').addEventListener('click', () => {
    const { jsPDF } = window.jspdf;
    const table = document.querySelector('.user-table-container table');
    if (!table) return alert("No timetable table found!");

    const headerH2 = document.querySelector('h2');
    const headerText = headerH2 ? headerH2.textContent : "Timetable";
    const nowMY = new Date().toLocaleString("en-GB", {
        timeZone: "Asia/Kuala_Lumpur",
        day: "2-digit",
        month: "short",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
        hour12: true
    });
    const filename = `{{ user_department }} MergeTimetable.pdf`;

    html2canvas(table, { scale: 2 }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF('l', 'pt', 'a4'); // landscape

        const pdfWidth = pdf.internal.pageSize.getWidth();

        // Title
        pdf.setFontSize(18);
        pdf.setFont(undefined, 'bold');
        pdf.text(headerText, pdfWidth / 2, 40, { align: "center" });

        // Timestamp
        pdf.setFontSize(10);
        pdf.setFont(undefined, 'normal');
        pdf.text(`Downloaded on: ${nowMY}`, pdfWidth / 2, 60, { align: "center" });

        // Table image
        const pdfHeight = (canvas.height * (pdfWidth - 40)) / canvas.width;
        pdf.addImage(imgData, 'PNG', 20, 80, pdfWidth - 40, pdfHeight);

        pdf.save(filename);
    });
});



document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("searchInput");
    const noResults = document.getElementById("noResults");
    const table = document.getElementById("mergeTimetable");

    function searchTimetable() {
        const filter = searchInput.value.toLowerCase();
        let anyVisible = false;

        if (!table) return;

        const rows = table.getElementsByTagName("tr");
        // Skip header row
        for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            const cells = row.getElementsByTagName("td");
            let rowHasMatch = false;

            for (let j = 0; j < cells.length; j++) {
                const divs = cells[j].getElementsByTagName("div");
                let cellHasMatch = false;

                for (let k = 0; k < divs.length; k++) {
                    const div = divs[k];
                    const text = div.textContent.toLowerCase();
                    if (text.includes(filter)) {
                        div.style.display = ""; // show matching
                        cellHasMatch = true;
                    } else {
                        div.style.display = "none"; // hide non-matching
                    }
                }

                if (cellHasMatch) rowHasMatch = true;
            }

            row.style.display = rowHasMatch ? "" : "none"; // hide row if no matches at all
            if (rowHasMatch) anyVisible = true;
        }

        noResults.style.display = anyVisible ? "none" : "block";
    }

    searchInput.addEventListener("keyup", searchTimetable);
    document.getElementById("searchBtn")?.addEventListener("click", searchTimetable);
});
</script>
{% endblock %}

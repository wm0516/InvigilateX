{% extends "user/userBase.html" %}
{% block title %}InvigilationTimetable{% endblock %}
{% block head_title %}<h2>Invigilation Timetable</h2>{% endblock %}
{% block content %}
<div class="menu-section">
    <div style="display: flex; align-items: center; gap: 10px;">
        <div style="position: relative;">
            <input type="text" id="searchInput" name="search_InvigilationTimetable" placeholder="Search..." value="{{ search_InvigilationTimetable }}" style="border-radius: 6px; width: 100%;">
            <i class="fa fa-search" id="searchBtn" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer;"></i>
        </div>
        <div class="button-wrapper" style="margin-bottom: auto;">
            <button id="generatePDF" style="background-color: black;">Download as PDF</button>
        </div>
    </div>
    <div id="noResults" style="display: none; text-align: center; margin-top: 10px; font-weight: bold; color: #b00;">No results found.</div>

    <div style="display: flex; gap: 15px; align-items: center;">
        <h4>Exam Status:</h4>
        <div style="display: flex; align-items: center; gap: 5px;">
            <span style="width: 20px; height: 20px; background-color: lightgrey; display: inline-block; border-radius: 4px;"></span>
            <span>Past Exam</span>
        </div>
        <div style="display: flex; align-items: center; gap: 5px;">
            <span style="width: 20px; height: 20px; background-color: #75bdf9; display: inline-block; border-radius: 4px;"></span>
            <span>Upcoming Exam</span>
        </div>
        <div style="display: flex; align-items: center; gap: 5px;">
            <span style="width: 20px; height: 20px; background-color: #dc74f7; display: inline-block; border-radius: 4px;"></span>
            <span>Overnight Exam (Starts Today, Ends Tomorrow)</span>
        </div>
    </div><br>

    <div class="calendar-container">
        {% for date, venues in calendar_data.items() %}
        <div class="calendar-day">
            <h3 class="calendar-date" data-date="{{ date.isoformat() }}">
                {{ date.strftime("%A, %d %B %Y") }} |
                [Total Venues: {{ venues|length }}]
            </h3>

            <div class="exam-grid">
                {% for venue, exams in venues.items() %}
                <div class="exam-card"
                    style="background-color:
                    {% if exams | selectattr('is_overnight') | list | length > 0 %}#dc74f7{% else %}#75bdf9{% endif %};">
                    <strong>Venue: {{ venue }}</strong><br><br>

                    {% for exam in exams %}
                        • <strong>{{ exam.course_code }}</strong>
                        ({{ exam.start_time.strftime("%H:%M") }}–{{ exam.end_time.strftime("%H:%M") }})
                        | Capacity: {{ exam.capacity }}
                        {% if not exam.has_invigilator %}
                            <span style="color:red;">[No Invigilator]</span>
                        {% endif %}
                        <br>
                    {% endfor %}

                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const days = [...document.querySelectorAll(".calendar-day")];
    if (!days.length) return;

    const today = new Date().setHours(0, 0, 0, 0);
    let target = null;

    for (const d of days) {
        // Use data-date attribute instead of parsing text
        const dateAttr = d.querySelector(".calendar-date").dataset.date;
        const date = new Date(dateAttr);

        if (!isNaN(date) && date >= today) { 
        target = d; 
        break; 
        }
    }
    if (!target) target = days[days.length - 1];
    // Delay scroll until rendering done
    setTimeout(() => {
        target.scrollIntoView({ behavior: "smooth", block: "start", inline: "nearest" });
    }, 100);
});

document.getElementById("generatePDF").addEventListener("click", async () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l', 'mm', 'a4'); // Landscape A4
    const margin = 15;
    const userLevel = Number("{{ current_user.userLevel }}");
    const userName = "{{ current_user.userName }}";
    const userDepartment = "{{ current_user.userDepartment }}";
    const pageHeight = doc.internal.pageSize.getHeight();
    const pageWidth = doc.internal.pageSize.getWidth(); 
    const nowMY = new Date().toLocaleString("en-GB", {timeZone: "Asia/Kuala_Lumpur", day: "2-digit", month: "short", year: "numeric", hour: "2-digit", minute: "2-digit", hour12: true});
    
    if (userLevel === 1) {
        doc.text(`${userName}'s Invigilation Timetable`, pageWidth/2, margin, {align: "center"});
    } else {
        doc.text(`${userDepartment} Invigilation Timetable`, pageWidth/2, margin, {align: "center"});
    }

    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);
    doc.text(`Downloaded on: ${nowMY}`, pageWidth / 2, margin + 8, { align: "center" });

    let y = margin + 15;

    const days = document.querySelectorAll(".calendar-day");
    if (!days.length) return alert("No timetable found!");

    for (const [i, day] of days.entries()) {
        const dateText = day.querySelector(".calendar-date").innerText;
        const examList = day.querySelector(".exam-grid");

        // Capture this day's exam list
        const canvas = await html2canvas(examList, { scale: 2 });
        const imgData = canvas.toDataURL("image/png");

        const pdfWidth = pageWidth - 2 * margin;
        const imgProps = doc.getImageProperties(imgData);
        const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;

        // Padding & border calculations
        const topPadding = 6;
        const bottomPadding = 10;
        const totalBlockHeight = imgHeight + topPadding + bottomPadding + 8; // better spacing

        // Add new page if block exceeds height
        if (y + totalBlockHeight > pageHeight - margin) {
            doc.addPage();
            y = margin;
            doc.setFontSize(20);
            doc.text("Invigilation Timetable", pageWidth / 2, y, { align: "center" });
            y += 15;
        }

        // Draw border box
        doc.setDrawColor(0);
        doc.rect(margin - 3, y - 5, pdfWidth + 6, totalBlockHeight);

        // Day title
        doc.setFontSize(14);
        doc.text(dateText, margin, y + 5);

        // Image (exam content)
        const imageY = y + topPadding + 8;
        doc.addImage(imgData, 'PNG', margin, imageY, pdfWidth, imgHeight);

        // Move Y position for next day
        y += totalBlockHeight + 5;
    }
    if (userLevel === 1) {
        doc.save(`${userName}'s_Invigilation_Report.pdf`);
    } else {
        doc.save(`${userDepartment}_Invigilation_Report.pdf`);
    }
});

document.addEventListener("DOMContentLoaded", () => {
    const searchInput = document.getElementById("searchInput");
    const noResults = document.getElementById("noResults");

    if (!searchInput) return;

    searchInput.addEventListener("input", () => {
        const filter = searchInput.value.toLowerCase();
        let anyVisible = false;

        const days = document.querySelectorAll(".calendar-day");
        days.forEach(day => {
            const dateText = day.querySelector(".calendar-date").innerText.toLowerCase();
            let dayHasVisible = false;

            // Check if date matches filter
            if (dateText.includes(filter)) {
                dayHasVisible = true;
                day.querySelectorAll(".exam-card").forEach(card => card.style.display = "block");
            } else {
                // Check each exam card under this date
                const cards = day.querySelectorAll(".exam-card");
                cards.forEach(card => {
                    const text = card.innerText.toLowerCase();
                    if (text.includes(filter)) {
                        card.style.display = "block";
                        dayHasVisible = true;
                    } else {
                        card.style.display = "none";
                    }
                });
            }

            // Hide entire day if no cards or date match
            day.style.display = dayHasVisible ? "block" : "none";
            if (dayHasVisible) anyVisible = true;
        });

        noResults.style.display = anyVisible ? "none" : "block";
    });
});
</script>
{% endblock %}
{% extends "user/userBase.html" %}
{% block title %}InvigilationTimetable{% endblock %}
{% block head_title %}<h2>Invigilation Timetable</h2>{% endblock %}

{% block content %}
<div class="menu-section">

    <!-- Search + PDF -->
    <div style="display:flex; align-items:center; gap:10px;">
        <div style="position:relative;">
            <input type="text" id="searchInput"
                   placeholder="Search..."
                   style="border-radius:6px; width:250px;">
            <i class="fa fa-search"
               style="position:absolute; right:10px; top:50%; transform:translateY(-50%);"></i>
        </div>
        <button id="generatePDF" style="background:black; color:white;">
            Download as PDF
        </button>
    </div>

    <div id="noResults"
         style="display:none; text-align:center; margin-top:10px; font-weight:bold; color:#b00;">
        No results found.
    </div>

    <br>

    <!-- Timetable -->
    <div class="calendar-container">
        {% for venue, exams in venue_data.items() %}
            {% set exams_by_date = {} %}
            {% for exam in exams %}
                {% set d = exam.start_time.strftime("%d %b %Y") %}
                {% if d not in exams_by_date %}
                    {% set _ = exams_by_date.update({d: []}) %}
                {% endif %}
                {% set _ = exams_by_date[d].append(exam) %}
            {% endfor %}

            {% for date, day_exams in exams_by_date.items() %}
            <div class="venue-block"
                 style="margin-bottom:20px; padding:15px; border:1px solid #aaa; border-radius:8px;">

                <h2>{{ date }} | Total Exams: {{ day_exams|length }}</h2>

                <div class="exam-grid">
                    {% for exam in day_exams %}
                    <div class="exam-card"
                         style="border:1px solid #ccc; padding:8px; margin-bottom:6px; border-radius:5px;">
                        <strong>
                            {{ exam.course_code }}/{{ exam.section }}
                            â€“ {{ exam.course_name }}
                        </strong><br>
                        Time:
                        {{ exam.start_time.strftime("%H:%M") }}
                        -
                        {{ exam.end_time.strftime("%H:%M") }}<br>
                        Venue: {{ venue }}<br>
                        Students: {{ exam.students }}
                        {% if exam.is_overnight %}
                            <br><span style="color:#b400b4;">Overnight Exam</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}

<!-- REQUIRED LIBRARIES -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* Inject Django variables safely */
const userLevel = "{{ user.level|default:'' }}";
const userName = "{{ user.get_full_name|default:'User' }}";
const userDepartment = "{{ user.department.name|default:'Department' }}";

document.getElementById("generatePDF").addEventListener("click", async () => {

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("l", "mm", "a4");

    const margin = 15;
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();

    const now = new Date().toLocaleString("en-GB", {
        timeZone: "Asia/Kuala_Lumpur",
        day: "2-digit", month: "short", year: "numeric",
        hour: "2-digit", minute: "2-digit"
    });

    /* Header */
    doc.setFontSize(18);
    const title =
        ["LECTURER","PO","LAB_ASS"].includes(userLevel)
        ? `${userName}'s Invigilation Timetable`
        : `${userDepartment} Invigilation Timetable`;

    doc.text(title, pageWidth / 2, margin, { align: "center" });
    doc.setFontSize(10);
    doc.text(`Downloaded on: ${now}`, pageWidth / 2, margin + 8, { align: "center" });

    let y = margin + 20;

    const blocks = document.querySelectorAll(".venue-block");
    if (!blocks.length) {
        alert("No timetable to download.");
        return;
    }

    for (const block of blocks) {

        const canvas = await html2canvas(block, {
            scale: 2,
            useCORS: true
        });

        const imgData = canvas.toDataURL("image/png");
        const imgProps = doc.getImageProperties(imgData);
        const pdfWidth = pageWidth - margin * 2;
        const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;

        if (y + imgHeight > pageHeight - margin) {
            doc.addPage();
            y = margin;
        }

        doc.addImage(imgData, "PNG", margin, y, pdfWidth, imgHeight);
        y += imgHeight + 10;
    }

    doc.save("Invigilation_Timetable.pdf");
});

/* SEARCH */
document.getElementById("searchInput").addEventListener("input", function () {
    const filter = this.value.toLowerCase();
    let visible = false;

    document.querySelectorAll(".venue-block").forEach(block => {
        const text = block.innerText.toLowerCase();
        const show = text.includes(filter);
        block.style.display = show ? "block" : "none";
        if (show) visible = true;
    });

    document.getElementById("noResults").style.display =
        visible ? "none" : "block";
});
</script>
{% endblock %}

{% extends "user/userBase.html" %}
{% block title %}InvigilationTimetable{% endblock %}
{% block head_title %}<h2>Invigilation Timetable</h2>{% endblock %}
{% block content %}
<div class="menu-section">
    <div style="display: flex; align-items: center; gap: 10px;">
        <div style="position: relative;">
            <input type="text" id="searchInput" name="search_InvigilationTimetable" placeholder="Search..." value="{{ search_InvigilationTimetable }}" style="border-radius: 6px; width: 100%;">
            <i class="fa fa-search" id="searchBtn" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer;"></i>
        </div>
        <div class="button-wrapper" style="margin-bottom: auto;">
            <button id="generatePDF" style="background-color: black;">Download as PDF</button>
        </div>
    </div>
    <div id="noResults" style="display: none; text-align: center; margin-top: 10px; font-weight: bold; color: #b00;">No results found.</div>

    <div style="display: flex; gap: 15px; align-items: center;">
        <h4>Exam Status:</h4>
        <div style="display: flex; align-items: center; gap: 5px;">
            <span style="width: 20px; height: 20px; background-color: lightgrey; display: inline-block; border-radius: 4px;"></span>
            <span>Past Exam</span>
        </div>
        <div style="display: flex; align-items: center; gap: 5px;">
            <span style="width: 20px; height: 20px; background-color: #75bdf9; display: inline-block; border-radius: 4px;"></span>
            <span>Upcoming Exam</span>
        </div>
        <div style="display: flex; align-items: center; gap: 5px;">
            <span style="width: 20px; height: 20px; background-color: #dc74f7; display: inline-block; border-radius: 4px;"></span>
            <span>Overnight Exam (Starts Today, Ends Tomorrow)</span>
        </div>
    </div><br>

    <div class="calendar-container">
        {% for venue, exams in venue_data.items() %}
            {% set exams_by_date = {} %}
            {% for exam in exams %}
                {% set exam_date = exam.start_time.strftime("%d %b %Y") %}
                {% if exam_date not in exams_by_date %}
                    {% set _ = exams_by_date.update({exam_date: []}) %}
                {% endif %}
                {% set _ = exams_by_date[exam_date].append(exam) %}
            {% endfor %}

            {% for date, day_exams in exams_by_date.items() %}
                <div class="venue-block" style="margin-bottom: 20px; padding: 20px; border: 1px solid #aaa; border-radius: 8px;">
                    <h2>{{ date }} | Total Exams: {{ day_exams|length }}</h2>
                    <div class="exam-grid">
                        {% set grouped = {} %}
                        {% for exam in day_exams %}
                            {% set key = (exam.start_time, exam.end_time, venue) %}
                            {% if key not in grouped %}
                                {% set grouped = grouped.update({key: [exam]}) or grouped %}
                            {% else %}
                                {% set grouped = grouped.update({key: grouped[key] + [exam]}) or grouped %}
                            {% endif %}
                        {% endfor %}

                        {% for key, exams in grouped.items() %}
                            {% set card_ns = namespace(total_students=0) %}
                            <div class="exam-card" style="margin-bottom: 10px; padding: 8px; border: 1px solid #ccc; border-radius: 5px;">
                                {% set start_time, end_time, venue_name = key %}
                                <h3>Time: {{ start_time.strftime("%H:%M") }} - {{ end_time.strftime("%H:%M") }}<br>Venue: {{ venue_name }}<br></h3>
                                {% for exam in exams %}
                                    <strong>{{ exam.course_code }}/{{ exam.section }} â€“ {{ exam.course_name }} | Students: {{ exam.students }}</strong><br>
                                    {% if exam.is_overnight %}
                                        <span style="color: #b400b4;">Overnight Exam</span><br>
                                    {% endif %}
                                    {% set card_ns.total_students = card_ns.total_students + exam.students %}
                                {% endfor %}
                                <br><strong>Total Students: {{ card_ns.total_students }}</strong>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const days = [...document.querySelectorAll(".calendar-day")];
    if (!days.length) return;

    const today = new Date().setHours(0, 0, 0, 0);
    let target = null;

    for (const d of days) {
        // Use data-date attribute instead of parsing text
        const dateAttr = d.querySelector(".calendar-date").dataset.date;
        const date = new Date(dateAttr);

        if (!isNaN(date) && date >= today) { 
        target = d; 
        break; 
        }
    }
    if (!target) target = days[days.length - 1];
    // Delay scroll until rendering done
    setTimeout(() => {
        target.scrollIntoView({ behavior: "smooth", block: "start", inline: "nearest" });
    }, 100);
});

document.getElementById("generatePDF").addEventListener("click", async () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l', 'mm', 'a4'); // Landscape A4
    const margin = 15;
    const pageHeight = doc.internal.pageSize.getHeight();
    const pageWidth = doc.internal.pageSize.getWidth(); 
    const nowMY = new Date().toLocaleString("en-GB", {timeZone: "Asia/Kuala_Lumpur", day: "2-digit", month: "short", year: "numeric", hour: "2-digit", minute: "2-digit", hour12: true});
    
    if (userLevel === 1) {
        doc.text(`${userName}'s Invigilation Timetable`, pageWidth/2, margin, {align: "center"});
    } else {
        doc.text(`${userDepartment} Invigilation Timetable`, pageWidth/2, margin, {align: "center"});
    }

    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);
    doc.text(`Downloaded on: ${nowMY}`, pageWidth / 2, margin + 8, { align: "center" });

    let y = margin + 15;

    const days = document.querySelectorAll(".venue-block");
    if (!days.length) return alert("No timetable found!");

    for (const [i, day] of days.entries()) {
        const dateText = day.querySelector("h2").innerText;
        const examList = day.querySelector(".exam-grid");

        // Capture this day's exam list
        const canvas = await html2canvas(examList, { scale: 2 });
        const imgData = canvas.toDataURL("image/png");

        const pdfWidth = pageWidth - 2 * margin;
        const imgProps = doc.getImageProperties(imgData);
        const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;

        // Padding & border calculations
        const topPadding = 6;
        const bottomPadding = 10;
        const totalBlockHeight = imgHeight + topPadding + bottomPadding + 8; // better spacing

        // Add new page if block exceeds height
        if (y + totalBlockHeight > pageHeight - margin) {
            doc.addPage();
            y = margin;
            doc.setFontSize(20);
            doc.text("Invigilation Timetable", pageWidth / 2, y, { align: "center" });
            y += 15;
        }

        // Draw border box
        doc.setDrawColor(0);
        doc.rect(margin - 3, y - 5, pdfWidth + 6, totalBlockHeight);

        // Day title
        doc.setFontSize(14);
        doc.text(dateText, margin, y + 5);

        // Image (exam content)
        const imageY = y + topPadding + 8;
        doc.addImage(imgData, 'PNG', margin, imageY, pdfWidth, imgHeight);

        // Move Y position for next day
        y += totalBlockHeight + 5;
    }

    doc.save("Invigilation_Timetable.pdf");
});

document.addEventListener("DOMContentLoaded", () => {
    const searchInput = document.getElementById("searchInput");
    const noResults = document.getElementById("noResults");

    searchInput.addEventListener("input", () => {
        const filter = searchInput.value.toLowerCase();
        let anyVisible = false;

        document.querySelectorAll(".venue-block").forEach(block => {
            const headerText = block.querySelector("h2").innerText.toLowerCase();
            let blockVisible = false;

            const cards = block.querySelectorAll(".exam-card");

            cards.forEach(card => {
                const text = card.innerText.toLowerCase();
                if (text.includes(filter) || headerText.includes(filter)) {
                    card.style.display = "block";
                    blockVisible = true;
                } else {
                    card.style.display = "none";
                }
            });

            block.style.display = blockVisible ? "block" : "none";
            if (blockVisible) anyVisible = true;
        });

        noResults.style.display = anyVisible ? "none" : "block";
    });
});

</script>
{% endblock %}
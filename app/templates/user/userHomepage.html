{% extends "user/userBase.html" %}
{% set body_class = 'user-homepage' %}
{% block title %}Homepage{% endblock %}
{% block content %}
<h1>Hey! ðŸ‘‹ <i>{{ user_name }}</i></h1>

{% if user_level in ["DEAN", "HOS", "HOP"]%}
<div class="menu-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1%; width: 100%;">
    <a href="{{ url_for('user_ownTimetable')}}" style="text-decoration: none;">
        <div class="menu-section">
            <h2>Own Timetable</h2>
            <ul class="submenu">
                <strong>Purpose:</strong>
                <ul>    
                    <li>- View personal timetable</li>
                    <li>- Check scheduled classes and times</li>
                </ul>
            </ul>
        </div>
    </a>

    <a href="{{ url_for('user_invigilationTimetable')}}" style="text-decoration: none;">
        <div class="menu-section">
            <h2>Invigilation Timetable</h2>
            <ul class="submenu">
                <strong>Purpose:</strong>
                <ul>    
                    <li>- View invigilation timetable</li>
                    <li>- Check scheduled duties by date and time</li>
                </ul>
            </ul>
        </div>
    </a>

    <a href="{{ url_for('user_invigilationReport')}}" style="text-decoration: none;">
        <div class="menu-section">
            <h2>Invigilation Report</h2>
            <ul class="submenu">
                <strong>Functionality:</strong>
                <ul>
                    <li>- View invigilation attendance records</li>
                    <li>- Check check-in and check-out times</li>
                </ul>
            </ul>
        </div>
    </a>
</div><br>

<div class="menu-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1%; width: 100%;">
    <a href="{{ url_for('user_mergeTimetable')}}" style="text-decoration: none;">
        <div class="menu-section">
            <h2>Merge Timetable</h2>
            <ul class="submenu">
                <strong>Purpose:</strong>
                <ul>    
                    <li>- View all merged department timetables</li>
                    <li>- Access combined schedules across lecturers and classes</li>
                </ul>
            </ul>
        </div>
    </a>

    <a href="{{ url_for('user_viewStaff') }}" style="text-decoration: none;">
        <div class="menu-section">
            <h2>Merge Timetable</h2>
            <ul class="submenu">
                <strong>Purpose:</strong>
                <ul>    
                    <li>- View all department lecturers</li>
                    <li>- View lecturer details and timetable information</li>
                </ul>
            </ul>
        </div>
    </a>
</div>
{% endif %}

{% if user_level in ["LECTURER", "PO", "LAB_ASS"] %} 
<div class="dashboard-row" style="grid-template-columns: repeat(3, 1fr);">
    <div class="dashboard-frame">
        <h3>Completed Invigilation Hours</h3>
        <p class="dashboard-text" style="color:green;">{{ user_invigilationHour|hours_format }}</p>
    </div>
    <div class="dashboard-frame">
        <h3>Estimated Completed Invigilation Hours</h3>
        <p class="dashboard-text" style="color:blue;">{{ (user_invigilationHour + user_pendingInvigilationHour)|hours_format}}</p>
    </div>
    <div class="dashboard-frame">
        <h3>Pending Invigilation Hours</h3>
        <p class="dashboard-text" style="color:blueviolet;">{{ user_pendingInvigilationHour|hours_format }}</p>
    </div>
</div><br>

{% if waiting %}
<div style="padding: 10px;">
    <h2>Confirm or Decline Invigilation Slot</h2>
    <label>The slots below are automatically generated by the system. Click <b>Accept</b> to confirm the slot or <b>Reject</b> and provide a reason to decline it.</label>
    <div class="user-table-container">
        <table class="user-data-table">
            <thead>
                <tr>
                    <th>Exam Date</th>
                    <th>Exam Day</th>
                    <th>Exam Time</th>
                    <th>Exam Period</th>
                    <th>Course Code/Section - Name</th>
                    <th>Exam Venue</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for w in waiting %}
                <tr>
                    {% set exam = w.session.exams[0].exam if w.session.exams else None %}
                    {% if exam %}
                        <td>{{ exam.examStartTime.strftime("%d/%b/%Y") }} - {{ exam.examEndTime.strftime("%d/%b/%Y") }}</td>
                        <td>{{ exam.examStartTime.strftime("%A") }} - {{ exam.examEndTime.strftime("%A") }}</td>
                        <td>{{ exam.examStartTime.strftime("%H:%M") }} - {{ exam.examEndTime.strftime("%H:%M") }}</td>
                        <td>{{ ((exam.examEndTime - exam.examStartTime).seconds // 3600) }}h {{ ((exam.examEndTime - exam.examStartTime).seconds % 3600) // 60 }}m</td>
                        <td>[{{ exam.course.courseCodeSectionIntake }}] - {{ exam.course.courseName }}</td>
                        <td>{{ w.session.venueNumber }}</td>
                        <td>
                            <form action="{{ url_for('user_homepage') }}" method="POST" style="display:contents;">
                                <input type="hidden" name="w_id" value="{{ w.attendanceId }}">
                                <button type="submit" name="action" value="accept">Accept</button>
                            </form>
                        </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div><br>
{% endif %}

{% if confirm %}
<div style="padding: 10px;">
    <h2>Incoming Invigilation Slot</h2>
    <label>The slots below have been accepted by you.</label>
    <div class="user-table-container">
        <table class="user-data-table">
            <thead>
                <tr>
                    <th>Time Accepted</th>
                    <th>Exam Date</th>
                    <th>Exam Day</th>
                    <th>Exam Time</th>
                    <th>Exam Period</th>
                    <th>Exam Venue</th>
                    <th>Course Name</th>
                    <th>Course Code</th>
                </tr>
            </thead>
            <tbody>
                {% for c in confirm %}
                <tr>
                    {% set exam = c.session.exams[0].exam if c.session.exams else None %}
                    {% if exam %}
                        <td>{{ c.timeAction }}</td>
                        <td>{{ exam.examStartTime.strftime("%d/%b/%Y") }} - {{ exam.examEndTime.strftime("%d/%b/%Y") }}</td>
                        <td>{{ exam.examStartTime.strftime("%A") }} - {{ exam.examEndTime.strftime("%A") }}</td>
                        <td>{{ exam.examStartTime.strftime("%H:%M") }} - {{ exam.examEndTime.strftime("%H:%M") }}</td>
                        <td>{{ ((exam.examEndTime - exam.examStartTime).seconds // 3600) }}h {{ ((exam.examEndTime - exam.examStartTime).seconds % 3600) // 60 }}m</td>
                        <td>{{ c.session.venueNumber }}</td>
                        <td>{{ exam.course.courseName }}</td>
                        <td>{{ exam.course.courseCodeSectionIntake }}</td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div><br>
{% endif %}

{% if open %}
<div style="padding: 10px;">
    <h2>Open Public Self-Selection Invigilation Slot</h2>
    <label>
        The slots below are unselected by other lecturers, have expired, and are now open for public selection and also 
        slots that you previously rejected will also be displayed here. All slots are assigned on a <b>first-come, first-served</b> basis.
    </label>
    <div class="user-table-container">
        <table class="user-data-table">
            <thead>
                <tr>
                    <th>Exam Date</th>
                    <th>Exam Day</th>
                    <th>Exam Time</th>
                    <th>Exam Period</th>
                    <th>Course Name</th>
                    <th>Course Code</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for a in open %}
                <tr>
                    {% set exam = a.session.exams[0].exam if a.session.exams else None %}
                    {% if exam %}
                        <td>{{ exam.examStartTime.strftime("%d/%b/%Y") }} - {{ exam.examEndTime.strftime("%d/%b/%Y") }}</td>
                        <td>{{ exam.examStartTime.strftime("%A") }} - {{ exam.examEndTime.strftime("%A") }}</td>
                        <td>{{ exam.examStartTime.strftime("%H:%M") }} - {{ exam.examEndTime.strftime("%H:%M") }}</td>
                        <td>{{ ((exam.examEndTime - exam.examStartTime).seconds // 3600) }}h {{ ((exam.examEndTime - exam.examStartTime).seconds % 3600) // 60 }}m</td>
                        <td>{{ exam.course.courseName }}</td>
                        <td>{{ exam.course.courseCodeSectionIntake }}</td>
                        <td>
                            <form action="{{ url_for('user_homepage') }}" method="POST" style="display: contents;">
                                <input type="hidden" name="a_id" value="{{ a.attendanceId }}">
                                <button type="submit" name="action" value="open_accept">Accept</button>
                            </form>
                        </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

{% if reject %}
<div style="padding: 10px;">
    <h2>Rejected Invigilation Slot</h2>
    <label>The slots below show all invigilation slots you have rejected, including the reason and the date and time of rejection.</label>
    <div class="user-table-container">
        <table class="user-data-table">
            <thead>
                <tr>
                    <th>Time Rejected</th>
                    <th>Reason</th>
                    <th>Exam Date</th>
                    <th>Exam Day</th>
                    <th>Exam Time</th>
                    <th>Exam Period</th>
                    <th>Course Name</th>
                    <th>Course Code</th>
                </tr>
            </thead>
            <tbody>
                {% for r in reject %}
                <tr>
                    {% set exam = r.session.exams[0].exam if r.session.exams else None %}
                    {% if exam %}
                        <td>{{ r.timeAction }}</td>
                        <td><strong>{{ r.rejectReason }}</strong></td>
                        <td>{{ exam.examStartTime.strftime("%d/%b/%Y") }} - {{ exam.examEndTime.strftime("%d/%b/%Y") }}</td>
                        <td>{{ exam.examStartTime.strftime("%A") }} - {{ exam.examEndTime.strftime("%A") }}</td>
                        <td>{{ exam.examStartTime.strftime("%H:%M") }} - {{ exam.examEndTime.strftime("%H:%M") }}</td>
                        <td>{{ ((exam.examEndTime - exam.examStartTime).seconds // 3600) }}h {{ ((exam.examEndTime - exam.examStartTime).seconds % 3600) // 60 }}m</td>
                        <td>{{ exam.course.courseName }}</td>
                        <td>{{ exam.course.courseCodeSectionIntake }}</td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}
{% endif %}
{% if user_level in ["LECTURER", "PO", "LAB_ASS"] and not waiting and not confirm and not open and not reject %}
    <h2>No Invigilation Slot</h2>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<!-- Reject Reason Popup Modal -->
<div id="rejectModal" class="modal" style="
    display:none;
    position: fixed;
    z-index: 1000;
    left: 0; top: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
">
    <div style="
        background:white;
        padding: 20px;
        width: 350px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    ">
        <h3>Reject Slot</h3>

        <form id="rejectModalForm" method="POST" action="{{ url_for('user_homepage') }}">
            <input type="hidden" name="w_id" id="reject_wid">
            <textarea name="reject_reason" placeholder="Enter rejection reason" required
                style="width:100%; height:100px; margin-top:10px;"></textarea>

            <div style="margin-top:15px; text-align:right;">
                <button type="button" onclick="closeRejectModal()"
                    style="padding:5px 12px; margin-right:10px;">Cancel</button>
                <button type="submit" name="action" value="reject"
                    style="padding:5px 12px; background:#e74c3c; color:white;">Submit</button>
            </div>
        </form>
    </div>
</div>

<script>
function openRejectModal(id) {
    document.getElementById('reject_wid').value = id;
    document.getElementById('rejectModal').style.display = 'flex';
}

function closeRejectModal() {
    document.getElementById('rejectModal').style.display = 'none';
}

document.querySelectorAll('.reject-btn').forEach(btn => {
    btn.addEventListener('click', function () {
        openRejectModal(this.dataset.id);
    });
});
</script>
{% endblock %}

{% extends "user/userBase.html" %}
{% block title %}InvigilationReport{% endblock %}
{% block head_title %}<h2>Invigilation Report</h2>{% endblock %}
{% block content %}
<div class="menu-section">
    <div style="display: flex; align-items: center; gap: 10px;">
        <div style="position: relative;">
            <input type="text" id="searchInput" name="search_report" placeholder="Search..." value="{{ search_report }}" style="border-radius: 6px; width: 100%;">
            <i class="fa fa-search" id="searchBtn" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer;"></i>
        </div>
        <div class="button-wrapper" style="margin-bottom: auto;">
            <button id="generatePDF" style="background-color: black;">Download as PDF</button>
        </div>
    </div>
    <div id="noResults" style="display: none; text-align: center; margin-top: 10px; font-weight: bold; color: #b00;">No results found.</div>

    <div class="dashboard-row">
        <div class="dashboard-frame">
            <h3>Pending Invigilation Duties</h3>
            <p class="dashboard-text" style="color:green;">{{ user_total_activeReport }}</p>
        </div>
        <div class="dashboard-frame">
            <h3>Completed Invigilation Duties</h3>
            <p class="dashboard-text" style="color:green;">{{ total_report - user_total_activeReport }}</p>
        </div>
        <div class="dashboard-frame">
            <h3>Checked In Late</h3>
            <p class="dashboard-text" style="color:red;">{{ total_checkInLate }}</p>
        </div>
        <div class="dashboard-frame">
            <h3>Checked Out Early</h3>
            <p class="dashboard-text" style="color:red;">{{ total_checkOutEarly }}</p>
        </div>
    </div>

    <div class="user-table-container">
        <table class="user-data-table" id="viewInvigilationReport">
            <thead>
                <tr>
                    <th>Exam Venue</th>
                    <th>Exam Date</th>
                    <th>Exam CourseCode</th>
                    <th>Invigilator Details</th>
                    <th>Invigilation Status</th>
                    <th>Attendance Status</th>
                    <th>Check-in/out</th>
                </tr>
            </thead>
            <tbody>
                {% for (venue, start, end), data in grouped_att.items() %}
                    {% if current_user.userRole in ["LECTURER", "PO", "LAB_ASST"] %}
                        {% set invigilators_to_show = data.invigilators | selectattr("invigilator.userId", "equalto", current_user.userId) | list %}
                    {% else %}
                        {% set invigilators_to_show = data.invigilators %}
                    {% endif %}

                    {% set num_invigilators = invigilators_to_show | length %}
                    {% for att in invigilators_to_show %}
                        <tr>
                            {% if loop.first %}
                                <td rowspan="{{ num_invigilators }}">[{{ venue }}]</td>
                                <td rowspan="{{ num_invigilators }}">{{ start.strftime("%d/%b/%Y %H:%M") }} - {{ end.strftime("%d/%b/%Y %H:%M") }}</td>
                                <td rowspan="{{ num_invigilators }}">
                                    {% for c in data.courses %}
                                        <div><strong>{{ c.code }}</strong> - {{ c.name }}</div>
                                    {% endfor %}
                                </td>
                            {% endif %}

                            <td>
                                <div class="info-grid">
                                    <div>Postion</div><div><strong class="checkin-text">: {{ att.position }}</strong></div>
                                    <div>Staff Id</div><div><strong class="checkout-text">: {{ att.invigilator.userId }}</strong></div>
                                    <div>Staff Name</div><div><strong class="checkout-text">: {{ att.invigilator.userName }}</strong></div>
                                </div>
                            </td>
                            <td>
                                {% if att.invigilationStatus %}
                                    <span class="status frame-completed invigilation-status">ACCEPTED</span>
                                {% elif not att.invigilationStatus and att.rejectReason %}
                                    <span class="status frame-expired invigilation-status">REJECTED</span>
                                    <div style="max-width: 200px;"><strong>Reason: </strong>{{ att.rejectReason }}</div>
                                {% else %}
                                    <span class="status frame-pending invigilation-status">PENDING</span>
                                {% endif %} 
                            </td>
                            <td>
                                {% set remark_classes = {
                                    "PENDING": "frame-pending",
                                    "CHECK IN": "frame-completed",
                                    "COMPLETED": "frame-completed",
                                    "CHECK IN LATE": "frame-expired",
                                    "CHECK OUT EARLY": "frame-expired",
                                    "EXPIRED": "frame-expired"
                                } %}
                                <span class="status {{ remark_classes.get(att.remark, '') }} attendance-remark">{{ att.remark }}</span>
                            </td>
                            <td>
                                <div class="info-grid">
                                    <div>CheckIn</div><div><strong class="checkin-text">: {{ att.checkIn.strftime("%d/%b/%Y %H:%M:%S") if att.checkIn else "None" }}</strong></div>
                                    <div>CheckOut</div><div><strong class="checkout-text">: {{ att.checkOut.strftime("%d/%b/%Y %H:%M:%S") if att.checkOut else "None" }}</strong></div>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
const userRole = {{ user_role | tojson }};
const userName = {{ user_name | tojson }};  
const userDepartment = {{ user_department | tojson }};

document.getElementById("generatePDF").addEventListener("click", function () {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: "landscape", unit: "pt", format: "a4" });
    const margin = 20;
    const pageWidth = doc.internal.pageSize.getWidth();
    const userRole = Number("{{ current_user.userRole }}");
    const userName = "{{ current_user.userName }}";
    const userDepartment = "{{ current_user.userDepartment }}";
    const nowMY = new Date().toLocaleString("en-GB", {timeZone: "Asia/Kuala_Lumpur", day: "2-digit", month: "short", year: "numeric", hour: "2-digit", minute: "2-digit", hour12: true});

    doc.setFont("helvetica", "bold");
    doc.setFontSize(18);

    if (userRole === 1) {
        doc.text(`${userName}'s Invigilation Report`, pageWidth/2, margin, {align: "center"});
    } else {
        doc.text(`${userDepartment} Invigilation Report`, pageWidth/2, margin, {align: "center"});
    }

    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);
    doc.text(`Downloaded on: ${nowMY}`, pageWidth / 2, margin + 18, { align: "center" });

    const startY = margin + 30;
    const headers = ["No", "Exam Date & Time", "Venue", "Exam Course", "Invigilator Details", "Invigilation Status", "Attendance Status", "Check-in/out Time"];
    const rows = [];
    document.querySelectorAll("#viewInvigilationReport tbody tr").forEach((tr) => {
        const tds = tr.querySelectorAll("td");
        if (tds.length === 0) return;
        let row = [];

        function getInvigilatorText(td) {
            const lines = [];
            td.querySelectorAll("div.info-grid div").forEach((div, i) => {
                if (i % 2 === 0) {
                    lines.push(div.innerText.trim() + " ");
                } else {
                    lines[lines.length - 1] += div.innerText.trim();
                }
            });
            return lines.join("\n");
        }

        const firstCellText = tds[0].innerText.trim();
        const isNewExamRow = !isNaN(firstCellText);
        let lastExamNo = "";
        let lastExamDetails = "";
        let lastVenue = "";
        let lastCourse = "";

        if (isNewExamRow) {
            // First row of exam group
            lastExamNo = tds[0].innerText.trim();
            lastExamDetails = tds[1].innerText.trim();
            lastVenue = tds[2].innerText.trim();
            lastCourse = tds[3].innerText.trim();

            row.push(
                lastExamNo, lastExamDetails, lastVenue, lastCourse,
                getInvigilatorText(tds[4]),
                tds[5].innerText.trim(),
                tds[6].innerText.trim(),
                tds[7].innerText.trim()
            );
        } else {
            // Continuation row (rowspan row)
            row.push(
                lastExamNo, lastExamDetails, lastVenue, lastCourse,
                getInvigilatorText(tds[0]),
                tds[1].innerText.trim(),
                tds[2].innerText.trim(),
                tds[3].innerText.trim()
            );
        }
        rows.push(row);
    });

    doc.autoTable({
        head: [headers],
        body: rows,
        startY: startY,
        theme: "grid",
        styles: {font: "helvetica", fontSize: 8, cellPadding: 4, overflow: "linebreak", valign: "top"},
        headStyles: {fillColor: [33, 37, 41], textColor: 255, fontStyle: "bold"},
        margin: { top: margin, left: margin, right: margin, bottom: margin },
        didDrawPage: function () {
            const pageHeight = doc.internal.pageSize.height;
            const pageCount = doc.internal.getNumberOfPages();
            doc.setFontSize(9);
            doc.setTextColor(100);
            doc.text(`Page ${pageCount}`, pageWidth - margin, pageHeight - 10, {align: "right"});
        }
    });
    if (["LECTURER", "PO", "LAB_ASST"].includes(userRole)) {
        doc.save(`${userName}'s_Invigilation_Report.pdf`);
    } else {
        doc.save(`${userDepartment}_Invigilation_Report.pdf`);
    }
});

document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("searchInput");
    const noResults = document.getElementById("noResults");
    const tableRows = document.querySelectorAll("#viewInvigilationReport tbody tr");

    searchInput.addEventListener("input", function () {
        const filter = this.value.toLowerCase().trim();
        let foundAny = false;

        tableRows.forEach(row => {
            const text = row.innerText.toLowerCase();
            if (!filter || text.includes(filter)) {
                row.style.display = ""; // show row
                foundAny = true;
            } else {
                row.style.display = "none"; // hide row
            }
        });

        noResults.style.display = foundAny ? "none" : "block";
    });
});
</script>
{% endblock %}


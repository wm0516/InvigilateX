{% extends "user/userBase.html" %}
{% block title %}InvigilationReport{% endblock %}
{% block head_title %}<h2>Invigilation Report</h2>{% endblock %}

{% block content %}
<div class="menu-section">
    <div style="display: flex; align-items: center; gap: 10px;">
        <div style="position: relative;">
            <input type="text" id="searchInput" name="search_report" placeholder="Search..." value="{{ search_report }}" style="border-radius: 6px; width: 100%;">
            <i class="fa fa-search" id="searchBtn" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer;"></i>
        </div>
        <div class="button-wrapper" style="margin-bottom: auto;">
            <button id="generatePDF" style="background-color: black;">Download as PDF</button>
        </div>
    </div>
    <div id="noResults" style="display: none; text-align: center; margin-top: 10px; font-weight: bold; color: #b00;">No results found.</div>

    <div class="dashboard-row">
        <div class="dashboard-frame">
            <h3>Pending Invigilation Duties</h3>
            <p class="dashboard-text">{{ total_activeReport }}</p>
        </div>
        <div class="dashboard-frame">
            <h3>Completed Invigilation Duties</h3>
            <p class="dashboard-text">{{ total_report - total_activeReport }}</p>
        </div>
        <div class="dashboard-frame">
            <h3>Checked In Late</h3>
            <p class="dashboard-text" style="color:red;">{{ total_checkInLate }}</p>
        </div>
        <div class="dashboard-frame">
            <h3>Checked Out Early</h3>
            <p class="dashboard-text" style="color:red;">{{ total_checkOutEarly }}</p>
        </div>
    </div>

    <div class="invigilation-container">
        {% for (status, start_time), grouped in attendances|groupby("group_key") %}
        <div class="invigilation-frame" data-exam="{{ grouped[0].report.exam.examId }}">
            <!-- Exam Details -->
            <div class="exam-details">
                <div><strong>Exam ID:</strong> [{{ grouped[0].report.exam.examId }}]</div>
                <div><strong>Course Name:</strong> {{ grouped[0].report.exam.course.courseName }}</div>
                <div><strong>Course Code/Section:</strong> {{ grouped[0].report.exam.course.courseCodeSectionIntake }}</div>
                <div><strong>Number of Students:</strong> {{ grouped[0].report.exam.course.courseStudent }}</div>
                <div><strong>Program Code:</strong> {{ grouped[0].report.exam.course.courseDepartment }}</div>
                <div><strong>Exam Date:</strong> {{ grouped[0].report.exam.examStartTime.strftime("%d/%b/%Y") }} - {{ grouped[0].report.exam.examEndTime.strftime("%d/%b/%Y") }}</div>
                <div><strong>Exam Day:</strong> {{ grouped[0].report.exam.examStartTime.strftime("%A") }} - {{ grouped[0].report.exam.examEndTime.strftime("%A") }}</div>
                <div><strong>Exam Time:</strong> {{ grouped[0].report.exam.examStartTime.strftime("%H:%M") }} - {{ grouped[0].report.exam.examEndTime.strftime("%H:%M") }}</div>
                <div><strong>Exam Period:</strong> {{ (grouped[0].report.exam.examEndTime - grouped[0].report.exam.examStartTime).seconds // 3600 }}h {{ ((grouped[0].report.exam.examEndTime - grouped[0].report.exam.examStartTime).seconds % 3600) // 60 }}m</div>
                <div><strong>Exam Venue(s):</strong><br>
                    {% if grouped[0].report.exam.venue_availabilities %}
                        {% for va in grouped[0].report.exam.venue_availabilities %}
                            {{ va.venueNumber }} (Capacity: {{ va.capacity }})<br>
                        {% endfor %}
                    {% else %}
                        None
                    {% endif %}
                </div>
            </div>

            <!-- Invigilators -->
            <div class="invigilators-details">
                {% for att in grouped %}
                <div class="invigilator-card {% if not att.report.exam.examStatus %}inactive-row-show{% elif att.report.exam.examStartTime is none %}error-row-show{% endif %}">
                    <div><strong>ID:</strong> {{ att.invigilator.userId }}</div>
                    <div><strong>Name:</strong> {{ att.invigilator.userName }}</div>
                    <div><strong>Contact:</strong> {{ att.invigilator.userContact }}</div>
                    <div><strong>Gender:</strong> {{ att.invigilator.userGender }}</div>
                    <div><strong>Check-in:</strong> {{ att.checkIn.strftime("%d/%b/%Y %H:%M:%S") if att.checkIn else "None" }}</div>
                    <div><strong>Check-out:</strong> {{ att.checkOut.strftime("%d/%b/%Y %H:%M:%S") if att.checkOut else "None" }}</div>
                    {% if att.checkIn and att.checkOut %}
                        {% set exam_start = att.report.exam.examStartTime %}
                        {% set exam_end = att.report.exam.examEndTime %}
                        {% set check_in = att.checkIn %}
                        {% set check_out = att.checkOut %}
                        {% set actual_start = [check_in, exam_start] | max %}
                        {% set actual_end = [check_out, exam_end] | min %}
                        {% set total_seconds = (actual_end - actual_start).total_seconds() %}
                        {% if total_seconds < 0 %}{% set total_seconds = 0 %}{% endif %}
                        <div style="color: green;">Total Invigilation Time: {{ (total_seconds / 3600) | round(2) }} hours </div>
                    {% endif %}
                    <div><strong>Attendance Status:</strong>
                        {% set remark_classes = {
                            "PENDING": "frame-pending",
                            "CHECK IN": "frame-completed",
                            "CHECK OUT": "frame-completed",
                            "COMPLETED": "frame-completed",
                            "CHECK IN LATE": "frame-expired",
                            "CHECK OUT EARLY": "frame-expired",
                            "EXPIRED": "frame-expired"
                        } %}
                        <span class="status {{ remark_classes.get(att.remark, '') }}">{{ att.remark }}</span>
                    </div>
                    <div><strong>Invigilation Status:</strong>
                        {% if att.invigilationStatus %}
                            <span class="status frame-completed">ACCEPTED</span>
                        {% else %}
                            <em class="status frame-pending">PENDING</em>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.getElementById("generatePDF").addEventListener("click", function () {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: "landscape", unit: "pt", format: "a4" });
    const margin = 20;
    const pageWidth = doc.internal.pageSize.getWidth();

    doc.setFont("helvetica", "bold");
    doc.setFontSize(18);
    doc.text("Lecturer Invigilation Report", pageWidth / 2, margin, { align: "center" });

    const startY = margin + 30;
    const headers = ["Exam ID", "Exam Details", "Invigilator Details", "Check-in/out Time", "Attendance Status", "Invigilation Status"];
    const rows = [];

    document.querySelectorAll(".invigilation-frame").forEach(frame => {
        const examText = Array.from(frame.querySelector(".exam-details").children).map(c => c.innerText).join("\n");
        frame.querySelectorAll(".invigilator-card").forEach(card => {
            const invText = Array.from(card.children).map(c => c.innerText).join("\n");
            rows.push([frame.dataset.exam, examText, invText, "", "", ""]);
        });
    });

    doc.autoTable({
        head: [headers],
        body: rows,
        startY: startY,
        theme: "grid",
        styles: {font: "helvetica", fontSize: 8, cellPadding: 4, overflow: "linebreak", valign: "top", halign: "left"},
        headStyles: {fillColor: [33, 37, 41], textColor: 255, fontStyle: "bold"},
        tableWidth: "auto",
        margin: { top: margin, left: margin, right: margin, bottom: margin },
        didDrawPage: function (data) {
            const pageCount = doc.internal.getNumberOfPages();
            const pageHeight = doc.internal.pageSize.height;
            doc.setFontSize(9);
            doc.setTextColor(100);
            doc.text(`Page ${pageCount}`, pageWidth - margin, pageHeight - 10, { align: "right" });
        }
    });

    doc.save("Invigilation_Report.pdf");
});
</script>

<style>
.invigilation-container { display: flex; flex-direction: column; gap: 15px; }
.invigilation-frame { display: flex; border: 1px solid #ccc; padding: 10px; gap: 20px; flex-wrap: wrap; }
.exam-details { flex: 0 0 30%; border-right: 1px solid #ddd; padding-right: 10px; }
.invigilators-details { flex: 1; display: flex; flex-direction: column; gap: 10px; }
.invigilator-card { border: 1px solid #aaa; padding: 5px 10px; border-radius: 4px; }
</style>
{% endblock %}

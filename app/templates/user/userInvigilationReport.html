{% extends "user/userBase.html" %}
{% block title %}InvigilationReport{% endblock %}
{% block head_title %}<h2>Invigilation Report</h2>{% endblock %}
{% block content %}
<div class="menu-section">
    <div style="display: flex; align-items: center; gap: 10px;">
        <div style="position: relative;">
            <input type="text" id="searchInput" name="search_report" placeholder="Search..." value="{{ search_report }}" style="border-radius: 6px; width: 100%;">
            <i class="fa fa-search" id="searchBtn" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer;"></i>
        </div>
        <div class="button-wrapper" style="margin-bottom: auto;">
            <button id="generatePDF" style="background-color: black;">Download as PDF</button>
        </div>
    </div>
    <div id="noResults" style="display: none; text-align: center; margin-top: 10px; font-weight: bold; color: #b00;">No results found.</div>

    <div class="dashboard-row">
        <div class="dashboard-frame">
            <h3>Pending Invigilation Duties</h3>
            <p class="dashboard-text">{{ total_activeReport }}</p>
        </div>
        <div class="dashboard-frame">
            <h3>Completed Invigilation Duties</h3>
            <p class="dashboard-text">{{ total_report - total_activeReport }}</p>
        </div>
        <div class="dashboard-frame">
            <h3>Checked In Late</h3>
            <p class="dashboard-text" style="color:red;">{{ total_checkInLate }}</p>
        </div>
        <div class="dashboard-frame">
            <h3>Checked Out Early</h3>
            <p class="dashboard-text" style="color:red;">{{ total_checkOutEarly }}</p>
        </div>
    </div>

    <div class="user-table-container">
        <table class="user-data-table" id="viewInvigilationReport">
            <thead>
                <tr>
                    <th>Exam ID</th>
                    <th>Exam Details</th>
                    <th>Invigilator Details</th>
                    <th>Check-in/out Time</th>
                    <th>Attendance Status</th>
                    <th>Invigilation Status</th>
                </tr>
            </thead>

            {% for (status, start_time), grouped in attendances|groupby("group_key") %}
            <tbody data-exam="{{ grouped[0].report.exam.examId }}">
                {% set inv_count = grouped|length %}
                {% set expected_count = grouped[0].report.exam.examNoInvigilator %}
                {% set total_rows = expected_count %}

                {% for i in range(total_rows) %}
                    {% set att = grouped[i] if i < inv_count else None %}
                    <tr data-exam="{{ grouped[0].report.exam.examId }}" 
                    class="{% if att and not att.report.exam.examStatus %}inactive-row-show{% elif att and att.report.exam.examStartTime is none %}error-row-show{% endif %}">
                        
                        {% if i == 0 %}
                            <!-- Exam ID -->
                            <td rowspan="{{ total_rows }}" style="text-align:center;">[{{ grouped[0].report.exam.examId }}]</td>
                            
                            <!-- Exam Details -->
                            <td rowspan="{{ total_rows }}">
                                <div class="info-grid">
                                    <div>Course Name</div><div><strong>: {{ grouped[0].report.exam.course.courseName }}</strong></div>
                                    <div>Course Code/Section</div><div><strong>: {{ grouped[0].report.exam.course.courseCodeSectionIntake }}</strong></div>
                                    <div>Number of Students</div><div><strong>: {{ grouped[0].report.exam.course.courseStudent }}</strong></div>
                                    <div>Program Code</div><div><strong>: {{ grouped[0].report.exam.course.courseDepartment }}</strong></div>
                                    <div>Exam Date</div><div><strong>: {{ grouped[0].report.exam.examStartTime.strftime("%d/%b/%Y") }} - {{ grouped[0].report.exam.examEndTime.strftime("%d/%b/%Y") }}</strong></div>
                                    <div>Exam Day</div><div><strong>: {{ grouped[0].report.exam.examStartTime.strftime("%A") }} - {{ grouped[0].report.exam.examEndTime.strftime("%A") }}</strong></div>
                                    <div>Exam Time</div><div><strong>: {{ grouped[0].report.exam.examStartTime.strftime("%H:%M") }} - {{ grouped[0].report.exam.examEndTime.strftime("%H:%M") }}</strong></div>
                                    <div>Exam Period</div><div><strong>: {{ (grouped[0].report.exam.examEndTime - grouped[0].report.exam.examStartTime).seconds // 3600 }}h {{ ((grouped[0].report.exam.examEndTime - grouped[0].report.exam.examStartTime).seconds % 3600) // 60 }}m</strong></div>
                                    <div>Exam Venue(s)</div>
                                    <div>
                                        {% if grouped[0].report.exam.venue_availabilities %}
                                            {% for va in grouped[0].report.exam.venue_availabilities %}
                                                <strong>: {{ va.venueNumber }} (Capacity Use: {{ va.capacity }})</strong><br>
                                            {% endfor %}
                                        {% else %}
                                            <strong>: None</strong>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                        {% endif %}

                        <!-- Invigilator Details -->
                        <td>
                            {% if att %}
                                <div class="info-grid">
                                    <div>ID</div><div><strong>: {{ att.invigilator.userId }}</strong></div>
                                    <div>Name</div><div><strong>: {{ att.invigilator.userName }}</strong></div>
                                    <div>Contact</div><div><strong>: {{ att.invigilator.userContact }}</strong></div>
                                    <div>Gender</div><div><strong>: {{ att.invigilator.userGender }}</strong></div>
                                </div>
                            {% else %}
                                <em class="status frame-pending">IN PROCESSING</em>
                            {% endif %}
                        </td>

                        <!-- Check-in/out Time -->
                        <td>
                            {% if att %}
                                <div class="info-grid">
                                    <div>Check-in Time</div><div><strong>: {{ att.checkIn.strftime("%d/%b/%Y %H:%M:%S") if att.checkIn else "None" }}</strong></div>
                                    <div>Check-out Time</div><div><strong>: {{ att.checkOut.strftime("%d/%b/%Y %H:%M:%S") if att.checkOut else "None" }}</strong></div>
                                </div>
                                {% if att.checkIn and att.checkOut %}
                                    {% set exam_start = att.report.exam.examStartTime %}
                                    {% set exam_end = att.report.exam.examEndTime %}
                                    {% set check_in = att.checkIn %}
                                    {% set check_out = att.checkOut %}
                                    {% set actual_start = [check_in, exam_start] | max %}
                                    {% set actual_end = [check_out, exam_end] | min %}
                                    {% set total_seconds = (actual_end - actual_start).total_seconds() %}
                                    {% if total_seconds < 0 %}{% set total_seconds = 0 %}{% endif %}
                                    <div style="color: green;">Total Invigilation Time: {{ (total_seconds / 3600) | round(2) }} hours </div>
                                {% endif %}
                            {% else %}
                                <em class="status frame-pending">IN PROCESSING</em>
                            {% endif %}
                        </td>

                        <!-- Attendance Status -->
                        <td>
                            {% if att %}
                                {% set remark_classes = {
                                    "PENDING": "frame-pending",
                                    "CHECK IN": "frame-completed",
                                    "CHECK OUT": "frame-completed",
                                    "COMPLETED": "frame-completed",
                                    "CHECK IN LATE": "frame-expired",
                                    "CHECK OUT EARLY": "frame-expired",
                                    "EXPIRED": "frame-expired"
                                } %}
                                <span class="status {{ remark_classes.get(att.remark, '') }}">{{ att.remark }}</span>
                            {% else %}
                                <em class="status frame-pending">IN PROCESSING</em>
                            {% endif %}
                        </td>

                        <!-- Invigilation Status -->
                        <td>
                            {% if att and att.invigilationStatus %}
                                <span class="status frame-completed">ACCEPTED</span>
                            {% else %}
                                <em class="status frame-pending">PENDING</em>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
            {% endfor %}
        </table>
    </div>
</div>
{% endblock %}

<script>
document.addEventListener("DOMContentLoaded", function () {

    const searchInput = document.getElementById("searchInput");
    const noResults = document.getElementById("noResults");
    const allGroups = document.querySelectorAll("#viewInvigilationReport tbody");

    // -----------------------------
    // 🔍 Filter by Invigilator or Any Text
    // -----------------------------
    searchInput.addEventListener("input", function () {
        const filter = this.value.toLowerCase().trim();
        let foundAny = false;

        allGroups.forEach(tbody => {
            const rows = tbody.querySelectorAll("tr");
            let visibleRowCount = 0;

            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                if (filter === "" || text.includes(filter)) {
                    row.style.display = "";
                    visibleRowCount++;
                } else {
                    row.style.display = "none";
                }
            });

            // Hide entire exam group if no row matched
            tbody.style.display = visibleRowCount > 0 ? "" : "none";
            if (visibleRowCount > 0) foundAny = true;
        });

        noResults.style.display = foundAny ? "none" : "block";
    });

    // -----------------------------
    // 📄 Generate PDF
    // -----------------------------
    document.getElementById("generatePDF").addEventListener("click", function () {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: "landscape", unit: "pt", format: "a4" });
        const margin = 20;
        const pageWidth = doc.internal.pageSize.getWidth();

        doc.setFont("helvetica", "bold");
        doc.setFontSize(18);
        doc.text("Lecturer Invigilation Report", pageWidth / 2, margin, { align: "center" });

        const startY = margin + 30;
        const headers = ["Exam ID", "Exam Details", "Invigilator Details", "Check-in/out Time", "Attendance Status", "Invigilation Status"];
        const rows = [];

        let lastExamID = "", lastExamDetails = "";

        // Use visible rows only
        document.querySelectorAll("#viewInvigilationReport tbody tr").forEach(tr => {
            if (tr.style.display === "none") return; // skip hidden rows

            const tds = tr.querySelectorAll("td");
            let examID = "", examDetails = "", invDetails = "", checkTimes = "", attendance = "", invStatus = "";

            if (tds.length === 6) {
                examID = tds[0].innerText.trim();
                examDetails = tds[1].innerText.trim();
                invDetails = tds[2].innerText.trim();
                checkTimes = tds[3].innerText.trim();
                attendance = tds[4].innerText.trim();
                invStatus = tds[5].innerText.trim();
            } else {
                invDetails = tds[0]?.innerText.trim() || "";
                checkTimes = tds[1]?.innerText.trim() || "";
                attendance = tds[2]?.innerText.trim() || "";
                invStatus = tds[3]?.innerText.trim() || "";
            }

            [examDetails, invDetails, checkTimes] = [examDetails, invDetails, checkTimes].map(text =>
                text.replace(/\s*:\s*/g, " : ")
            );

            rows.push([examID, examDetails, invDetails, checkTimes, attendance, invStatus]);
        });

        doc.autoTable({
            head: [headers],
            body: rows,
            startY: startY,
            theme: "grid",
            styles: { font: "helvetica", fontSize: 8, cellPadding: 4, overflow: "linebreak", valign: "top", halign: "left" },
            headStyles: { fillColor: [33, 37, 41], textColor: 255, fontStyle: "bold" },
            tableWidth: "auto",
            margin: { top: margin, left: margin, right: margin, bottom: margin },
            didDrawPage: function (data) {
                const pageCount = doc.internal.getNumberOfPages();
                const pageHeight = doc.internal.pageSize.height;
                doc.setFontSize(9);
                doc.setTextColor(100);
                doc.text(`Page ${pageCount}`, pageWidth - margin, pageHeight - 10, { align: "right" });
            }
        });

        doc.save("Invigilation_Report.pdf");
    });
});
</script>



{% extends "user/userBase.html" %}
{% block title %}InvigilationReport{% endblock %}
{% block head_title %}<h2>Invigilation Report</h2>{% endblock %}
{% block content %}
<div class="menu-section">
    <div class="dashboard-row">
        <div class="dashboard-frame">
            <h3>Pending Invigilation Duties</h3>
            <p class="dashboard-text">{{ total_activeReport }}</p>
        </div>
        <div class="dashboard-frame">
            <h3>Completed Invigilation Duties</h3>
            <p class="dashboard-text">{{ total_report - total_activeReport }}</p>
        </div>
        <div class="dashboard-frame">
            <h3>Checked In Late</h3>
            <p class="dashboard-text" style="color:red;">{{ total_checkInLate }}</p>
        </div>
        <div class="dashboard-frame">
            <h3>Checked Out Early</h3>
            <p class="dashboard-text" style="color:red;">{{ total_checkOutEarly }}</p>
        </div>
    </div>

    <div class="user-table-container">
        <table class="user-data-table">
            <thead>
                <tr>
                    <th>Exam ID</th>
                    <th>Exam Details</th>
                    <th>Invigilator Details</th>
                    <th>Check-in/out Time</th>
                    <th>Attendance Status</th>
                    <th>Invigilation Status</th>
                </tr>
            </thead>
            <tbody>
                {% for (status, start_time), grouped in attendances|groupby("group_key") %}
                    {% set rowspan = grouped|length %}
                    {% for att in grouped %}
                        <tr class="
                            {% if not att.report.exam.examStatus %}
                                inactive-row-show
                            {% elif att.report.exam.examVenue is none %}
                                error-row-show
                            {% endif %}
                        "> 
                            {% if loop.first %}
                            <!-- Exam ID -->
                            <td rowspan="{{ rowspan }}" style="text-align:center;">[{{ att.report.exam.examId }}]</td>

                            <!-- Course & Exam Details -->
                            <td rowspan="{{ rowspan }}">
                                <div class="info-grid">
                                    <div>Course Name</div><div><strong>: {{ att.report.exam.course.courseName }}</strong></div>
                                    <div>Course Code/Section</div><div><strong>: {{ att.report.exam.course.courseCodeSectionIntake }}</strong></div>
                                    <div>Number of Students</div><div><strong>: {{ att.report.exam.course.courseStudent }}</strong></div>
                                    <div>Program Code</div><div><strong>: {{ att.report.exam.course.courseDepartment }}</strong></div>
                                    <div>Exam Date</div><div><strong>: {{ att.report.exam.examStartTime.strftime("%d/%b/%Y") }} - {{ att.report.exam.examEndTime.strftime("%d/%b/%Y") }}</strong></div>
                                    <div>Exam Day</div><div><strong>: {{ att.report.exam.examStartTime.strftime("%A") }} - {{ att.report.exam.examEndTime.strftime("%A") }}</strong></div>
                                    <div>Exam Time</div><div><strong>: {{ att.report.exam.examStartTime.strftime("%H:%M") }} - {{ att.report.exam.examEndTime.strftime("%H:%M") }}</strong></div>
                                    <div>Exam Period</div><div><strong>: {{ (att.report.exam.examEndTime - att.report.exam.examStartTime).seconds // 3600 }}h {{ ((att.report.exam.examEndTime - att.report.exam.examStartTime).seconds % 3600) // 60 }}m</strong></div>
                                    <div>Exam Venue</div><div><strong>: {{ att.report.exam.examVenue }}</strong></div>
                                </div>
                            </td>
                            {% endif %}

                            <!-- Invigilator Details (one per row) -->
                            <td style="border-left: 1px solid #aaa;">
                                <div class="info-grid">
                                    <div>ID</div><div><strong>: {{ att.invigilator.userId }}</strong></div>
                                    <div>Name</div><div><strong>: {{ att.invigilator.userName }}</strong></div>
                                    <div>Contact</div><div><strong>: {{ att.invigilator.userContact }}</strong></div>
                                    <div>Gender</div><div><strong>: {{ att.invigilator.userGender }}</strong></div>
                                </div>
                            </td>

                            <!-- Check-in/out Time -->
                            <td>
                                <div class="info-grid">
                                    <div>Check-in Time</div><div><strong>: {{ att.checkIn }}</strong></div> 
                                    <div>Check-out Time</div><div><strong>: {{ att.checkOut }}</strong></div>
                                    <div style="color: #00b300"><strong>Total Invigilation Hour</div><div>: {{ att.checkIn }}</strong></div>
                                </div>
                            </td>

                            <!-- Attendance Status -->
                            <td>
                                {% set remark_classes = {
                                    "PENDING": "frame-pending",
                                    "CHECK IN": "frame-complete",
                                    "CHECK OUT": "frame-complete",
                                    "COMPLETED": "frame-complete",
                                    "CHECK IN LATE": "frame-expired",
                                    "CHECK OUT EARLY": "frame-expired",
                                    "EXPIRED": "frame-expired"
                                } %}
                                <span class="status {{ remark_classes.get(att.remark, '') }}">[{{ att.remark }}]</span>
                            </td>
                            <td>
                                {% if att.invigilationStatus == 1 %}
                                    <span class="status frame-complete">[ACCEPTED]</span>
                                {% else %}
                                    <span class="status frame-expired">[PENDING]</span>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                {% endfor %}
            </tbody>    
        </table>
    </div>
</div>

{% endblock %}

{% extends "user/userBase.html" %}
{% block title %}Timetable{% endblock %}
{% block head_title %}<h2>Own Timetable</h2>{% endblock %}
{% block content %}
<div class="menu-section">
    <div class="user-table-container" style="max-height: None;">    
        <table class="user-data-table" border="1">
            <thead>
                <tr>
                    <th>Day / Time</th>
                    {% for time in ["07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"] %}
                        <th>{{ time }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for day in ["MON", "TUE", "WED", "THU", "FRI"] %}
                <tr>
                    <td><strong>{{ day }}</strong></td>
                    {% for time in ["07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"] %}
                    <td>
                        {% for row in timetable_rows %}
                            {% if row.classDay == day %}
                                {% set start = row.classTime.split('-')[0].strip() %}
                                {% set end = row.classTime.split('-')[1].strip() %}
                                {% if time >= start and time < end %}
                                    <div style="border:1px solid #ccc; padding:4px; background:#f8f9fa;">
                                        <strong>Course</strong>:<br><i>{{ row.courseName }}</i><br>
                                        <strong>Class Type</strong>: <i>{{ row.classType }}</i><br>
                                        <strong>Room</strong>: <i>{{ row.classRoom }}</i><br>
                                        <strong>Sections</strong>: <br>
                                        {% for intake, code, section in row.combined %}
                                            <i>{{ intake }} | {{ code }} | {{ section }};</i><br>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}




@app.route('/user/ownTimetable', methods=['GET'])
@login_required
def user_ownTimetable():
    userId = session.get('user_id')
    timetable = Timetable.query.filter_by(user_id=userId).first()
    timetable_rows = timetable.rows if timetable else []

    # Combine overlapping (same day & same time) entries
    merged = {}
    for row in timetable_rows:
        key = (row.classDay.upper(), row.classTime, row.classType, row.classRoom)
        if key not in merged:
            merged[key] = {
                'classDay': row.classDay,
                'classTime': row.classTime,
                'classType': row.classType,
                'classRoom': row.classRoom,
                'courseName': row.courseName,
                'courseIntakes': [row.courseIntake],
                'courseCodes': [row.courseCode],
                'courseSections': [row.courseSection]
            }
        else:
            merged[key]['courseIntakes'].append(row.courseIntake)
            merged[key]['courseCodes'].append(row.courseCode)
            merged[key]['courseSections'].append(row.courseSection)

    merged_timetable = []
    for item in merged.values():
        # zip the lists directly (combine element by element)
        item['combined'] = list(zip(item['courseIntakes'], item['courseCodes'], item['courseSections']))
        merged_timetable.append(item)

    return render_template('user/userOwnTimetable.html', active_tab='user_ownTimetabletab', timetable_rows=merged_timetable)










{% extends "user/userBase.html" %}
{% block title %}Timetable{% endblock %}
{% block head_title %}<h2>Own Timetable</h2>{% endblock %}
{% block content %}
<div class="menu-section">
    <div class="user-table-container" style="max-height: None;">
        <table class="user-data-table" border="1">
            <thead>
                <tr>
                    <th>Day / Time</th>
                    {% set time_slots = ["07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"] %}
                    {% for time in time_slots %}
                        <th>{{ time }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for day in ["MON", "TUE", "WED", "THU", "FRI"] %}
                <tr>
                    <td><strong>{{ day }}</strong></td>
                    {% set day_map = {} %}
                    {% for time in time_slots %}
                        {% do day_map.update({time: 'EMPTY'}) %} 
                    {% endfor %}

                    {% for row in timetable_rows %}
                        {% if row.classDay == day %}
                            {% set start_time = row.start_time %}
                            {% set duration = row.colspan %}

                            {% if start_time in time_slots %}
                                {% set start_index = time_slots.index(start_time) %}
                                {% do day_map.update({start_time: row}) %}
                                {% for i in range(1, duration) %}
                                    {% set covered_index = start_index + i %}
                                    {% if covered_index < time_slots|length %}
                                        {% set covered_time = time_slots[covered_index] %}
                                        {% do day_map.update({covered_time: 'COVERED'}) %}
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        {% endif %}
                    {% endfor %}

                    {% for time in time_slots %}
                        {% set slot_status = day_map[time] %}
                        {% if slot_status == 'EMPTY' %}
                            <td></td>
                        {% elif slot_status == 'COVERED' %}
                            {# No action: The logic of skipping is simply not rendering a <td> here #}
                        {% else %}
                            <td colspan="{{ slot_status.colspan }}">
                                <div style="border:1px solid #ccc; padding:4px; background:#f8f9fa; height: 100%;">
                                    <strong>Course</strong>:<br><i>{{ slot_status.courseName }}</i><br>
                                    <strong>Class Type</strong>: <i>{{ slot_status.classType }}</i><br>
                                    <strong>Room</strong>: <i>{{ slot_status.classRoom }}</i><br>
                                    <strong>Sections</strong>: <br>
                                    {% for intake, code, section in slot_status.combined %}
                                        <i>{{ intake }} | {{ code }} | {{ section }};</i><br>
                                    {% endfor %}
                                </div>
                            </td>
                        {% endif %}
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
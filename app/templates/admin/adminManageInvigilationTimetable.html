{% extends "admin/adminBase.html" %}
{% set show_tabs = false %}
{% set show_upload = false %}
{% set show_dashboard = false %}
{% set show_manual = false %}
{% set show_edit = false %}
{% block title %}Admin ManageInvigilationTimetable{% endblock %}
{% block head_title %}<h2>Manage Invigilation Timetable</h2>{% endblock %}

{% block content %}
<div class="menu-section">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h3>Invigilation Timetable</h3>
        <div class="button-wrapper">
            <button id="generatePDF" style="background-color: black;">Download PDF</button>
        </div>
    </div>

    <div style="display: flex; gap: 15px; align-items: center;">
        <h4>Exam Status:</h4>
        <div style="display: flex; align-items: center; gap: 5px;">
            <span style="width: 20px; height: 20px; background-color: lightgrey; display: inline-block; border-radius: 4px;"></span>
            <span>Past Exam</span>
        </div>
        <div style="display: flex; align-items: center; gap: 5px;">
            <span style="width: 20px; height: 20px; background-color: #75bdf9; display: inline-block; border-radius: 4px;"></span>
            <span>Upcoming Exam</span>
        </div>
        <div style="display: flex; align-items: center; gap: 5px;">
            <span style="width: 20px; height: 20px; background-color: #dc74f7; display: inline-block; border-radius: 4px;"></span>
            <span>Overnight Exam (Starts Today, Ends Tomorrow)</span>
        </div>
    </div>

    <div class="calendar-container">
        {% for date, exams in calendar_data.items() %}
            <div class="calendar-day">
                <h3 class="calendar-date" data-date="{{ date.isoformat() }}">{{ date.strftime("%A, %d %B %Y") }} | [Total Exams: {{ exams|length }}]</h3>
                <div class="exam-grid">
                    {% for exam in exams %}
                        <div class="exam-card" style="background-color: {% if exam.is_overnight %}#dc74f7{% elif exam.status %}#75bdf9{% else %}lightgrey{% endif %};">
                            <strong>{{ exam.course_code }} - [{{ exam.course_name }}]</strong><br>
                            <i>Venue: {{ exam.venue }}</i><br>
                            <i>Time: {{ exam.start_time.strftime("%H:%M") }} - {{ exam.end_time.strftime("%H:%M") }}</i>
                            {% if exam.is_overnight %}
                                <span style="font-size: 12px; color: #700;"><strong>[Overnight]</strong></span>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const days = [...document.querySelectorAll(".calendar-day")];
    if (!days.length) return;

    const today = new Date().setHours(0, 0, 0, 0);
    let target = null;

    for (const d of days) {
        const dateAttr = d.querySelector(".calendar-date").dataset.date;
        const date = new Date(dateAttr);

        if (!isNaN(date) && date >= today) { 
            target = d; 
            break; 
        }
    }
    if (!target) target = days[days.length - 1];

    setTimeout(() => {
        target.scrollIntoView({ behavior: "smooth", block: "start", inline: "nearest" });
    }, 100);
});

document.getElementById("generatePDF").addEventListener("click", async () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l', 'mm', 'a4'); // Landscape A4

    const calendarContainer = document.querySelector(".calendar-container");
    if (!calendarContainer) return alert("No timetable found!");

    // Temporary style adjustments
    const originalStyle = calendarContainer.getAttribute("style") || "";
    calendarContainer.style.maxHeight = "none";
    calendarContainer.style.overflow = "visible";
    calendarContainer.style.height = "auto";

    // Wait for DOM reflow
    await new Promise(r => setTimeout(r, 300));

    // Capture full image
    const canvas = await html2canvas(calendarContainer, {
        scale: 2,
        useCORS: true,
        scrollY: 0,
        backgroundColor: "#ffffff"
    });

    // Restore original style
    calendarContainer.setAttribute("style", originalStyle);

    const imgData = canvas.toDataURL("image/png");
    const pdfWidth = doc.internal.pageSize.getWidth();   // e.g. 297mm
    const pdfHeight = doc.internal.pageSize.getHeight(); // e.g. 210mm
    const margin = 20;
    const imgWidth = pdfWidth - 2 * margin;
    const imgProps = doc.getImageProperties(imgData);
    const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

    // Pixel to mm conversion for accurate pagination
    const pxFullHeight = canvas.height;
    const mmPerPx = imgHeight / pxFullHeight;

    // Effective page height in pixels
    const pageHeightPx = (pdfHeight - 2 * margin) / mmPerPx;

    // Add header
    doc.setFont("helvetica", "bold");
    doc.setFontSize(18);
    doc.text("Invigilation Timetable", pdfWidth / 2, margin - 5, { align: "center" });

    let remainingHeight = pxFullHeight;
    let pageOffset = 0;

    while (remainingHeight > 0) {
        const canvasSlice = document.createElement("canvas");
        canvasSlice.width = canvas.width;
        canvasSlice.height = Math.min(pageHeightPx, remainingHeight);
        const ctx = canvasSlice.getContext("2d");

        // Copy only the current page area from full canvas
        ctx.drawImage(
            canvas,
            0,
            pageOffset,
            canvas.width,
            canvasSlice.height,
            0,
            0,
            canvas.width,
            canvasSlice.height
        );

        const sliceImg = canvasSlice.toDataURL("image/png");
        const sliceHeightMm = (canvasSlice.height * mmPerPx);

        const yPos = margin + 10; // add header spacing
        doc.addImage(sliceImg, 'PNG', margin, yPos, imgWidth, sliceHeightMm);

        remainingHeight -= pageHeightPx;
        pageOffset += pageHeightPx;

        if (remainingHeight > 0) {
            doc.addPage();
        }
    }

    doc.save("Invigilation_Timetable.pdf");
});
</script>

{% endblock %}


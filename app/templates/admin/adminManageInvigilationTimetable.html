{% extends "admin/adminBase.html" %}
{% set show_tabs = false %}
{% set show_upload = false %}
{% set show_cal = true %}
{% set show_dashboard = false %}
{% set show_manual = false %}
{% set show_edit = false %}
{% block title %}Admin ManageInvigilationTimetable{% endblock %}
{% block head_title %}<h2>Manage Invigilation Timetable</h2>{% endblock %}

{% block content %}
<div class="menu-section">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>Invigilation Timetable List(s)</h2>
        <div style="display: flex; align-items: center; gap: 10px;">
            <div style="position: relative;">
                <input type="text" id="searchInput" name="search_InvigilationTimetable" placeholder="Search..." value="{{ search_InvigilationTimetable }}" style="border-radius: 6px; width: 100%;">
                <i class="fa fa-search" id="searchBtn" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer;"></i>
            </div>
            <div class="button-wrapper">
                <button id="generatePDF" style="background-color: black;">Download as PDF</button>
            </div>
        </div>
    </div>
    <div id="noResults" style="display: none; text-align: center; font-weight: bold; color: #b00;">No results found.</div>

    <div style="display: flex; gap: 15px; align-items: center;">
        <h4>Exam Status:</h4>
        <div style="display: flex; align-items: center; gap: 5px;">
            <span style="width: 20px; height: 20px; background-color: lightgrey; display: inline-block; border-radius: 4px;"></span>
            <span>Past Exam</span>
        </div>
        <div style="display: flex; align-items: center; gap: 5px;">
            <span style="width: 20px; height: 20px; background-color: #b5deff; display: inline-block; border-radius: 4px;"></span>
            <span>Upcoming Exam</span>
        </div>
        <div style="display: flex; align-items: center; gap: 5px;">
            <span style="width: 20px; height: 20px; background-color: #e3bded; display: inline-block; border-radius: 4px;"></span>
            <span>Overnight Exam (Starts Today, Ends Tomorrow)</span>
        </div>
    </div>
    
    <div class="calendar-container">
        {# Group all exams by date first #}
        {% set all_dates = [] %}
        {% for venue, exams in venue_data.items() %}
            {% for exam in exams %}
                {% set _ = all_dates.append(exam.start_time.strftime("%d %b %Y")) %}
            {% endfor %}
        {% endfor %}
        {% set unique_dates = all_dates | unique %}

        {% for date in unique_dates %}
            <div class="date-block">
                <h2>Date: {{ date }}</h2>
                {% set grand_total_students = 0 %}

                {# Loop through all venues on this date #}
                {% for venue, venue_exams in venue_data.items() %}
                    {% set day_exams = [] %}
                    {% for exam in venue_exams %}
                        {% if exam.session.startDateTime.strftime("%d %b %Y") == date %}
                            {% do day_exams.append(exam) %}
                        {% endif %}
                    {% endfor %}

                    {% if day_exams %}
                        {% set venue_start = day_exams | map(attribute='session.startDateTime') | min %}
                        {% set venue_end = day_exams | map(attribute='session.endDateTime') | max %}
                        {% set venue_total = 0 %}

                        <div class="venue-block">
                            <h3>Venue: {{ venue }} | {{ venue_start.strftime("%H:%M") }} - {{ venue_end.strftime("%H:%M") }}</h3>
                            {% for exam in day_exams %}
                                <p>
                                    <strong>{{ exam.exam.course.courseCodeSectionIntake }} â€“ {{ exam.exam.course.courseName }} [Students: {{ exam.studentCount }}]</strong>
                                    {% if exam.session.endDateTime.date() > exam.session.startDateTime.date() %}
                                        <span style="color: #b400b4;">(Overnight Exam)</span>
                                    {% endif %}
                                </p>
                                {% set venue_total = venue_total + exam.studentCount %}
                            {% endfor %}
                            <strong>Total Students: {{ venue_total }}</strong>
                        </div>

                        {% set grand_total_students = grand_total_students + venue_total %}
                    {% endif %}
                {% endfor %}

                <p><strong>Grand Total Students for the Day: {{ grand_total_students }}</strong></p>
            </div>
        {% endfor %}

    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const days = [...document.querySelectorAll(".calendar-day")];
    if (!days.length) return;

    const today = new Date().setHours(0, 0, 0, 0);
    let target = null;

    for (const d of days) {
        const dateAttr = d.querySelector(".calendar-date").dataset.date;
        const date = new Date(dateAttr);
        if (!isNaN(date) && date >= today) { 
            target = d; 
            break; 
        }
    }
    if (!target) target = days[days.length - 1];

    setTimeout(() => {
        target.scrollIntoView({ behavior: "smooth", block: "start", inline: "nearest" });
    }, 100);
});

document.getElementById("generatePDF").addEventListener("click", async () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l', 'mm', 'a4'); // Landscape A4
    const margin = 15;
    const pageHeight = doc.internal.pageSize.getHeight();
    const pageWidth = doc.internal.pageSize.getWidth();
    const nowMY = new Date().toLocaleString("en-GB", {timeZone: "Asia/Kuala_Lumpur", day: "2-digit", month: "short", year: "numeric", hour: "2-digit", minute: "2-digit", hour12: true});
    
    // ===== Title =====
    doc.setFont("helvetica", "bold");
    doc.setFontSize(18);
    doc.text("Admin View - Invigilation Timetable Download", pageWidth / 2, margin, { align: "center" });

    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);
    doc.text(`Downloaded on: ${nowMY}`, pageWidth / 2, margin + 8, { align: "center" });
    let y = margin + 15;

    const days = document.querySelectorAll(".calendar-day");
    if (!days.length) return alert("No timetable found!");

    for (const [i, day] of days.entries()) {
        const dateText = day.querySelector(".calendar-date").innerText;
        const examList = day.querySelector(".exam-grid");

        // Capture this day's exam list
        const canvas = await html2canvas(examList, { scale: 2 });
        const imgData = canvas.toDataURL("image/png");

        const pdfWidth = pageWidth - 2 * margin;
        const imgProps = doc.getImageProperties(imgData);
        const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;

        // Padding & border calculations
        const topPadding = 6;
        const bottomPadding = 10;
        const totalBlockHeight = imgHeight + topPadding + bottomPadding + 8; // better spacing

        // Add new page if block exceeds height
        if (y + totalBlockHeight > pageHeight - margin) {
            doc.addPage();
            y = margin;
            doc.setFontSize(20);
            doc.text("Invigilation Timetable", pageWidth / 2, y, { align: "center" });
            y += 15;
        }

        // Draw border box
        doc.setDrawColor(0);
        doc.rect(margin - 3, y - 5, pdfWidth + 6, totalBlockHeight);

        // Day title
        doc.setFontSize(14);
        doc.text(dateText, margin, y + 5);

        // Image (exam content)
        const imageY = y + topPadding + 8;
        doc.addImage(imgData, 'PNG', margin, imageY, pdfWidth, imgHeight);

        // Move Y position for next day
        y += totalBlockHeight + 5;
    }

    doc.save("Admin_ViewInvigilationTimetable.pdf");
});

document.addEventListener("DOMContentLoaded", () => {
    const searchInput = document.getElementById("searchInput");
    const noResults = document.getElementById("noResults");

    if (!searchInput) return;

    searchInput.addEventListener("input", () => {
        const filter = searchInput.value.toLowerCase();
        let anyVisible = false;

        const days = document.querySelectorAll(".calendar-day");
        days.forEach(day => {
            const dateText = day.querySelector(".calendar-date").innerText.toLowerCase();
            let dayHasVisible = false;

            // Check if date matches filter
            if (dateText.includes(filter)) {
                dayHasVisible = true;
                day.querySelectorAll(".exam-card").forEach(card => card.style.display = "block");
            } else {
                // Check each exam card under this date
                const cards = day.querySelectorAll(".exam-card");
                cards.forEach(card => {
                    const text = card.innerText.toLowerCase();
                    if (text.includes(filter)) {
                        card.style.display = "block";
                        dayHasVisible = true;
                    } else {
                        card.style.display = "none";
                    }
                });
            }

            // Hide entire day if no cards or date match
            day.style.display = dayHasVisible ? "block" : "none";
            if (dayHasVisible) anyVisible = true;
        });

        noResults.style.display = anyVisible ? "none" : "block";
    });
});
</script>
{% endblock %}




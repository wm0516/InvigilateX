{% extends "admin/adminBase.html" %}
{% set show_tabs = false %}
{% set show_upload = false %}
{% set show_dashboard = false %}
{% set show_manual = false %}
{% set show_edit = false %}
{% block title %}Admin ManageInvigilationTimetable{% endblock %}
{% block head_title %}<h2>Manage Invigilation Timetable</h2>{% endblock %}

{% block content %}
<div class="menu-section">
    <h3>List of All Exam Sessions Details</h3>
    <h4>Color <span style="color: lightgrey;">pass exam</span>, and color <span style="color: #4682b4;">coming exam</span></h4>
    <div class="calendar-container">
        <!-- Time Header Row -->
        <div class="calendar-row">
            <div class="calendar-date-label"></div>
            {% for hour in range(0, 24) %}  
                <div class="calendar-hour">{{ "%02d:00"|format(hour) }}</div>
            {% endfor %}
        </div>

        {% set hour_width = 80 %}
        {% for date, exams in calendar_data.items() %}
            {% set sorted_exams = exams | sort(attribute='start_time') %}
            {% set positions = [] %}

            {% for exam in sorted_exams %}
                {% set overlapping = positions
                    | selectattr("start", "lt", exam.end_time)
                    | selectattr("end", "gt", exam.start_time)
                    | list %}
                {% set row_index = overlapping | length %}
                {% set _ = positions.append({'start': exam.start_time, 'end': exam.end_time, 'row': row_index}) %}
            {% endfor %}

            {% if positions %}
                {% set max_row = (positions | map(attribute='row') | max) + 1 %}
            {% else %}
                {% set max_row = 1 %}
            {% endif %}

            <div class="calendar-row">
                <div class="calendar-date-label"    
                    {% if not exam.examStatus %}
                        style="background-color: lightgrey;"
                    {% endif %}
                >{{ date.strftime("%d %b (%A)") }}
                </div>

                <div class="calendar-day" style="width: {{ hour_width * 24 }}px; height: {{ max_row * 60 }}px;">
                    {% for i in range(sorted_exams|length) %}
                        {% set exam = sorted_exams[i] %}
                        {% set pos = positions[i] %}
                        {% set start_hour = exam.start_time.hour + (exam.start_time.minute / 60) %}
                        {% set end_hour = exam.end_time.hour + (exam.end_time.minute / 60) %}
                        {% set left_pos = 10 + start_hour * hour_width %}    
                        {% set width = (end_hour - start_hour) * hour_width %}
                        {% set top_pos =  5 + (pos.row * 60) %}

                        <div class="exam-block"
                            style="left:{{ left_pos }}px; width:{{ width }}px; top:{{ top_pos }}px;">
                            <strong>{{ exam.course_code }}</strong><br>
                            {{ exam.course_name }}<br>
                            <i>{{ exam.venue }} | {{ exam.start_time.strftime("%H:%M") }}â€“{{ exam.end_time.strftime("%H:%M") }}</i>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    </div>
</div>
{% endblock %}
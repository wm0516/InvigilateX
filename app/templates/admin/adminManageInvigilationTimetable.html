{% extends "admin/adminBase.html" %}
{% set show_tabs = true %}
{% set show_upload = false %}
{% set show_dashboard = true %}
{% set show_manual = false %}
{% set show_edit = true %}
{% block title %}Admin ManageInvigilationTimetable{% endblock %}
{% block head_title %}<h2>Manage Invigilation Timetable</h2>{% endblock %}

{% block dashboard_section %}
<!-- Dashboard Form -->
<form id="dashboardForm" action="{{ url_for('admin_manageInvigilationTimetable') }}" method="POST">
    <div id="dashboardSection" style="width: 90%; margin:auto; padding:1%">
        <input type="hidden" name="form_type" value="dashboard">
        <div class="form-left" style="width: 100%">

            <!-- Overview -->
            <div class="dashboard-row">
                <div class="dashboard-frame">
                    <h3>Total Invigilation Reports</h3>
                    <p class="dashboard-text">{{ total_report }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Total Assigned Invigilators</h3>
                    <p class="dashboard-text" style="color:green;">{{ total_invigilator }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Invigilators In Progress</h3>
                    <p class="dashboard-text" style="color:green;">{{ total_inProgress   }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Invigilators Pending Check-In/Out</h3>
                    <p class="dashboard-text" style="color:red;">{{ total_checkInOut }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Invigilators Checked In On Time</h3>
                    <p class="dashboard-text" style="color:green;">{{ total_checkInOnTime }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Invigilators Checked Out On Time</h3>
                    <p class="dashboard-text" style="color:green;">{{ total_checkOutOnTime }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Invigilators Checked In Late</h3>
                    <p class="dashboard-text" style="color:red;">{{ total_checkInLate }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Invigilators Checked Out Early</h3>
                    <p class="dashboard-text" style="color:red;">{{ total_checkOutEarly }}</p>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block edit_section %}
<!-- Edit Form -->
<form id="editForm" action="{{ url_for('admin_manageInvigilationTimetable') }}" method="POST">
    <div id="editSection" style="width: 90%; margin:auto;">
        <input type="hidden" name="form_type" value="edit">
        <div class="form-left" style="width: 100%">
        </div>
    </div>
</form>
{% endblock %}

{% block content %}
<div class="menu-section">
    <h3>List of All Exam Sessions Details</h3>
    <div class="user-table-container">
        <table class="user-data-table">
            <thead>
                <tr>
                    <th>Exam ID</th>
                    <th>Course Details</th>
                    <th>Exam Details</th>
                    <th>Number of Invigilators</th>
                    <th>Invigilator Details</th>
                    <th>Attendance Status</th>
                </tr>
            </thead>

            <tbody>
                {% for exam, grouped in attendances|groupby("report.exam.examId") %}
                    {% set rowspan = grouped|length %}
                    
                    {% for att in grouped %}
                        <tr>
                            {% if loop.first %}
                                <!-- Exam ID -->
                                <td rowspan="{{ rowspan }}" style="text-align:center;">[{{ att.report.exam.examId }}]</td>

                            <!-- Course Details -->
                            <td rowspan="{{ rowspan }}">
                                Course Name        : {{ att.report.exam.course.courseName }} <br>
                                Course Code/Section: {{ att.report.exam.course.courseCodeSection }}<br>
                                Number of Students : {{ att.report.exam.course.courseStudent }}
                            </td>

                            <!-- Exam Details -->
                            <td rowspan="{{ rowspan }}">
                                Exam Date   : [{{ att.report.exam.examStartTime.strftime("%Y-%m-%d") }}] - [{{ att.report.exam.examEndTime.strftime("%Y-%m-%d") }}] <br>      
                                Exam Day    : [{{ att.report.exam.examStartTime.strftime("%A") }}] - [{{ att.report.exam.examEndTime.strftime("%A") }}] <br>
                                Exam Time   : [{{ att.report.exam.examStartTime.strftime("%H:%M") }}] - [{{ att.report.exam.examEndTime.strftime("%H:%M") }}] <br>
                                Exam Period : [{{ (att.report.exam.examEndTime - att.report.exam.examStartTime).seconds // 3600 }}h 
                                              {{ ((att.report.exam.examEndTime - att.report.exam.examStartTime).seconds % 60) // 3600 }}m]<br>
                                Exam Venue  : [{{ att.report.exam.examVenue }}]
                            </td>


                                <td rowspan="{{ rowspan }}">[{{ att.report.exam.examNoInvigilator }}]</td>
                            {% endif %}

                            <!-- Invigilator Details (one per row) -->
                            <td>
                                ID     : {{ att.invigilator.userId }} <br>
                                Name   : {{ att.invigilator.userName }} <br>
                                Contact: {{ att.invigilator.userContact }}
                            </td>

                            <!-- Attendance Status (per invigilator) -->
                            <td>{{ att.remark }}</td>
                        </tr>
                    {% endfor %}
                {% endfor %}
            </tbody>    
        </table>
    </div>
</div>

{% endblock %}
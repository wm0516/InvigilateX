{% extends "admin/adminBase.html" %}
{% set show_tabs = false %}
{% set show_upload = false %}
{% set show_cal = true %}
{% set show_dashboard = false %}
{% set show_manual = false %}
{% set show_edit = false %}
{% block title %}Admin ManageInvigilationTimetable{% endblock %}
{% block head_title %}<h2>Manage Invigilation Timetable</h2>{% endblock %}

{% block content %}
<div class="menu-section">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>Invigilation Timetable List(s)</h2>
        <div style="display: flex; align-items: center; gap: 10px;">
            <div style="position: relative;">
                <input type="text" id="searchInput" name="search_InvigilationTimetable" placeholder="Search..." value="{{ search_InvigilationTimetable }}" style="border-radius: 6px; width: 100%;">
                <i class="fa fa-search" id="searchBtn" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer;"></i>
            </div>
            <div class="button-wrapper">
                <button id="generatePDF" style="background-color: black;">Download as PDF</button>
            </div>
        </div>
    </div>
    <div id="noResults" style="display: none; text-align: center; font-weight: bold; color: #b00;">No results found.</div>

    <div style="display: flex; gap: 15px; align-items: center;">
        <h4>Exam Status:</h4>
        <div style="display: flex; align-items: center; gap: 5px;">
            <span style="width: 20px; height: 20px; background-color: lightgrey; display: inline-block; border-radius: 4px;"></span>
            <span>Past Exam</span>
        </div>
        <div style="display: flex; align-items: center; gap: 5px;">
            <span style="width: 20px; height: 20px; background-color: #b5deff; display: inline-block; border-radius: 4px;"></span>
            <span>Upcoming Exam</span>
        </div>
        <div style="display: flex; align-items: center; gap: 5px;">
            <span style="width: 20px; height: 20px; background-color: #e3bded; display: inline-block; border-radius: 4px;"></span>
            <span>Overnight Exam (Starts Today, Ends Tomorrow)</span>
        </div>
    </div>
    
    <div class="calendar-container">
        {# First, loop over venues #}
        {% for venue, exams in venue_data.items() %}
            {# Group exams by date #}
            {% set exams_by_date = {} %}
            {% for exam in exams %}
                {% set exam_date = exam.start_time.strftime("%d %b %Y") %}
                {% if exam_date not in exams_by_date %}
                    {% set _ = exams_by_date.update({exam_date: []}) %}
                {% endif %}
                {% set _ = exams_by_date[exam_date].append(exam) %}
            {% endfor %}

            {# Now loop over each date for this venue #}
            {% for date, day_exams in exams_by_date.items() %}
                <div class="venue-block" style="margin-bottom: 20px; padding: 10px; border: 1px solid #aaa; border-radius: 8px;">
                    <h2>{{ date }} | Total Exams: {{ day_exams|length }}</h2>
                    <div class="exam-grid">

                        {% set ns = namespace(total_students=0) %}

                        {# Group exams by (venue, start_time, end_time) #}
                        {% set grouped = {} %}
                        {% for exam in day_exams %}
                            {% set key = (exam.start_time, exam.end_time, venue) %}
                            {% if key not in grouped %}
                                {% set grouped = grouped.update({key: [exam]}) or grouped %}
                            {% else %}
                                {% set grouped[key] = grouped[key] + [exam] %}
                            {% endif %}
                        {% endfor %}

                        {# Loop through grouped exams #}
                        {% for key, exams in grouped.items() %}
                            <div class="exam-card" style="margin-bottom: 10px; padding: 8px; border: 1px solid #ccc; border-radius: 5px;">
                                {% set start_time, end_time, venue_name = key %}
                                Time: {{ start_time.strftime("%H:%M") }} - {{ end_time.strftime("%H:%M") }}<br>
                                Venue: {{ venue_name }}<br>
                                
                                {% for exam in exams %}
                                    <strong>{{ exam.course_code }}/{{ exam.section }} â€“ {{ exam.course_name }} | Students: {{ exam.students }}</strong><br>
                                    {% if exam.is_overnight %}
                                        <span style="color: #b400b4;">Overnight Exam</span><br>
                                    {% endif %}

                                    {% set ns.total_students = ns.total_students + exam.students %}
                                {% endfor %}
                            </div>
                        {% endfor %}

                        <strong>Total Students: {{ ns.total_students }}</strong>
                    </div>
                </div>
            {% endfor %}


        {% endfor %}
    </div>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const days = [...document.querySelectorAll(".calendar-day")];
    if (!days.length) return;

    const today = new Date().setHours(0, 0, 0, 0);
    let target = null;

    for (const d of days) {
        const dateAttr = d.querySelector(".calendar-date").dataset.date;
        const date = new Date(dateAttr);
        if (!isNaN(date) && date >= today) { 
            target = d; 
            break; 
        }
    }
    if (!target) target = days[days.length - 1];

    setTimeout(() => {
        target.scrollIntoView({ behavior: "smooth", block: "start", inline: "nearest" });
    }, 100);
});

document.getElementById("generatePDF").addEventListener("click", async () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l', 'mm', 'a4'); // Landscape A4
    const margin = 15;
    const pageHeight = doc.internal.pageSize.getHeight();
    const pageWidth = doc.internal.pageSize.getWidth();
    const nowMY = new Date().toLocaleString("en-GB", {timeZone: "Asia/Kuala_Lumpur", day: "2-digit", month: "short", year: "numeric", hour: "2-digit", minute: "2-digit", hour12: true});
    
    // ===== Title =====
    doc.setFont("helvetica", "bold");
    doc.setFontSize(18);
    doc.text("Admin View - Invigilation Timetable Download", pageWidth / 2, margin, { align: "center" });

    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);
    doc.text(`Downloaded on: ${nowMY}`, pageWidth / 2, margin + 8, { align: "center" });
    let y = margin + 15;

    const days = document.querySelectorAll(".calendar-day");
    if (!days.length) return alert("No timetable found!");

    for (const [i, day] of days.entries()) {
        const dateText = day.querySelector(".calendar-date").innerText;
        const examList = day.querySelector(".exam-grid");

        // Capture this day's exam list
        const canvas = await html2canvas(examList, { scale: 2 });
        const imgData = canvas.toDataURL("image/png");

        const pdfWidth = pageWidth - 2 * margin;
        const imgProps = doc.getImageProperties(imgData);
        const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;

        // Padding & border calculations
        const topPadding = 6;
        const bottomPadding = 10;
        const totalBlockHeight = imgHeight + topPadding + bottomPadding + 8; // better spacing

        // Add new page if block exceeds height
        if (y + totalBlockHeight > pageHeight - margin) {
            doc.addPage();
            y = margin;
            doc.setFontSize(20);
            doc.text("Invigilation Timetable", pageWidth / 2, y, { align: "center" });
            y += 15;
        }

        // Draw border box
        doc.setDrawColor(0);
        doc.rect(margin - 3, y - 5, pdfWidth + 6, totalBlockHeight);

        // Day title
        doc.setFontSize(14);
        doc.text(dateText, margin, y + 5);

        // Image (exam content)
        const imageY = y + topPadding + 8;
        doc.addImage(imgData, 'PNG', margin, imageY, pdfWidth, imgHeight);

        // Move Y position for next day
        y += totalBlockHeight + 5;
    }

    doc.save("Admin_ViewInvigilationTimetable.pdf");
});

document.addEventListener("DOMContentLoaded", () => {
    const searchInput = document.getElementById("searchInput");
    const noResults = document.getElementById("noResults");

    if (!searchInput) return;

    searchInput.addEventListener("input", () => {
        const filter = searchInput.value.toLowerCase();
        let anyVisible = false;

        const days = document.querySelectorAll(".calendar-day");
        days.forEach(day => {
            const dateText = day.querySelector(".calendar-date").innerText.toLowerCase();
            let dayHasVisible = false;

            // Check if date matches filter
            if (dateText.includes(filter)) {
                dayHasVisible = true;
                day.querySelectorAll(".exam-card").forEach(card => card.style.display = "block");
            } else {
                // Check each exam card under this date
                const cards = day.querySelectorAll(".exam-card");
                cards.forEach(card => {
                    const text = card.innerText.toLowerCase();
                    if (text.includes(filter)) {
                        card.style.display = "block";
                        dayHasVisible = true;
                    } else {
                        card.style.display = "none";
                    }
                });
            }

            // Hide entire day if no cards or date match
            day.style.display = dayHasVisible ? "block" : "none";
            if (dayHasVisible) anyVisible = true;
        });

        noResults.style.display = anyVisible ? "none" : "block";
    });
});
</script>
{% endblock %}




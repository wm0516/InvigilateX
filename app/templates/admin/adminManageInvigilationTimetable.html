{% extends "admin/adminBase.html" %}
{% set show_tabs = true %}
{% set show_upload = false %}
{% set show_dashboard = true %}
{% set show_manual = false %}
{% set show_edit = true %}
{% block title %}Admin ManageInvigilationTimetable{% endblock %}
{% block head_title %}<h2>Manage Invigilation Timetable</h2>{% endblock %}

{% block dashboard_section %}
<!-- Dashboard Form -->
<form id="dashboardForm" action="{{ url_for('admin_manageInvigilationTimetable') }}" method="POST">
    <div id="dashboardSection" style="width: 90%; margin:auto; padding:1%">
        <input type="hidden" name="form_type" value="dashboard">
        <div class="form-left" style="width: 100%">

            <!-- Overview -->
            <div class="dashboard-row">
                <div class="dashboard-frame">
                    <h3>Total Invigilation Reports</h3>
                    <p class="dashboard-text">{{ total_report }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Total Assigned Invigilators</h3>
                    <p class="dashboard-text" style="color:green;">{{ total_invigilator }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Invigilators In Progress</h3>
                    <p class="dashboard-text" style="color:green;">{{ total_inProgress   }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Invigilators Pending Check-In/Out</h3>
                    <p class="dashboard-text" style="color:red;">{{ total_checkInOut }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Invigilators Checked In On Time</h3>
                    <p class="dashboard-text" style="color:green;">{{ total_checkInOnTime }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Invigilators Checked Out On Time</h3>
                    <p class="dashboard-text" style="color:green;">{{ total_checkOutOnTime }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Invigilators Checked In Late</h3>
                    <p class="dashboard-text" style="color:red;">{{ total_checkInLate }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Invigilators Checked Out Early</h3>
                    <p class="dashboard-text" style="color:red;">{{ total_checkOutEarly }}</p>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block edit_section %}
<!-- Edit Form -->
<form id="editForm" action="{{ url_for('admin_manageInvigilationTimetable') }}" method="POST">
    <div id="editSection" style="width: 100%; margin:auto;">
        <input type="hidden" name="form_type" value="edit">
        <div class="form-left" style="width: 100%">
        </div>
    </div>
</form>
{% endblock %}

{% block content %}
<div class="menu-section">
    <h3>List of All Exam Sessions Details</h3>
    <div class="calendar-container">

        <!-- Time Header Row -->
        <div class="calendar-row">
            <div class="calendar-date-label time-label"></div>  {# Empty top-left cell #}
            {% for hour in range(0, 24) %}
                <div class="calendar-hour">{{ "%02d:00"|format(hour) }}</div>
            {% endfor %}
        </div>

        {% set hour_width = 80 %}
        {% for date, exams in calendar_data.items() %}
            {% set sorted_exams = exams | sort(attribute='start_time') %}
            {% set positions = [] %}

            {# Calculate row indexes for overlapping exams #}
            {% for exam in sorted_exams %}
                {% set overlapping = positions | selectattr("start", "lt", exam.end_time) | selectattr("end", "gt", exam.start_time) | list %}
                {% set row_index = overlapping | length %}
                {% set _ = positions.append({'start': exam.start_time, 'end': exam.end_time, 'row': row_index}) %}
            {% endfor %}

            <div class="calendar-row calendar-day-row">
                <div class="calendar-date-label">
                    {{ date.strftime("%d %b (%A)") }}
                </div>

                <div class="calendar-day" style="width: {{ hour_width * 24 }}px; min-height: {{ row_index * 60 }}px;">
                    {% for i in range(sorted_exams|length) %}
                        {% set exam = sorted_exams[i] %}
                        {% set pos = positions[i] %}
                        {% set start_hour = exam.start_time.hour + (exam.start_time.minute / 60) %}
                        {% set end_hour = exam.end_time.hour + (exam.end_time.minute / 60) %}
                        {% set left_pos = start_hour * hour_width %}
                        {% set width = (end_hour - start_hour) * hour_width %}
                        {% set row_index = pos.row %}

                        <div class="exam-block"
                            style="left:{{ left_pos }}px; width:{{ width }}px; top:{{ row_index * 60 }}px;">
                            <strong>{{ exam.course_code }}</strong><br>
                            {{ exam.course_name }}<br>
                            <small>{{ exam.venue }} | {{ exam.start_time.strftime("%H:%M") }}â€“{{ exam.end_time.strftime("%H:%M") }}</small><br>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    </div>

</div>
{% endblock %}
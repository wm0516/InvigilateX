{% extends "admin/adminBase.html" %}
{% set show_tabs = false %}
{% set show_upload = false %}
{% set show_dashboard = false %}
{% set show_manual = false %}
{% set show_edit = false %}
{% block title %}Admin ManageInvigilationTimetable{% endblock %}
{% block head_title %}<h2>Manage Invigilation Timetable</h2>{% endblock %}

{% block content %}
<div class="menu-section">
    <h3>List of All Exam Sessions Details</h3>

    <!-- Legend -->
    <div style="display: flex; gap: 20px; align-items: center; margin-bottom: 20px;">
        <h4>Exam Status:</h4>
        <div style="display: flex; align-items: center; gap: 5px;">
            <span style="width: 20px; height: 20px; background-color: lightgrey; display: inline-block; border-radius: 4px;"></span>
            <span>Pass Exam</span>
        </div>
        <div style="display: flex; align-items: center; gap: 5px;">
            <span style="width: 20px; height: 20px; background-color: #75bdf9; display: inline-block; border-radius: 4px;"></span>
            <span>Coming Exam</span>
        </div>
    </div>

    <!-- Calendar -->
    <div class="calendar-container" style="overflow-x: auto; overflow-y: auto; border: 1px solid #ccc;">
        <!-- Time Header Row -->
        <div class="calendar-row" style="display: flex; position: sticky; top: 0; background: #f9f9f9; z-index: 10;">
            <div class="calendar-date-label" style="width: 150px;"></div>
            {% set hour_width = 80 %}
            {% for hour in range(0, 24) %}
                <div class="calendar-hour" style="width: {{ hour_width }}px; text-align: center; border-left: 1px solid #ddd;">
                    {{ "%02d:00"|format(hour) }}
                </div>
            {% endfor %}
        </div>

        {% for date, exams in calendar_data.items() %}
            {% set sorted_exams = exams | sort(attribute='start_time') %}
            {% set positions = [] %}

            {% for exam in sorted_exams %}
                {% set overlapping = positions | selectattr("start", "lt", exam.end_time) | selectattr("end", "gt", exam.start_time) | list %}
                {% set row_index = overlapping | length %}
                {% set _ = positions.append({'start': exam.start_time, 'end': exam.end_time, 'row': row_index}) %}
            {% endfor %}

            {% if positions %}
                {% set max_row = (positions | map(attribute='row') | max) + 1 %}
            {% else %}
                {% set max_row = 1 %}
            {% endif %}

            <div class="calendar-row" style="display: flex; position: relative; margin-bottom: 10px;">
                <!-- Y-axis date + time -->
                <div class="calendar-date-label" style="width: 150px; text-align: right; padding-right: 5px;">
                    {{ date.strftime("%d %b %Y (%A)") }}
                </div>

                <!-- Exams area -->
                <div class="calendar-day" style="position: relative; width: {{ hour_width * 24 }}px; height: {{ max_row * 60 }}px;">
                    {% for i in range(sorted_exams|length) %}
                        {% set exam = sorted_exams[i] %}
                        {% set pos = positions[i] %}
                        {% set start_hour = exam.start_time.hour + (exam.start_time.minute / 60) %}
                        {% set end_hour = exam.end_time.hour + (exam.end_time.minute / 60) %}
                        {% set left_pos = start_hour * hour_width %}
                        {% set width = (end_hour - start_hour) * hour_width %}
                        {% set top_pos = pos.row * 60 %}

                        {% if exam.status %}
                            {% set block_color = '#75bdf9' %}  {# Upcoming exam #}
                        {% else %}
                            {% set block_color = 'lightgrey' %}  {# Past exam #}
                        {% endif %}

                        <div class="exam-block"
                            style="position: absolute; left: {{ left_pos }}px; top: {{ top_pos }}px;
                                   width: {{ width }}px; height: 50px; background-color: {{ block_color }};
                                   border-radius: 4px; padding: 3px; box-sizing: border-box; overflow: hidden; font-size: 12px;">
                            <strong>{{ exam.course_code }}</strong><br>
                            {{ exam.course_name }}<br>
                            <i>{{ exam.venue }} | {{ exam.start_time.strftime("%H:%M") }}â€“{{ exam.end_time.strftime("%H:%M") }}</i>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% extends "admin/adminBase.html" %}
{% set show_tabs = false %}
{% set show_upload = false %}
{% set show_dashboard = false %}
{% set show_manual = false %}
{% set show_edit = false %}
{% block title %}Admin ManageInvigilationTimetable{% endblock %}
{% block head_title %}<h2>Manage Invigilation Timetable</h2>{% endblock %}

{% block content %}
<div class="menu-section">
    <h3>List of All Exam Sessions Details</h3>
    <div style="display: flex; gap: 15px; align-items: center;">
        <h4>Exam Status:</h4>
        <div style="display: flex; align-items: center; gap: 5px;">
            <span style="width: 20px; height: 20px; background-color: lightgrey; display: inline-block; border-radius: 4px;"></span>
            <span>Past Exam</span>
        </div>
        <div style="display: flex; align-items: center; gap: 5px;">
            <span style="width: 20px; height: 20px; background-color: #75bdf9; display: inline-block; border-radius: 4px;"></span>
            <span>Upcoming Exam</span>
        </div>
        <div style="display: flex; align-items: center; gap: 5px;">
            <span style="width: 20px; height: 20px; background-color: #dc74f7; display: inline-block; border-radius: 4px;"></span>
            <span>Overnight Exam (Starts Today, Ends Tomorrow)</span>
        </div>
    </div><br>

    <div class="calendar-container">
        <!-- Time Header Row -->
        <div class="calendar-row">
            <div class="calendar-date-label"></div>
            {% for hour in range(0, 24) %}  
                <div class="calendar-hour">{{ "%02d:00"|format(hour) }}</div>
            {% endfor %}
        </div>

        {% set hour_width = 110 %}
        {% for date in full_dates %}
            {% set exams = calendar_data.get(date, []) %}
            {% set sorted_exams = exams | sort(attribute='start_time') %}
            {% set positions = [] %}
            {% for exam in sorted_exams %}
                {% set overlapping = positions | selectattr("start", "lt", exam.end_time) | selectattr("end", "gt", exam.start_time) | list %}
                {% set row_index = overlapping | length %}
                {% set _ = positions.append({'start': exam.start_time, 'end': exam.end_time, 'row': row_index}) %}
            {% endfor %}
            {% if positions %}
                {% set max_row = (positions | map(attribute='row') | max) + 1 %}
            {% else %}
                {% set max_row = 1 %}
            {% endif %}

            <div class="calendar-row" id="date-{{ date.strftime('%Y-%m-%d') }}">
                <div class="calendar-date-label">{{ date.strftime("%d %b %Y (%A)") }}</div>
                <div class="calendar-day" style="width: {{ hour_width * 24 }}px; height: {{ 10 + max_row * 70 }}px;">
                    {% for i in range(sorted_exams|length) %}
                        {% set exam = sorted_exams[i] %}
                        {% set pos = positions[i] %}
                        {% set start_hour = exam.start_time.hour + (exam.start_time.minute / 60) %}
                        {% set end_hour = exam.end_time.hour + (exam.end_time.minute / 60) %}
                        {% if start_hour > 1 %}
                            left_pos += 30
                        {% endif %}
                        {% set left_pos = start_hour * hour_width %}
                        {% set width = (end_hour - start_hour) * hour_width %}
                        {% if width > 110 %}
                            width += 10
                        {% endif %}
                        {% set top_pos = 5 + (pos.row * 70) %}

                        {% if exam.is_overnight %}
                            {% set block_color = '#dc74f7' %}
                        {% elif exam.status %}
                            {% set block_color = '#75bdf9' %}
                        {% else %}
                            {% set block_color = 'lightgrey' %}
                        {% endif %}

                        <div class="exam-block"
                            style="background-color: {{ block_color }}; left:{{ left_pos }}px; width:{{ width }}px; top:{{ top_pos }}px;">
                            <strong>{{ exam.course_code }}</strong><br>
                            {{ exam.course_name }}<br>
                            <i>{{ exam.venue }}<br>{{ exam.start_time.strftime("%H:%M") }}â€“{{ exam.end_time.strftime("%H:%M") }}</i>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    const todayId = `date-${yyyy}-${mm}-${dd}`;
    const container = document.querySelector('.calendar-container');
    const todayRow = document.getElementById(todayId);

    if (todayRow && container) {
        container.scrollTo({
            top: todayRow.offsetTop - 40,
            behavior: 'smooth'
        });
    }
});
</script>
{% endblock %}

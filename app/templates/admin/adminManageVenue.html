{% extends "admin/adminBase.html" %}
{% set show_tabs = true %}
{% set show_upload = false %}
{% set show_dashboard = false %}
{% set show_manual = true %}
{% set show_edit = true %}
{% block title %}Admin ManageVenue{% endblock %}
{% block head_title %}<h2>Manage Venue</h2>{% endblock %}

{% block manual_section %}
<!-- Manual Form -->
<form id="manualForm" action="{{ url_for('admin_manageVenue') }}" method="POST" enctype="multipart/form-data">
    <div id="manualSection" class="function-frame">
        <h4 style="text-align: center;">Manual Data Entry Section</h4>
        <div class="profile-frame">
            <div class="form-left">
                <label>Venue</label>
                <input type="text" name="venueNumber" value="{{ venueNumber_text }}" required>
            </div>
            <div class="form-middle">
                <label>Level</label>
                <select name="venueLevel" required>
                    <option value="" disabled selected>Level</option>
                    <option value="LEVEL 2">LEVEL 2</option>
                    <option value="LEVEL 3">LEVEL 3</option>
                    <option value="LEVEL 4">LEVEL 4</option>
                    <option value="LEVEL 5">LEVEL 5</option>
                    <option value="LEVEL 6">LEVEL 6</option>
                </select>
            </div>
            <div class="form-right">
                <label>Venue Capacity</label>
                <input type="number" name="venueCapacity" value="{{ venueCapacity_text }}" min="1" step="1" required>
            </div>
        </div>
        <input type="hidden" name="form_type" value="manual">
        <br><br>

        <!-- Upload Form Submit -->
        <div class="button-wrapper">
            <button type="submit">Add A New Venue</button>
        </div>
    </div>
</form>
{% endblock %}


{% block edit_section %}
<!-- Edit Form -->
<form id="editForm" action="{{ url_for('admin_manageVenue') }}" method="POST" enctype="multipart/form-data">
    <div id="editSection" class="function-frame">
        <h4 style="text-align: center;">Edit Existing Venue</h4>
        <div class="profile-frame">
            <div class="form-left">
                <label>Venue</label>
                <select name="editVenueNumber" id="editVenueNumber" required>
                    <option value="" disabled selected>Select Venue</option>
                    {% for v in venue_data %}
                        <option value="{{ v.venueNumber }}">{{ v.venueNumber }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-middle">   
                <label>Level</label>
                <select name="venueLevel" id="editVenueLevel" required>
                    <option value="" disabled selected>Level</option>
                    <option value="LEVEL 2">LEVEL 2</option>
                    <option value="LEVEL 3">LEVEL 3</option>
                    <option value="LEVEL 4">LEVEL 4</option>
                    <option value="LEVEL 5">LEVEL 5</option>
                    <option value="LEVEL 6">LEVEL 6</option>
                </select>
            </div>
            <div class="form-right">
                <label>Venue Capacity</label>
                <input type="number" name="venueCapacity" id="editVenueCapacity" min="1" step="1" required>
            </div>
        </div>
        <input type="hidden" name="form_type" value="edit">
        <br><br>

        <div class="button-wrapper" style="gap: 5%;">
            <button type="submit" name="action" value="update" style="background-color: #d4edda; color: #155724;">
                <i class="fas fa-check"></i> Update Venue
            </button>
            <button type="submit" name="action" value="delete" style="background-color: #f8d7da; color: #721c24;" onclick="return confirm('Are you sure to delete this venue?')">
                <i class="fas fa-trash"></i> Delete Venue
            </button>
        </div>
    </div>
</form>
{% endblock %}


{% block content %}
<div class="menu-section">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>List of Venue</h2>
        <div style="display: flex; align-items: center; gap: 10px;">
            <div style="position: relative;">
                <input type="text" id="searchInput" name="search_venue" placeholder="Search..." value="{{ search_venue }}" style="border-radius: 6px; width: 100%;">
                <i class="fa fa-search" id="searchBtn" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer;"></i>
            </div>
            <div class="button-wrapper">
                <button id="generatePDF" style="background-color: black;">Download as PDF</button>
            </div>
        </div>
    </div>
    <div id="noResults" style="display: none; text-align: center; margin-top: 10px; font-weight: bold; color: #b00;">No results found.</div>

    <div class="user-table-container">
        <table class="user-data-table" id="manageVenue"> 
            <thead>
                <tr>
                    <th>No</th>
                    <th>
                        <div class="dropdown-header">
                            Venue
                            <select id="filterVenue" class="header-dropdown">
                                <option value="">Venue</option>
                                {% for v in venue_data|map(attribute='venueNumber')|unique %}
                                    <option value="{{ v }}">{{ v }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </th>
                    <th>
                        <div class="dropdown-header">
                            Level
                            <select id="filterLevel" class="header-dropdown">
                                <option value="">Level</option>
                                <option value="LEVEL 2">LEVEL 2</option>
                                <option value="LEVEL 3">LEVEL 3</option>
                                <option value="LEVEL 4">LEVEL 4</option>
                                <option value="LEVEL 5">LEVEL 5</option>
                                <option value="LEVEL 6">LEVEL 6</option>
                            </select>
                        </div>
                    </th>
                    <th>
                        <div class="dropdown-header">
                            Venue Capacity
                            <select id="filterCapacity" class="header-dropdown">
                                <option value="">Capacity</option>
                                {% for v in venue_data|map(attribute='venueCapacity')|unique|sort %}
                                    <option value="{{ v }}">{{ v }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </th>
                    <th>Added/Edit Details</th>
                </tr>
            </thead>

            <tbody>
                {% for row in venue_data %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ row.venueNumber }}</td>
                    <td>{{ row.venueLevel }}</td>
                    <td>{{ row.venueCapacity }}</td>
                    <td>
                        {% if row.venueAddedBy and row.venueAddedOn %}
                            By: <strong>{{ row.addedBy.userName }}</strong> | On: <strong>{{ row.venueAddedOn.strftime('%d%b%Y %H:%M') }}</strong>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}   
<script>
// Function for edit ManageVenue
document.getElementById('editVenueNumber').addEventListener('change', function() {
    const venueNumber = this.value;
    if (!venueNumber) return;

    fetch(`/get_venue/${venueNumber}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }
            // Populate fields
            document.getElementById('editVenueLevel').value = data.venueLevel;
            document.getElementById('editVenueCapacity').value = data.venueCapacity;
        })
        .catch(err => console.error(err));
});

// Filter function
function filterTable() {
    const venueFilter = document.getElementById('filterVenue').value.toLowerCase();
    const levelFilter = document.getElementById('filterLevel').value.toLowerCase();
    const capacityFilter = document.getElementById('filterCapacity').value.toLowerCase();

    const table = document.querySelector('.user-data-table tbody');
    const rows = table.querySelectorAll('tr');

    rows.forEach(row => {
        const venue = row.cells[1].textContent.toLowerCase();
        const level = row.cells[2].textContent.toLowerCase();
        const capacity = row.cells[3].textContent.toLowerCase();

        const show = 
            (venueFilter === "" || venue.includes(venueFilter)) &&
            (levelFilter === "" || level.includes(levelFilter)) &&
            (capacityFilter === "" || capacity.includes(capacityFilter));

        row.style.display = show ? "" : "none";
    });
}

// Add event listeners for filtering
document.getElementById('filterVenue').addEventListener('change', filterTable);
document.getElementById('filterLevel').addEventListener('change', filterTable);
document.getElementById('filterCapacity').addEventListener('change', filterTable);


document.getElementById("generatePDF").addEventListener("click", function () {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({orientation: "landscape",unit: "pt",format: "a4"});
    const margin = 20;
    const pageWidth = doc.internal.pageSize.getWidth();

    // ===== Title =====
    doc.setFont("helvetica", "bold");
    doc.setFontSize(18);
    doc.text("List of Venue", pageWidth / 2, margin, { align: "center" });

    const startY = margin + 30;

    // ===== Prepare table data =====
    const table = document.querySelector(".user-data-table");
    if (!table) {
        alert("No table found to export!");
        return;
    }

    // Headers
    const headers = Array.from(table.querySelectorAll("thead th")).map(th => {
        const div = th.querySelector(".dropdown-header");
        return div ? div.childNodes[0].textContent.trim() : th.textContent.trim();
    });
    
    // Rows (only visible)
    const rows = Array.from(table.querySelectorAll("tbody tr")).filter(tr => tr.style.display !== "none")
        .map(tr => Array.from(tr.querySelectorAll("td")).map(td => td.textContent.trim()));

    // ===== Generate PDF table =====
    doc.autoTable({
        head: [headers],
        body: rows,
        startY: startY,
        theme: "grid",
        styles: {font: "helvetica", fontSize: 9, cellPadding: 4, overflow: "linebreak", valign: "middle", halign: "center"},
        headStyles: {fillColor: [33, 37, 41], textColor: 255, fontStyle: "bold"},
        tableWidth: "auto", // Auto-adjust columns based on content
        margin: { top: margin, left: margin, right: margin, bottom: margin },
        didDrawPage: function (data) {
            const pageCount = doc.internal.getNumberOfPages();
            const pageHeight = doc.internal.pageSize.height;
            doc.setFontSize(9);
            doc.setTextColor(100);
            doc.text(`Page ${pageCount}`, pageWidth - margin, pageHeight - 10, { align: "right" });
        }
    });

    doc.save("Admin_ViewVenueList.pdf");
});


</script>
{% endblock %}












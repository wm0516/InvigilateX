{% extends "admin/adminBase.html" %}
{% set show_tabs = true %}
{% set show_upload = false %}
{% set show_dashboard = false %}
{% set show_manual = true %}
{% set show_edit = true %}
{% block title %}Admin ManageVenue{% endblock %}
{% block head_title %}<h2>Manage Venue</h2>{% endblock %}

{% block manual_section %}
<!-- Manual Form -->
<form id="manualForm" action="{{ url_for('admin_manageVenue') }}" method="POST" enctype="multipart/form-data">
    <div id="manualSection" class="function-frame">
        <h4 style="text-align: center;">Manual Data Entry Section</h4>
        <div class="profile-frame">
            <div class="form-left">
                <label>Venue</label>
                <input type="text" name="venueNumber" value="{{ venueNumber_text }}" required>
            </div>
            <div class="form-middle">
                <label>Level</label>
                <select name="venueLevel" required>
                    <option value="" disabled selected>Level</option>
                    <option value="LEVEL 2">LEVEL 2</option>
                    <option value="LEVEL 3">LEVEL 3</option>
                    <option value="LEVEL 4">LEVEL 4</option>
                    <option value="LEVEL 5">LEVEL 5</option>
                    <option value="LEVEL 6">LEVEL 6</option>
                </select>
            </div>
            <div class="form-right">
                <label>Venue Capacity</label>
                <input type="number" name="venueCapacity" value="{{ venueCapacity_text }}" min="1" step="1" required>
            </div>
        </div>
        <input type="hidden" name="form_type" value="manual">
        <br><br>

        <!-- Upload Form Submit -->
        <div class="button-wrapper">
            <button type="submit">Add A New Venue</button>
        </div>
    </div>
</form>
{% endblock %}


{% block edit_section %}
<!-- Edit Form -->
<form id="editForm" action="{{ url_for('admin_manageVenue') }}" method="POST" enctype="multipart/form-data">
    <div id="editSection" class="function-frame">
        <h4 style="text-align: center;">Edit Existing Venue</h4>
        <div class="profile-frame">
            <div class="form-left">
                <label>Venue</label>
                <select name="editVenueNumber" id="editVenueNumber" required>
                    <option value="" disabled selected>Select Venue</option>
                    {% for v in venue_data %}
                        <option value="{{ v.venueNumber }}">{{ v.venueNumber }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-middle">   
                <label>Level</label>
                <select name="venueLevel" id="editVenueLevel" required>
                    <option value="" disabled selected>Level</option>
                    <option value="LEVEL 2">LEVEL 2</option>
                    <option value="LEVEL 3">LEVEL 3</option>
                    <option value="LEVEL 4">LEVEL 4</option>
                    <option value="LEVEL 5">LEVEL 5</option>
                    <option value="LEVEL 6">LEVEL 6</option>
                </select>
            </div>
            <div class="form-right">
                <label>Venue Capacity</label>
                <input type="number" name="venueCapacity" id="editVenueCapacity" min="1" step="1" required>
            </div>
        </div>
        <input type="hidden" name="form_type" value="edit">
        <br><br>

        <div class="button-wrapper" style="gap: 5%;">
            <button type="submit" name="action" value="update" style="background-color: #d4edda; color: #155724;">
                <i class="fas fa-check"></i> Update Venue
            </button>
            <button type="submit" name="action" value="delete" style="background-color: #f8d7da; color: #721c24;" onclick="return confirm('Are you sure to delete this venue?')">
                <i class="fas fa-trash"></i> Delete Venue
            </button>
        </div>
    </div>
</form>
{% endblock %}


{% block content %}
<div class="menu-section">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px solid #ccc; padding-bottom: 5px;">
        <h2 style="margin: 0;">List of Venue</h2>
        <div class="button-wrapper">
            <button id="generatePDF">Export Table to PDF</button>
        </div>
    </div>
    <div class="user-table-container">
        <table class="user-data-table"> 
            <thead>
                <tr>
                    <th>No</th>
                    <th>
                        <div class="dropdown-header">
                            Venue
                            <select id="filterVenue" class="header-dropdown">
                                <option value="">Venue</option>
                                {% for v in venue_data|map(attribute='venueNumber')|unique %}
                                    <option value="{{ v }}">{{ v }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </th>
                    <th>
                        <div class="dropdown-header">
                            Level
                            <select id="filterLevel" class="header-dropdown">
                                <option value="">Level</option>
                                <option value="LEVEL 2">LEVEL 2</option>
                                <option value="LEVEL 3">LEVEL 3</option>
                                <option value="LEVEL 4">LEVEL 4</option>
                                <option value="LEVEL 5">LEVEL 5</option>
                                <option value="LEVEL 6">LEVEL 6</option>
                            </select>
                        </div>
                    </th>
                    <th>
                        <div class="dropdown-header">
                            Venue Capacity
                            <select id="filterCapacity" class="header-dropdown">
                                <option value="">Capacity</option>
                                {% for v in venue_data|map(attribute='venueCapacity')|unique|sort %}
                                    <option value="{{ v }}">{{ v }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </th>
                </tr>
            </thead>

            <tbody>
                {% for row in venue_data %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ row.venueNumber }}</td>
                    <td>{{ row.venueLevel }}</td>
                    <td>{{ row.venueCapacity }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}


{% block extra_scripts %}   
<script>
// Function for edit ManageVenue
document.getElementById('editVenueNumber').addEventListener('change', function() {
    const venueNumber = this.value;
    if (!venueNumber) return;

    fetch(`/get_venue/${venueNumber}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }
            // Populate fields
            document.getElementById('editVenueLevel').value = data.venueLevel;
            document.getElementById('editVenueCapacity').value = data.venueCapacity;
        })
        .catch(err => console.error(err));
});

// Filter function
function filterTable() {
    const venueFilter = document.getElementById('filterVenue').value.toLowerCase();
    const levelFilter = document.getElementById('filterLevel').value.toLowerCase();
    const capacityFilter = document.getElementById('filterCapacity').value.toLowerCase();

    const table = document.querySelector('.user-data-table tbody');
    const rows = table.querySelectorAll('tr');

    rows.forEach(row => {
        const venue = row.cells[1].textContent.toLowerCase();
        const level = row.cells[2].textContent.toLowerCase();
        const capacity = row.cells[3].textContent.toLowerCase();

        const show = 
            (venueFilter === "" || venue.includes(venueFilter)) &&
            (levelFilter === "" || level.includes(levelFilter)) &&
            (capacityFilter === "" || capacity.includes(capacityFilter));

        row.style.display = show ? "" : "none";
    });
}

// Add event listeners
document.getElementById('filterVenue').addEventListener('change', filterTable);
document.getElementById('filterLevel').addEventListener('change', filterTable);
document.getElementById('filterCapacity').addEventListener('change', filterTable);

document.getElementById('generatePDF').addEventListener('click', () => {
    const { jsPDF } = window.jspdf;

    // Get current date
    const now = new Date();
    const options = { day: '2-digit', month: 'short', year: 'numeric' };
    const dateStr = now.toLocaleDateString('en-GB', options).replace(/ /g, '');
    
    // Filename: pageName_Date
    const filename = `manageVenue_${dateStr}.pdf`;

    // Get the table element
    const table = document.querySelector('.user-data-table');

    // Get header text from head_title block
    const headerText = document.querySelector('h2').textContent || "Manage Venue";

    html2canvas(table).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF('l', 'pt', 'a4'); // 'l' for landscape

        // Add header
        pdf.setFontSize(18);
        pdf.text(headerText, 40, 40); // X:40, Y:40

        // Calculate width and height for table image
        const pdfWidth = pdf.internal.pageSize.getWidth() - 40; // leave margin
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

        // Add table image slightly below header
        pdf.addImage(imgData, 'PNG', 20, 60, pdfWidth, pdfHeight); // Y:60 to leave space for header
        pdf.save(filename);
    });
});

</script>

{% endblock %}











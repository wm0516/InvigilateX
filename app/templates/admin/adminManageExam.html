{% extends "admin/adminBase.html" %}
{% set show_tabs = true %}
{% set show_upload = true %}
{% set show_cal = true %}
{% set show_dashboard = true %}
{% set show_manual = false %}
{% set show_edit = true %}
{% block title %}Admin ManageExam{% endblock %}
{% block head_title %}<h2>Manage Exam</h2>{% endblock %}

{% block dashboard_section %}
<form id="dashboardForm" action="{{ url_for('admin_manageExam') }}" method="POST">
    <div id="dashboardSection">
        <input type="hidden" name="form_type" value="dashboard">
        <div class="form-profile" style="width: 100%">
            <div class="dashboard-row">
                <div class="dashboard-frame">
                    <h3>Total Exams</h3>
                    <p class="dashboard-text" id="dashTotalExam">{{ exam_data|length }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Completed Exams</h3>
                    <p class="dashboard-text" style="color:blue;" id="dashCompleteExam">{{ exam_data|length - total_exam_activated - unassigned_exam }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Upcoming Exams</h3>
                    <p class="dashboard-text" style="color:green;" id="dashUpcomingExam">{{ total_exam_activated }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Unassigned Exam Details</h3>
                    <p class="dashboard-text" style="color:red;" id="dashUnassignedExam">{{ unassigned_exam }}</p>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block upload_section %}
<!-- Upload Form -->
<form id="uploadForm" action="{{ url_for('admin_manageExam') }}" method="POST" enctype="multipart/form-data">
    <div id="uploadSection" class="function-frame" style="width:80%">
        <div class="form-profile" style="width: 100%">
            <h4 style="text-align: center;">File Upload Section</h4>
            <label for="exam_list">
                <div class="upload-container" id="examUploadContainer">
                    <h4 style="text-align: center;">
                        Download the exam template <a href="{{ url_for('download_exam_template') }}"><i>HERE</i></a>
                    </h4><br>
                    <div class="upload-text">
                        Please upload a file with the <b>first row left empty</b>.  
                        Data should begin from columns <b>A to J</b>, with headers as follows:<br><br>
                        <i>[Exam Date, Day, Start, End, Program, Course Code/Section, Course Name, Lecturer, Total Student by venue, Venue]</i><br><br>
                        You may also download the exam template using the link above.<br><br>
                        Format: Date in <b>MM/DD/YYYY</b>, and Start & End times in <b>hh:mm:ss AM/PM</b> (e.g. 8:00:00 AM).
                        Click below to upload, or drag and drop a file (accepted formats: <b>XLSX, XLS, XLSM</b>).
                    </div><br>
                    <div id="examSelectedFileName" class="file-name-display"></div>
                </div>
            </label>
            <input type="file" id="exam_list" name="exam_file" accept=".xlsx,.xls,.xlsm" style="display: none;">
            <input type="hidden" name="form_type" value="upload">

            <div style="margin-top:20px; display: flex; gap: 30px; justify-content: center;">
                <div class="form-profile">
                    <label>Time to Release Automatically Assigned Exam Slots</label>
                    <input type="datetime-local" name="time_slot_share" required>
                </div>
                <div class="form-profile">
                    <label>Time to Open Unclaimed Exam Slots for Manual Selection</label>
                    <input type="datetime-local" name="time_slot_open" required>
                </div>
            </div>
            <br>
            <div class="button-wrapper">
                <button type="submit">Upload Exam</button>
            </div>
        </div>
    </div>
</form>
{% endblock %}  

{% block edit_section %}
<form id="editForm" action="{{ url_for('admin_manageExam') }}" method="POST">
    <div id="editSection" class="function-frame">
        <h4 style="text-align: center;">Edit Existing Exams</h4>
        <div class="profile-frame">
            <div class="form-profile">
                <label for="editExamCourseSection">Select Exam Course - Course Name</label>
                <select name="editExamCourseSection" id="editExamCourseSection" required>
                    <option value="" disabled selected>-- Select Course --</option>
                    {% for exam in edit_exam_data %}
                        {% if exam.course %}
                            <option value="{{ exam.course.courseCodeSectionIntake }}">
                                [{{ exam.course.courseCodeSectionIntake  }}] - {{ exam.course.courseName }}
                            </option>
                        {% else %}
                            <option value="" disabled>Unlinked exam (ID: {{ exam.examId }})</option>
                        {% endif %}
                    {% endfor %}
                </select><br>

                <label>Program Code</label>
                <input type="text" id="editProgramCode" name="programCode" readonly><br>
                
                <label>Number of Students</label>
                <input type="number" id="editStudent" name="student" value="" readonly>
            </div>

            <div class="form-profile">
                <div class="profile-frame" style="justify-content: space-between;">
                    <div class="form-profile" style="width: 48%;">
                        <label>Exam Start Date & Time</label>
                        <input type="datetime-local" id="editStartDateTime" name="startDateTime" required>
                    </div>
                    <div class="form-profile" style="width: 48%;">
                        <label>Exam End Date & Time</label>
                        <input type="datetime-local" id="editEndDateTime" name="endDateTime" required>
                    </div>
                </div><br>

                <label>Time to Release Automatically Assigned Exam Slots</label>
                <input type="datetime-local" id="examTimeExpire" name="examTimeExpire" required><br>
            
                <label>Time to Open Unclaimed Exam Slots for Manual Selection</label>
                <input type="datetime-local" id="examTimeCreate" name="examTimeCreate" required>
            </div>

            <div class="form-profile">
                <label>Exam Venues</label>
                <div id="venueContainer">
                    <div class="venue-item" style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                        <select name="venue[]" id="editVenue" class="venue-dropdown" required>
                            <option value="" disabled selected>-- Select Exam Venue --</option>
                            {% for venue in venue_data %}
                                <option value="{{ venue.venueNumber }}">[Capacity: {{ venue.venueCapacity }}] - {{ venue.venueNumber }}</option>
                            {% endfor %}
                        </select>

                        <!-- Input for number of students -->   
                        <input type="number" name="venueStudents[]" placeholder="Capacity" min="1" style="width: 100px;" required>

                        <button type="button" id="addVenueBtn" class="add-btn"
                            style="background-color: #28a745; color: white; border: none; border-radius: 5px; padding: 10px; font-size: large;">
                            +
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <input type="hidden" name="form_type" value="edit">
        <br><br>

        <div class="button-wrapper" style="gap: 5%;">
            <button type="submit" name="action" value="update" style="background-color: #d4edda; color: #155724;">
                <i class="fas fa-check"></i> Update Exam
            </button>
            <button type="submit" name="action" value="delete" style="background-color: #f8d7da; color: #721c24;" onclick="return confirm('Are you sure to delete this exam?')">
                <i class="fas fa-trash"></i> Delete Exam
            </button>
        </div>
    </div>
</form>
{% endblock %}

{% block content %}
<div class="menu-section">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>List of Exam</h2>
        <div style="display: flex; align-items: center; gap: 10px;">
            <div style="position: relative;">
                <input type="text" id="searchInput" name="search_exams" placeholder="Search..." value="{{ search_exams }}" style="border-radius: 6px; width: 100%;">
                <i class="fa fa-search" id="searchBtn" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer;"></i>
            </div>
            <div class="button-wrapper">
                <button id="generatePDF" style="background-color: black;">Download as PDF</button>
            </div>
        </div>
    </div>
    <div id="noResults" style="display: none; text-align: center; font-weight: bold; color: #b00;">No results found.</div>

    <div class="user-table-container">
        <table class="user-data-table" id="manageExam">
            <thead>
                <tr>
                    <th>No</th>
                    <th>Exam Status</th>
                    <th>Exam ID</th>
                    <th>Course Details</th>
                    <th>Exam Details</th>
                    <th>Invigilator Filter</th>
                </tr>
            </thead>    
            <tbody>
                {% for row in exam_data %}
                <tr class="
                    {% if not row.examStatus %}inactive-row-show
                    {% elif row.examStartTime is none %}error-row-show
                    {% endif %}">
                    <td class="row-number"></td>
                    <td>
                        {% if row.examStatus %}
                            <span class="status frame-completed">ONGOING</span>
                        {% else %}
                            <span class="status frame-expired">EXPIRED</span>
                        {% endif %}
                    </td>
                    <td>{{ row.examId }}</td>
                    <td>
                        <div class="info-grid">
                            <div>Course Name</div><div><strong>: {{ row.course.courseName }}</strong></div>
                            <div>Course Code/Section</div><div><strong>: {{ row.course.courseCodeSectionIntake }}</strong></div>
                            <div>Program Code</div><div><strong>: {{ row.course.courseDepartment }}</strong></div>
                            <div>Number of Students</div><div><strong>: {{ row.course.courseStudent }}</strong></div>
                            <div>Practical Lecturer</div><div><strong>: {{ row.course.practicalLecturer.userName if row.course.practicalLecturer else '<span>N/A</span>' | safe }}</strong></div>
                            <div>Tutorial Lecturer</div><div><strong>: {{ row.course.tutorialLecturer.userName if row.course.tutorialLecturer else  '<span>N/A</span>' | safe }}</strong></div>
                            <div>Class Lecturer</div><div><strong>: {{ row.course.classLecturer.userName if row.course.classLecturer else  '<span>N/A</span>' | safe }}</strong></div>
                        </div>
                    </td>
                    <td>
                        {% if row.examStartTime and row.examEndTime %}
                        <div class="info-grid">
                            <div>Exam Date</div><div><strong>: {{ row.examStartTime.strftime("%d%b%Y") }} - {{ row.examEndTime.strftime("%d%b%Y") }}</strong></div>
                            <div>Exam Day</div><div><strong>: {{ row.examStartTime.strftime("%A") }} - {{ row.examEndTime.strftime("%A") }}</strong></div>
                            <div>Exam Time</div><div><strong>: {{ row.examStartTime.strftime("%H:%M") }} - {{ row.examEndTime.strftime("%H:%M") }}</strong></div>
                            <div>Exam Period</div><div><strong>: {{ (row.examEndTime - row.examStartTime).seconds // 3600 }}h {{ ((row.examEndTime - row.examStartTime).seconds % 3600) // 60 }}m</strong></div>
                            <div>Exam Venues</div>
                            <div>
                                {% if row.venue_availabilities %}
                                    {% for va in row.venue_availabilities %}
                                        <strong>: {{ va.venueNumber }}</strong><br>
                                    {% endfor %}
                                {% else %}
                                    <strong>: None</strong>
                                {% endif %}
                            </div>
                        </div>
                        {% else %}
                        <span class="status frame-expired">Exam details not yet assigned</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if row.examOutput %}
                        <div class="info-grid">
                            <div>Total Academic Staff</div><div><strong>: {{ row.examOutput[0] }}</strong></div>
                            <div>Eligible Invigilation Staff</div><div><strong>: {{ row.examOutput[1] }}</strong></div>
                            <div>Flexible Invigilation Staff</div><div><strong>: {{ row.examOutput[2] }}</strong></div>
                            <div>Non-Flexible Invigilation Staff</div><div><strong>: {{ row.examOutput[3] }}</strong></div>
                            <div>Non-Flexible Staff List</div><div><strong>: {{ row.examOutput[4] }}</strong></div>
                            <div>Flexible Male Staff</div><div><strong>: {{ row.examOutput[5] }}</strong></div>
                            <div>Flexible Female Staff</div><div><strong>: {{ row.examOutput[6] }}</strong></div>
                        </div>
                        {% else %}None
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// =====================================================
// VENUE OPTIONS CACHE
// =====================================================
let venueOptionsHTML = "";

document.addEventListener("DOMContentLoaded", () => {
    const venueSelect = document.querySelector(".venue-dropdown");
    if (venueSelect) {
        venueOptionsHTML = Array.from(venueSelect.options)
            .map(opt => `<option value="${opt.value}">${opt.textContent}</option>`)
            .join("");
    }
});

// =====================================================
// EDIT FORM HELPERS
// =====================================================
function clearEditFields() {
    ["editProgramCode", "editStudent", "editStartDateTime", "editEndDateTime", "examTimeCreate", "examTimeExpire"]
        .forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = "";
        });

    document.getElementById("venueContainer").innerHTML = "";
}

function createVenueRow(venue = "", capacity = "", isFirst = false) {
    const container = document.getElementById("venueContainer");
    const div = document.createElement("div");
    div.className = "venue-item";
    div.style.cssText = "display:flex;align-items:center;gap:8px;margin-bottom:5px;";

    div.innerHTML = `
        <select name="venue[]" class="venue-dropdown" required>${venueOptionsHTML}</select>
        <input type="number" name="venueStudents[]" min="1" placeholder="Capacity"
               value="${capacity}" style="width:100px" required>
        <button type="button"
            class="${isFirst ? "addVenueBtn" : "removeVenueBtn"}"
            style="background:${isFirst ? "#28a745" : "#dc3545"};
                   color:white;border:none;border-radius:5px;
                   padding:10px;font-size:large;">
            ${isFirst ? "+" : "Ã—"}
        </button>
    `;

    container.appendChild(div);

    if (venue) div.querySelector("select").value = venue;

    if (isFirst) {
        div.querySelector(".addVenueBtn").onclick = () => {
            if (container.children.length >= 20) {
                alert("Maximum 20 venues allowed.");
                return;
            }
            createVenueRow("", "", false);
        };
    } else {
        div.querySelector(".removeVenueBtn").onclick = () => div.remove();
    }
}

function populateEditForm(data) {
    document.getElementById("editProgramCode").value = data.courseDepartment || "";
    document.getElementById("editStudent").value = data.totalStudents || "";

    if (data.examStartTime)
        document.getElementById("editStartDateTime").value = data.examVenues.startDateTime.slice(0,16);

    if (data.examEndTime)
        document.getElementById("editEndDateTime").value = data.examVenues.endDateTime.slice(0,16);

    if (data.examTimeCreate)
        document.getElementById("examTimeCreate").value = data.examTimeCreate.slice(0,16);

    if (data.examTimeExpire)
        document.getElementById("examTimeExpire").value = data.examTimeExpire.slice(0,16);

    const container = document.getElementById("venueContainer");
    container.innerHTML = "";

    if (data.examVenues?.length) {
        data.examVenues.forEach((v, i) =>
            createVenueRow(v.venueNumber, v.capacity, i === 0)
        );
    } else {
        createVenueRow("", "", true);
    }
}

// =====================================================
// LOAD EXAM INTO EDIT FORM
// =====================================================
document.addEventListener("DOMContentLoaded", () => {
    const select = document.getElementById("editExamCourseSection");
    if (!select) return;

    select.addEventListener("change", () => {
        clearEditFields();
        if (!select.value) return;

        fetch(`/get_exam_details/${encodeURIComponent(select.value)}`)
            .then(r => r.json())
            .then(d => d.error ? alert(d.error) : populateEditForm(d))
            .catch(e => console.error(e));
    });
});

// =====================================================
// DATETIME-LOCAL RESTRICTIONS (UPLOAD + EDIT)
// =====================================================
document.addEventListener("DOMContentLoaded", () => {
    function nowLocal() {
        const n = new Date();
        n.setSeconds(0,0);
        return n.toISOString().slice(0,16);
    }

    function enforceDateTime(start, end) {
        if (!start || !end) return;

        const now = nowLocal();
        start.min = now;
        end.min = now;

        start.addEventListener("change", () => {
            if (!start.value) return;
            end.min = start.value;

            if (end.value && new Date(end.value) <= new Date(start.value)) {
                const fix = new Date(start.value);
                fix.setMinutes(fix.getMinutes() + 1);
                end.value = fix.toISOString().slice(0,16);
            }
        });

        end.addEventListener("change", () => {
            if (new Date(end.value) <= new Date(start.value)) {
                alert("End time must be AFTER start time.");
                end.value = "";
            }
        });
    }

    // ===== Upload form =====
    enforceDateTime(
        document.querySelector("input[name='time_slot_share']"),
        document.querySelector("input[name='time_slot_open']")
    );

    // Exam duration
    enforceDateTime(
        document.getElementById("editStartDateTime"),
        document.getElementById("editEndDateTime")
    );

    // Slot timing
    enforceDateTime(
        document.getElementById("examTimeExpire"),
        document.getElementById("examTimeCreate")
    );
});

// =====================================================
// UPLOAD FORM FINAL VALIDATION
// =====================================================
document.getElementById("uploadForm")?.addEventListener("submit", e => {
    const share = document.querySelector("input[name='time_slot_share']").value;
    const open  = document.querySelector("input[name='time_slot_open']").value;

    if (!share || !open || new Date(open) <= new Date(share)) {
        alert("Please ensure Open Time is AFTER Share Time.");
        e.preventDefault();
    }
});

// -------------------------
// PDF Export
// -------------------------
document.addEventListener("DOMContentLoaded", function () {
    const generateBtn = document.getElementById("generatePDF");
    if (!generateBtn) return;

    generateBtn.addEventListener("click", function () {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({orientation: "landscape",unit: "pt",format: "a4"});
        const margin = 20;
        const pageWidth = doc.internal.pageSize.getWidth();
        const nowMY = new Date().toLocaleString("en-GB", {timeZone: "Asia/Kuala_Lumpur", day: "2-digit", month: "short", year: "numeric", hour: "2-digit", minute: "2-digit", hour12: true});
        
        // ===== Title =====
        doc.setFont("helvetica", "bold");
        doc.setFontSize(18);
        doc.text("Admin View - Exams Download", pageWidth / 2, margin, { align: "center" });

        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);
        doc.text(`Downloaded on: ${nowMY}`, pageWidth / 2, margin + 18, { align: "center" });
        const startY = margin + 25;

        // ===== Prepare table data manually (to preserve readable formatting) =====
        const table = document.querySelector(".user-data-table");
        if (!table) {
            alert("No table found to export!");
            return;
        }

        const headers = Array.from(table.querySelectorAll("thead th")).map(th => th.textContent.trim());
        const rows = Array.from(table.querySelectorAll("tbody tr"))
            .filter(tr => tr.offsetParent !== null)
            .map(tr => {
                return Array.from(tr.querySelectorAll("td")).map(td => {

                    // ===== Normalize grid text (IMPORTANT FIX) =====
                    let text = td.innerText
                        .replace(/\n\s*:\s*/g, " : ")
                        .replace(/\n{2,}/g, "\n")
                        .trim();

                    // ===== Only format detail columns =====
                    if ([3, 4, 5, 6, 7].includes(td.cellIndex)) {
                        text = text
                            // ===== Course Details =====
                            .replace(/Course Name\s*:/g, "Course Name:")
                            .replace(/Course Code\/Section\s*:/g, "Course Code/Section:")
                            .replace(/Program Code\s*:/g, "Program Code:")
                            .replace(/Number of Students\s*:/g, "Number of Students:")
                            .replace(/Practical Lecturer\s*:/g, "Practical Lecturer:")
                            .replace(/Tutorial Lecturer\s*:/g, "Tutorial Lecturer:")
                            .replace(/Class Lecturer\s*:/g, "Class Lecturer:")

                            // ===== Exam Details =====
                            .replace(/Exam Date\s*:/g, "Exam Date:")
                            .replace(/Exam Day\s*:/g, "Exam Day:")
                            .replace(/Exam Time\s*:/g, "Exam Time:")
                            .replace(/Exam Period\s*:/g, "Exam Period:")
                            .replace(/Exam Invigilators\s*:/g, "Exam Invigilators:")
                            .replace(/Exam Venues\s*:/g, "Exam Venues:")

                            // ===== Invigilator Filter (FIXED LABELS) =====
                            .replace(/Total Academic Staff\s*:/g, "Total Academic Staff:")
                            .replace(/Eligible Invigilation Staff\s*:/g, "Eligible Invigilation Staff:")
                            .replace(/Flexible Invigilation Staff\s*:/g, "Flexible Invigilation Staff:")
                            .replace(/Non-Flexible Invigilation Staff\s*:/g, "Non-Flexible Invigilation Staff:")
                            .replace(/Non-Flexible Staff List\s*:/g, "Non-Flexible Staff List:")
                            .replace(/Flexible Male Staff\s*:/g, "Flexible Male Staff:")
                            .replace(/Flexible Female Staff\s*:/g, "Flexible Female Staff:");
                    }
                    return text;
                });
            });


        // ===== Generate AutoTable =====
        doc.autoTable({
            head: [headers],
            body: rows,
            startY: startY,
            theme: "grid",
            styles: {font: "helvetica", fontSize: 8, cellPadding: 4, overflow: "linebreak", valign: "top", cellWidth: "wrap"},
            columnStyles: {3: { cellWidth: 200 }, 4: { cellWidth: 180 }, 5: { cellWidth: 130 }, 7: { cellWidth: 90 }},
            headStyles: {fillColor: [33, 37, 41], textColor: [255, 255, 255], halign: "center"},
            margin: { top: margin, left: margin, right: margin, bottom: margin },
            didDrawPage: function () {
                const pageCount = doc.internal.getNumberOfPages();
                const pageHeight = doc.internal.pageSize.height;
                doc.setFontSize(9);
                doc.setTextColor(100);
                doc.text(`Page ${pageCount}`, pageWidth - margin, pageHeight - 10, { align: "right" });
            }
        });

        // ===== Save =====
        doc.save(`Admin_ExamList.pdf`);
    });
});

document.getElementById("uploadForm").addEventListener("submit", function (event) {
    const timeShare = document.querySelector("input[name='time_slot_share']").value;
    const timeOpen = document.querySelector("input[name='time_slot_open']").value;

    if (!timeShare || !timeOpen) {
        alert("Please fill in both date-time slots.");
        event.preventDefault();
        return;
    }

    if (new Date(timeOpen) <= new Date(timeShare)) {
        alert("Time to open unselected slots must be *after* time to distribute slots.");
        event.preventDefault();
    }
});

function renumberVisibleRowsExam() {
    const rows = document.querySelectorAll("#manageExam tbody tr");
    let index = 1;
    rows.forEach(row => {
        if (row.offsetParent !== null) {
            const cell = row.querySelector("td.row-number");
            if (cell) {
                cell.textContent = index++;
            }
        }
    });
}

let examDashboardInitialized = false;
function updateExamDashboardFromTable() {
    const rows = document.querySelectorAll("#manageExam tbody tr");
    const visibleRows = [...rows].filter(r => r.style.display !== "none");
    let total = 0;
    let upcoming = 0;
    let completed = 0;
    let unassigned = 0;

    visibleRows.forEach(r => {
        total++;

        if (r.classList.contains("error-row-show")) {
            unassigned++;
        } else {
            const status = r.children[1].innerText.trim();
            if (status === "ONGOING") {
                upcoming++;
            } else {
                completed++;
            }
        }
    });
    document.getElementById("dashTotalExam").textContent = total;
    document.getElementById("dashUpcomingExam").textContent = upcoming;
    document.getElementById("dashCompleteExam").textContent = completed;
    document.getElementById("dashUnassignedExam").textContent = unassigned;
}


document.addEventListener("DOMContentLoaded", () => {
    initIntakeSwipe({
        tableId: "manageExam",
        intakeCol: 3,          // Course Details column
        noResultsId: "noResults",
        dashboardUpdater: updateExamDashboardFromTable
    });
    renumberVisibleRowsExam();
    updateExamDashboardFromTable();
});

window.addEventListener("load", () => {
    renumberVisibleRows();
    updateExamDashboardFromTable();
});
</script>
{% endblock %}


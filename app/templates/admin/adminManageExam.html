{% extends "admin/adminBase.html" %}
{% set show_tabs = true %}
{% set show_upload = true %}
{% set show_dashboard = true %}
{% set show_manual = false %}
{% set show_edit = true %}
{% block title %}Admin ManageExams{% endblock %}
{% block head_title %}<h2>Manage Exams</h2>{% endblock %}

{% block dashboard_section %}
<form id="dashboardForm" action="{{ url_for('admin_manageExam') }}" method="POST">
    <div id="dashboardSection">
        <input type="hidden" name="form_type" value="dashboard">
        <div class="form-left" style="width: 100%">
            <div class="dashboard-row">
                <div class="dashboard-frame">
                    <h3>Total Exams</h3>
                    <p class="dashboard-text">{{ exam_data|length }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Completed Exams</h3>
                    <p class="dashboard-text" style="color:blue;">{{ exam_data|length - total_exam_activated }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Upcoming Exams</h3>
                    <p class="dashboard-text" style="color:green;">{{ total_exam_activated }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Unassigned Exam Details</h3>
                    <p class="dashboard-text" style="color:red;">{{ unassigned_exam }}</p>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block upload_section %}
<!-- Upload Form -->
<form id="uploadForm" action="{{ url_for('admin_manageExam') }}" method="POST" enctype="multipart/form-data">
    <div id="uploadSection" class="function-frame" style="width:80%">
        <div class="form-left" style="width: 100%">
            <h4 style="text-align: center;">File Upload Section</h4>
            <label for="exam_list">
                <div class="upload-container" id="examUploadContainer">
                    <h4 style="text-align: center;">
                        Download the exam template <a href="{{ url_for('download_exam_template') }}"><i>HERE</i></a>
                    </h4><br>
                    <div class="upload-text">
                        Please upload a file with the <b>first row left empty</b>.  
                        Data should begin from columns <b>A to I</b>, with headers as follows:<br><br>
                        <i>['Date', 'Day', 'Start', 'End', 'Program', 'Course/Section', 'Lecturer', 'No. of Students', 'Room']</i><br><br>
                        You may also download the exam template using the link above.<br><br>
                        Format: Date in <b>MM/DD/YYYY</b> format, and Start & End times in <b>hh:mm:ss AM/PM</b> format (e.g. 8:00:00 AM).<br><br>
                        Click below to upload, or drag and drop a file (accepted formats: <b>XLSX, XLS, XLSM</b>).
                    </div><br>
                    <div id="examSelectedFileName" class="file-name-display"></div>
                </div>
            </label>
            <input type="file" id="exam_list" name="exam_file" accept=".xlsx,.xls,.xlsm" style="display: none;">
            <input type="hidden" name="form_type" value="upload">
            <br>
            <div class="button-wrapper">
                <button type="submit">Upload Exam</button>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block edit_section %}
<form id="editForm" action="{{ url_for('admin_manageExam') }}" method="POST">
    <div id="editSection" class="function-frame">
        <h4 style="text-align: center;">Edit Existing Exams</h4>
        <div class="profile-frame">
            <div class="form-left">
                <label for="editExamCourseSection">Select Exam Course/Section - Course Name</label>
                <select name="editExamCourseSection" id="editExamCourseSection" required>
                    <option value="" disabled selected>Select Course Section</option>
                    {% for exam in display_exam_data %}
                        {% if exam.course %}
                            <option value="{{ exam.course.courseCodeSectionIntake }}">
                                [{{ exam.course.courseCodeSectionIntake }}] - {{ exam.course.courseName }}
                            </option>
                        {% else %}
                            {# optional: show a disabled placeholder for exams without a linked course #}
                            <option value="" disabled>Unlinked exam (ID: {{ exam.examId }})</option>
                        {% endif %}
                    {% endfor %}
                </select><br>

                <label>Program Code</label>
                <input type="text" id="editProgramCode" name="programCode" readonly><br>

                <label>Number of Students</label>
                <input type="number" id="editStudent" name="student" value="" readonly><br>
            </div>

            <div class="form-middle">
                <label>Practical Lecturer</label>
                <input type="text" id="editPracticalLecturer" name="practicalLecturer" readonly><br>

                <label>Tutorial Lecturer</label>
                <input type="text" id="editTutorialLecturer" name="tutorialLecturer" readonly><br>

                <label>Number of Invigilators</label>
                <input type="number" id="editInvigilatorNo" name="invigilatorNo" value="" min="1" step="1" required>
            </div>

            <div class="form-right">
                <label>Exam Start Date & Time</label>
                <div style="display: flex; gap: 2%;">
                    <input type="date" id="startDate" name="startDate" required>
                    <input type="time" id="startTime" name="startTime" required>
                </div><br>

                <label>Exam End Date & Time</label>     
                <div style="display: flex; gap: 2%;">
                    <input type="date" id="endDate" name="endDate" required>
                    <input type="time" id="endTime" name="endTime" required>
                </div><br>

                <label>Exam Venue(s)</label>
                <div id="venueContainer">
                    <div class="venue-item" style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                        <select name="venue[]" id="editVenue" class="venue-dropdown" required>
                            <option value="" disabled selected>Select Exam Venue</option>
                            {% for venue in venue_data %}
                                <option value="{{ venue.venueNumber }}">[Capacity: {{ venue.venueCapacity }}] - {{ venue.venueNumber }}</option>
                            {% endfor %}
                        </select>
                        <button type="button" id="addVenueBtn" class="add-btn" 
                                style="background-color: #28a745; color: white; border: none; border-radius: 5px; padding: 5px 10px;">
                            +
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <input type="hidden" name="form_type" value="edit">
        <br><br>

        <div class="button-wrapper" style="gap: 5%;">
            <button type="submit" name="action" value="update" style="background-color: #d4edda; color: #155724;">
                <i class="fas fa-check"></i> Update Exam
            </button>
            <button type="submit" name="action" value="delete" style="background-color: #f8d7da; color: #721c24;"
                    onclick="return confirm('Are you sure to delete this exam?')">
                <i class="fas fa-trash"></i> Delete Exam
            </button>
        </div>
    </div>
</form>
{% endblock %}

{% block content %}
<div class="menu-section">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>List of Exams</h2>
        <div class="button-wrapper">
            <button id="generatePDF" style="background-color: black;">Download as PDF</button>
        </div>
    </div>

    <div class="user-table-container">
        <table class="user-data-table">
            <thead>
                <tr>
                    <th>No</th>
                    <th>Exam Status</th>
                    <th>Course Details</th>
                    <th>Exam ID</th>
                    <th>Exam Details</th>
                    <th>Number of Invigilators</th>
                </tr>
            </thead>    
            <tbody>
                {% for row in exam_data %}
                <tr class="
                    {% if not row.examStatus %}inactive-row-show
                    {% elif row.examStartTime is none %}error-row-show
                    {% endif %}">
                    <td>{{ loop.index }}</td>
                    <td>
                        {% if row.examStatus %}
                            <span class="status frame-completed">ONGOING</span>
                        {% else %}
                            <span class="status frame-expired">EXPIRED</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="info-grid">
                            <div>Course Name</div><div><strong>: {{ row.course.courseName }}</strong></div>
                            <div>Course Code/Section</div><div><strong>: {{ row.course.courseCodeSectionIntake }}</strong></div>
                            <div>Program Code</div><div><strong>: {{ row.course.courseDepartment }}</strong></div>
                            <div>Number of Students</div><div><strong>: {{ row.course.courseStudent }}</strong></div>
                            <div>Practical Lecturer</div><div><strong>: {{ row.course.practicalLecturer.userName if row.course.practicalLecturer else '<span>N/A</span>' | safe }}</strong></div>
                            <div>Tutorial Lecturer</div><div><strong>: {{ row.course.tutorialLecturer.userName if row.course.tutorialLecturer else  '<span>N/A</span>' | safe }}</strong></div>
                        </div>
                    </td>
                    <td>{{ row.examId }}</td>
                    <td>
                        {% if row.examStartTime and row.examEndTime %}
                        <div class="info-grid">
                            <div>Exam Date</div><div><strong>: {{ row.examStartTime.strftime("%d/%b/%Y") }} - {{ row.examEndTime.strftime("%d/%b/%Y") }}</strong></div>
                            <div>Exam Day</div><div><strong>: {{ row.examStartTime.strftime("%A") }} - {{ row.examEndTime.strftime("%A") }}</strong></div>
                            <div>Exam Time</div><div><strong>: {{ row.examStartTime.strftime("%H:%M") }} - {{ row.examEndTime.strftime("%H:%M") }}</strong></div>
                            <div>Exam Period</div><div><strong>: {{ (row.examEndTime - row.examStartTime).seconds // 3600 }}h {{ ((row.examEndTime - row.examStartTime).seconds % 3600) // 60 }}m</strong></div>
                            <div>Exam Venue(s)</div>
                            <div>
                                {% if row.venue_availabilities %}
                                    {% for va in row.venue_availabilities %}
                                        <strong>: {{ va.venueNumber }} (Capacity: {{ va.capacity }})</strong><br>
                                    {% endfor %}
                                {% else %}
                                    <strong>: N/A</strong>
                                {% endif %}
                            </div>
                        </div>
                        {% else %}
                        <span class="status frame-expired">Exam details not yet assigned</span>
                        {% endif %}
                    </td>
                    <td>{{ row.examNoInvigilator }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}


{% block extra_scripts %}
<script>
// Clear edit form fields when course changes
function clearEditFields() {
    const fieldsToClear = ['editProgramCode', 'editStudent', 'editVenue', 'editInvigilatorNo', 'startDate', 'startTime', 'endDate', 'endTime', 'editPracticalLecturer', 'editTutorialLecturer'];
    fieldsToClear.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) field.value = '';
    });
}

// Populate edit form when course data is loaded
function populateEditForm(data) {
    document.getElementById('editProgramCode').value = data.courseDepartment || '';
    document.getElementById('editStudent').value = data.courseStudent || '';
    document.getElementById('editVenue').value = data.examVenues.join(', ') || '';
    document.getElementById('editInvigilatorNo').value = data.examNoInvigilator || '';

    // split datetime for inputs
    if (data.examStartTime) {
        const [date, time] = data.examStartTime.split('T');
        document.getElementById('startDate').value = date;
        document.getElementById('startTime').value = time;
    }
    if (data.examEndTime) {
        const [date, time] = data.examEndTime.split('T');
        document.getElementById('endDate').value = date;
        document.getElementById('endTime').value = time;
    }

    document.getElementById('editPracticalLecturer').value = data.practicalLecturer || '';
    document.getElementById('editTutorialLecturer').value = data.tutorialLecturer || '';
}

document.addEventListener("DOMContentLoaded", function() {
    const courseSelect = document.getElementById("editExamCourseSection");

    if (courseSelect) {
        courseSelect.addEventListener("change", function() {
            const selectedValue = this.value;
            clearEditFields();

            if (!selectedValue) return;

            // Fetch exam details from backend
            fetch(`/get_exam_details/${encodeURIComponent(selectedValue)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                    } else {
                        populateEditForm(data);
                    }
                })
                .catch(err => {
                    console.error("Error fetching exam details:", err);
                });
        });
    }
});


// ==============================
// Admin Manage Exam Page: Date/Time Restrictions
// ==============================
document.addEventListener("DOMContentLoaded", function () {
    const startDate = document.getElementById("startDate");
    const startTime = document.getElementById("startTime");
    const endDate = document.getElementById("endDate");
    const endTime = document.getElementById("endTime");

    if (!startDate || !startTime || !endDate || !endTime) return;

    const now = new Date();
    const today = now.toISOString().split("T")[0];
    const nextYear = new Date(now);
    nextYear.setFullYear(nextYear.getFullYear() + 1);
    const nextYearDate = nextYear.toISOString().split("T")[0];

    // Restrict date pickers
    startDate.min = today;
    startDate.max = nextYearDate;
    endDate.min = today;
    endDate.max = nextYearDate;

    // Default: set both dates to today
    startDate.value = today;
    endDate.value = today;

    // Restrict time: disable past times if today is selected
    function restrictStartTime() {
        if (startDate.value === today) {
            let hh = String(now.getHours()).padStart(2, "0");
            let mm = String(now.getMinutes()).padStart(2, "0");
            startTime.min = hh + ":" + mm;  // from now onwards
        } else {
            startTime.min = "00:00";  // full day allowed
        }
    }

    function restrictEndTime() {
        if (endDate.value === today) {
            let hh = String(now.getHours()).padStart(2, "0");
            let mm = String(now.getMinutes()).padStart(2, "0");
            endTime.min = hh + ":" + mm;
        } else {
            endTime.min = "00:00";
        }
    }

    // Adjust end date automatically
    function adjustEndDate() {
        if (!startDate.value || !startTime.value || !endTime.value) return;

        const start = new Date(startDate.value + "T" + startTime.value);
        let end = new Date(endDate.value + "T" + endTime.value);

        // If end time is earlier than start time → assume overnight
        if (end < start) {
            let nextDay = new Date(start);
            nextDay.setDate(nextDay.getDate() + 1);
            endDate.value = nextDay.toISOString().split("T")[0];
        } else {
            endDate.value = startDate.value;
        }
    }

    // Bind events
    startDate.addEventListener("change", () => {
        endDate.value = startDate.value;
        restrictStartTime();
        restrictEndTime();
    });

    endDate.addEventListener("change", restrictEndTime);
    startTime.addEventListener("change", adjustEndDate);
    endTime.addEventListener("change", adjustEndDate);

    // Initial restriction setup
    restrictStartTime();
    restrictEndTime();
});


document.addEventListener("DOMContentLoaded", function () {
    const generateBtn = document.getElementById("generatePDF");
    if (!generateBtn) return;

    generateBtn.addEventListener("click", function () {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({orientation: "landscape",unit: "pt",format: "a4"});
        const margin = 20;
        const pageWidth = doc.internal.pageSize.getWidth();

        // ===== Title =====
        doc.setFont("helvetica", "bold");
        doc.setFontSize(18);
        doc.text("Manage Exam", pageWidth / 2, margin, { align: "center" });

        const startY = margin + 25;

        // ===== Prepare table data manually (to preserve readable formatting) =====
        const table = document.querySelector(".user-data-table");
        if (!table) {
            alert("No table found to export!");
            return;
        }

        const headers = Array.from(table.querySelectorAll("thead th")).map(th => th.textContent.trim());
        const rows = Array.from(table.querySelectorAll("tbody tr")).map(tr => {
            const cells = Array.from(tr.querySelectorAll("td")).map(td => {
                let text = td.innerText.trim();

                // Fix multi-line readability
                text = text.replace(/\s*\n\s*/g, " ");

                // Add newlines before each field label, not after colon
                if (td.cellIndex === 2 || td.cellIndex === 4) {
                    text = text
                        .replace(/\s*Course Name\s*:/g, "\nCourse Name:") 
                        .replace(/\s*Course Code\/Section\s*:/g, "\nCourse Code/Section:")
                        .replace(/\s*Program Code\s*:/g, "\nProgram Code:")
                        .replace(/\s*Number of Students\s*:/g, "\nNumber of Students:")
                        .replace(/\s*Practical Lecturer\s*:/g, "\nPractical Lecturer:")
                        .replace(/\s*Tutorial Lecturer\s*:/g, "\nTutorial Lecturer:")
                        .replace(/\s*Exam Date\s*:/g, "\nExam Date:")
                        .replace(/\s*Exam Day\s*:/g, "\nExam Day:")
                        .replace(/\s*Exam Time\s*:/g, "\nExam Time:")
                        .replace(/\s*Exam Period\s*:/g, "\nExam Period:")
                        .replace(/\s*Exam Venue\s*:/g, "\nExam Venue:");

                    // Clean up possible leading newline
                    text = text.trimStart();
                }

                return text;
            });
            return cells;
        });

        // ===== Generate AutoTable =====
        doc.autoTable({
            head: [headers],
            body: rows,
            startY: startY,
            theme: "grid",
            tableWidth: "auto",
            styles: {font: "helvetica", fontSize: 9, cellPadding: 4, overflow: "linebreak", valign: "middle"},
            headStyles: {fillColor: [33, 37, 41], textColor: [255, 255, 255], halign: "center"},
            margin: { top: margin, left: margin, right: margin, bottom: margin },
            didDrawPage: function (data) {
                const pageCount = doc.internal.getNumberOfPages();
                const pageHeight = doc.internal.pageSize.height;
                doc.setFontSize(9);
                doc.setTextColor(100);
                doc.text(`Page ${pageCount}`, pageWidth - margin, pageHeight - 10, { align: "right" });
            },
        });

        // ===== Save =====
        doc.save("Admin_ViewExamList.pdf");
    });
});

document.addEventListener("DOMContentLoaded", function () {
    const venueContainer = document.getElementById("venueContainer");
    const addVenueBtn = document.getElementById("addVenueBtn");

    if (!venueContainer || !addVenueBtn) return;

    addVenueBtn.addEventListener("click", function () {
        const currentVenues = venueContainer.querySelectorAll(".venue-item");
        if (currentVenues.length >= 20) {
            alert("You can only add up to 20 venues.");
            return;
        }

        const newVenueDiv = document.createElement("div");
        newVenueDiv.classList.add("venue-item");
        newVenueDiv.style.display = "flex";
        newVenueDiv.style.alignItems = "center";
        newVenueDiv.style.gap = "8px";
        newVenueDiv.style.marginBottom = "5px";

        newVenueDiv.innerHTML = `
            <select name="venue[]" class="venue-dropdown" required>
                <option value="" disabled selected>Select Exam Venue</option>
                ${Array.from(document.querySelectorAll(".venue-dropdown")[0].options)
                    .map(opt => `<option value="${opt.value}">${opt.textContent}</option>`)
                    .join("")}
            </select>
            <button type="button" class="removeVenueBtn" 
                    style="background-color: #dc3545; color: white; border: none; border-radius: 5px; padding: 5px 10px;">
                &times;
            </button>
        `;

        venueContainer.appendChild(newVenueDiv);

        // Add remove functionality
        const removeBtn = newVenueDiv.querySelector(".removeVenueBtn");
        removeBtn.addEventListener("click", () => newVenueDiv.remove());
    });
});
</script>
{% endblock %}










{% extends "admin/adminBase.html" %}
{% set show_tabs = true %}
{% set show_upload = true %}
{% set show_dashboard = true %}
{% set show_manual = true %}
{% set show_edit = true %}
{% block title %}Admin ManageExam{% endblock %}
{% block head_title %}<h2>Manage Exam</h2>{% endblock %}

{% block dashboard_section %}
<form id="dashboardForm" action="{{ url_for('admin_manageExam') }}" method="POST">
    <div id="dashboardSection" style="width: 90%; margin:auto;">
        <input type="hidden" name="form_type" value="dashboard">
        <div class="form-left" style="width: 100%">

            <!-- Overview -->
            <div class="dashboard-row">
                <div class="dashboard-frame">
                    <h3>Total Exams</h3>
                    <p class="dashboard-text">{{ total_exam }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Completed Exams</h3>
                    <p class="dashboard-text" style="color:green;">{{ exam_with_complete }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Incomplete Exams</h3>
                    <p class="dashboard-text" style="color:red;">{{ total_exam - exam_with_complete - error_rows }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Unassigned Exams</h3>
                    <p class="dashboard-text" style="color:red;">{{ error_rows }}</p>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}



{% block upload_section %}
<!-- Upload Form -->
<form id="uploadForm" action="{{ url_for('admin_manageExam') }}" method="POST" enctype="multipart/form-data">
    <div id="uploadSection" class="function-frame">
        <div class="form-left" style="width: 100%">
            <h4 style="text-align: center;">File Upload Section</h4>
            <label for="exam_list">
                <div class="upload-container" id="examUploadContainer">
                    <div class="upload-text">
                        Upload a file with an empty first row. Data should start from columns A to J,<br> 
                        labeled as: ['Date', 'Day', 'Start', 'End', 'Program', 'Course/Sec', 'Practical Lecturer', 'Tutorial Lecturer', 'No of', 'Room']<br><br><br>
                        Click to upload or drag and drop with below file format
                    </div>
                    <div class="file-types">XLSX, XLS, or XLSM</div><br>
                    <!-- Selected file display -->
                    <div id="examSelectedFileName" class="file-name-display"></div>
                </div>
            </label>
            <input type="file" id="exam_list" name="exam_file" accept=".xlsx,.xls,.xlsm" style="display: none;">
            <!-- ðŸ”½ Add this hidden input here -->
            <input type="hidden" name="form_type" value="upload">
            <br>

            <!-- Upload Form Submit -->
            <div class="button-wrapper">
                <button type="submit">Upload Exam</button>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block manual_section %}
<!-- Manual Form -->
<form id="manualForm" action="{{ url_for('admin_manageExam') }}" method="POST" enctype="multipart/form-data">
    <div id="manualSection" class="function-frame" style="width:100%">
        <h4 style="text-align: center;">Manual Data Entry Section</h4>
        <div class="profile-frame">
            <div class="form-left" style="margin: auto;">
                <label>Exam Start Date & Time</label>
                <div style="display: flex; gap: 2%;">
                    <input type="date" id="startDate" name="startDate" required>
                    <input type="time" id="startTime" name="startTime" required>
                </div><br>

                <label>Exam End Date & Time</label>
                <div style="display: flex; gap: 2%;">
                    <input type="date" id="endDate" name="endDate" required>
                    <input type="time" id="endTime" name="endTime" required>
                </div><br>

                <label>Program Code</label>
                <select name="programCode" id="programCode" required>
                    <option value="" disabled selected>Select Program Code</option>
                    {% for dept in department_data %}
                        <option value="{{ dept.departmentCode }}">
                            [{{ dept.departmentCode }}] {{ dept.departmentName }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-middle" style="margin: auto;">
                <label>Course/Section</label>
                <select name="courseSection" id="courseSection" required>
                    <option value="" disabled selected>Select Course Section</option>
                    <!-- This will be populated dynamically by JavaScript -->
                </select><br>

                <label>Course Practical Lecturer</label>
                <input type="text" id="practicalLecturer" name="practicalLecturer" readonly><br>

                <label>Course Tutorial Lecturer</label>
                <input type="text" id="tutorialLecturer" name="tutorialLecturer" readonly>
            </div> 

            <div class="form-right" style="margin: auto;">
                <label>Number of Students</label>
                <input type="number" id="student" name="student" readonly><br>

                <label>Venue</label>
                <select name="venue" id="venueSection" required>
                    <option value="" disabled selected>Select Venue</option>
                    {% for venue in venue_data %}
                        <option value="{{ venue.venueNumber }}">
                            [Capacity: {{ venue.venueCapacity }}] - {{ venue.venueNumber }}
                        </option>
                    {% endfor %}
                </select><br>

                <label>Number of Invigilators</label>
                <input type="number" id="invigilatorNo" name="invigilatorNo" value="1" min="1" step="1" required>    
            </div>
        </div>

        <input type="hidden" name="form_type" value="manual">
        <br><br>

        <div class="button-wrapper">
            <button type="submit">Add New Exam</button>
        </div>
    </div>
</form>
{% endblock %}


{% block edit_section %}
<form id="editForm" action="{{ url_for('admin_manageExam') }}" method="POST">
    <div id="editSection" class="function-frame" style="width:100%">
        <h4 style="text-align: center;">Edit Existing Exam</h4>

        <!-- DEBUG: Show what's in exam_data -->
        <div style="background: #f0f0f0; padding: 10px; margin: 10px 0;">
            <strong>DEBUG: exam_data contents</strong>
            {% for exam in exam_data %}
                <div>Exam {{ loop.index }}: 
                    ID: {{ exam.examId }}, 
                    Course: {% if exam.course %}{{ exam.course.courseCodeSection }}{% else %}NO COURSE{% endif %},
                    Start: {{ exam.examStartTime }},
                    End: {{ exam.examEndTime }}
                </div>
            {% endfor %}
        </div>

        <div class="profile-frame">
            <div class="form-left">
                <label for="editExamCourseSection">Select Exam Course/Section</label>
                <select name="editExamCourseSection" id="editExamCourseSection" required>
                    <option value="" disabled selected>Select Course Section</option>
                    {% for exam in exam_data %}
                        {% if exam.course %}
                            <option value="{{ exam.course.courseCodeSection }}">
                                [{{ exam.course.courseCodeSection }}] - {{ exam.course.courseName }}
                            </option>
                        {% else %}
                            {# optional: show a disabled placeholder for exams without a linked course #}
                            <option value="" disabled>Unlinked exam (ID: {{ exam.examId }})</option>
                        {% endif %}
                    {% endfor %}
                </select><br>

                <label>Course Name</label>
                <input type="text" id="editCourseName" name="courseName" value="" readonly><br>

                <label>Program Code</label>
                <select id="editProgramCode" name="programCode" required>
                    <option value="" disabled selected>Select Department</option>
                    {% for dept in department_data %}
                        <option value="{{ dept.departmentCode }}">{{ dept.departmentCode }} - {{ dept.departmentName }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-middle">
                <label>Practical Lecturer</label>
                <select id="editPracticalLecturer" name="practicalLecturer" required>
                    <option value="" disabled>Select Practical Lecturer</option>
                </select><br>

                <label>Tutorial Lecturer</label>
                <select id="editTutorialLecturer" name="tutorialLecturer" required>
                    <option value="" disabled>Select Tutorial Lecturer</option>
                </select><br>

                <label>Number of Students</label>
                <input type="number" id="editStudent" name="student" value="" readonly>
            </div>

            <div class="form-right">
                <label>Exam Start Date & Time</label>
                <input type="datetime-local" id="editExamStartTime" name="startDateTime" required><br>

                <label>Exam End Date & Time</label>
                <input type="datetime-local" id="editExamEndTime" name="endDateTime" required><br>

                <label>Venue</label>
                <select name="venue" id="editVenue" required>
                    <option value="" disabled selected>Select Venue</option>
                    {% for venue in venue_data %}
                        <option value="{{ venue.venueNumber }}">[Capacity: {{ venue.venueCapacity }}] - {{ venue.venueNumber }}</option>
                    {% endfor %}
                </select><br>

                <label>Number of Invigilators</label>
                <input type="number" id="editInvigilatorNo" name="invigilatorNo" value="" min="1" step="1" required>
            </div>
        </div>

        <input type="hidden" name="form_type" value="edit"><br><br>

        <div class="button-wrapper" style="gap: 5%;">
            <button type="submit" name="action" value="update" style="background-color: rgb(44, 238, 70);">
                <i class="fas fa-check"></i> Update Exam
            </button>
            <button type="submit" name="action" value="delete" style="background-color: rgb(235, 120, 120);"
                    onclick="return confirm('Are you sure to delete this exam?')">
                <i class="fas fa-trash"></i> Delete Exam
            </button>
        </div>
    </div>
</form>
{% endblock %}



{% block content %}
<div class="menu-section">
    <h2>List of Exam</h2>
    <div class="user-table-container">
        <table class="user-data-table">
            <thead>
                <tr>
                    <th>No</th>
                    <th>Course Details</th>
                    <th>Exam ID</th>
                    <th>Exam Details</th>
                    <th>Number of Invigilators</th>
                </tr>
            </thead>    
            <tbody>
                {% for row in exam_data %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>
                            Course Name        : {{ row.course.courseName }} <br>
                            Course Code/Section: {{ row.course.courseCodeSection }}<br>
                            Program Code       : {{ row.course.courseDepartment }} <br>
                            Number of Students : {{ row.course.courseStudent }} <br>
                            Practical Lecturer : {{ row.course.practicalLecturer.userName if row.course.practicalLecturer else 'N/A' }} <br>
                            Tutorial Lecturer  : {{ row.course.tutorialLecturer.userName if row.course.tutorialLecturer else 'N/A' }}
                        </td>
                        <td>[{{ row.examId }}]</td>

                        <!-- Exam Details -->
                        <td>
                            {% if row.examStartTime and row.examEndTime %}
                                Exam Date  : [{{ row.examStartTime.strftime("%Y-%m-%d") }}] - [{{ row.examEndTime.strftime("%Y-%m-%d") }}]<br>      
                                Exam Day   : [{{ row.examStartTime.strftime("%A") }}] - [{{ row.examEndTime.strftime("%A") }}] <br>
                                Exam Time  : [{{ row.examStartTime.strftime("%H:%M") }}] - [{{ row.examEndTime.strftime("%H:%M") }}] <br>
                                Exam Period: [{{ (row.examEndTime - row.examStartTime).seconds // 3600 }}h {{ ((row.examEndTime - row.examStartTime).seconds % 3600) // 60 }}m] <br>
                            {% else %}
                                <span style="color:red;">Exam details not yet assigned</span><br>
                            {% endif %}
                            {% if row.examVenue %}
                                Exam Venue : [{{ row.examVenue }}]
                            {% else %}
                                <span style="color:red;">Exam Venue : [ERROR]</span>
                            {% endif %}
                        </td>
                    
                        <td>
                            {% if row.examNoInvigilator == 0 %}
                                <span style="color:red;">Error: No Invigilator Assigned!</span>
                            {% else %}
                                [{{ row.examNoInvigilator }}]
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}


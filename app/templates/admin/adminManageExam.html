{% extends "admin/adminBase.html" %}
{% set show_tabs = true %}
{% set show_upload = true %}
{% set show_dashboard = true %}
{% set show_manual = false %}
{% set show_edit = true %}
{% block title %}Admin ManageExams{% endblock %}
{% block head_title %}<h2>Manage Exams</h2>{% endblock %}

{% block dashboard_section %}
<form id="dashboardForm" action="{{ url_for('admin_manageExam') }}" method="POST">
    <div id="dashboardSection">
        <input type="hidden" name="form_type" value="dashboard">
        <div class="form-left" style="width: 100%">
            <div class="dashboard-row">
                <div class="dashboard-frame">
                    <h3>Total Exams</h3>
                    <p class="dashboard-text">{{ exam_data|length }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Completed Exams</h3>
                    <p class="dashboard-text" style="color:blue;">{{ exam_data|length - total_exam_activated - unassigned_exam }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Upcoming Exams</h3>
                    <p class="dashboard-text" style="color:green;">{{ total_exam_activated }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Unassigned Exam Details</h3>
                    <p class="dashboard-text" style="color:red;">{{ unassigned_exam }}</p>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block upload_section %}
<!-- Upload Form -->
<form id="uploadForm" action="{{ url_for('admin_manageExam') }}" method="POST" enctype="multipart/form-data">
    <div id="uploadSection" class="function-frame" style="width:80%">
        <div class="form-left" style="width: 100%">
            <h4 style="text-align: center;">File Upload Section</h4>
            <label for="exam_list">
                <div class="upload-container" id="examUploadContainer">
                    <h4 style="text-align: center;">
                        Download the exam template <a href="{{ url_for('download_exam_template') }}"><i>HERE</i></a>
                    </h4><br>
                    <div class="upload-text">
                        Please upload a file with the <b>first row left empty</b>.  
                        Data should begin from columns <b>A to I</b>, with headers as follows:<br><br>
                        <i>['Exam Date', 'Day', 'Start Time', 'End Time', 'Course Code', 'Course Name', 'Total number of students', 'Total number of students by venue', Exam Venue]</i><br><br>
                        You may also download the exam template using the link above.<br><br>
                        Format: Date in <b>MM/DD/YYYY</b> format, and Start & End times in <b>hh:mm:ss AM/PM</b> format (e.g. 8:00:00 AM).<br><br>
                        Click below to upload, or drag and drop a file (accepted formats: <b>XLSX, XLS, XLSM</b>).
                    </div><br>
                    <div id="examSelectedFileName" class="file-name-display"></div>
                </div>
            </label>
            <input type="file" id="exam_list" name="exam_file" accept=".xlsx,.xls,.xlsm" style="display: none;">
            <input type="hidden" name="form_type" value="upload">
            <input type="hidden" name="share_time" id="shareTimeInput">
            <input type="hidden" name="expire_time" id="expireTimeInput">
            <br>
            <div class="button-wrapper">
                <button type="submit">Upload Exam</button>
            </div>
        </div>
    </div>
</form>
{% endblock %}  
<div id="timeModal" class="modal">
    <div class="modal-content">
        <h3>Select Share & Expire Time</h3>

        <label>Share Time:</label>
        <input type="datetime-local" id="shareTimePicker"><br><br>

        <label>Expire Time:</label>
        <input type="datetime-local" id="expireTimePicker"><br><br>

        <button id="confirmTimes">Confirm</button>
        <button id="cancelTimes">Cancel</button>
    </div>
</div>

{% block edit_section %}
<form id="editForm" action="{{ url_for('admin_manageExam') }}" method="POST">
    <div id="editSection" class="function-frame">
        <h4 style="text-align: center;">Edit Existing Exams</h4>
        <div class="profile-frame">
            <div class="form-left">
                <label for="editExamCourseSection">Select Exam Course - Course Name</label>
                <select name="editExamCourseSection" id="editExamCourseSection" required>
                    <option value="" disabled selected>Select Course</option>
                    {% for exam in display_exam_data %}
                        {% if exam.course %}
                            <option value="{{ exam.course.courseCodeSectionIntake.split('/')[0]  }}">
                                [{{ exam.course.courseCodeSectionIntake.split('/')[0]  }}] - {{ exam.course.courseName }}
                            </option>
                        {% else %}
                            <option value="" disabled>Unlinked exam (ID: {{ exam.examId }})</option>
                        {% endif %}
                    {% endfor %}
                </select><br>

                <label>Program Code</label>
                <input type="text" id="editProgramCode" name="programCode" readonly><br>
                
                <label>Number of Students</label>
                <input type="number" id="editStudent" name="student" value="" readonly>
            </div>

            <div class="form-middle">

                <label>Exam Start Date & Time</label>
                <div style="display: flex; gap: 2%;">
                    <input type="date" id="startDate" name="startDate" required>
                    <input type="time" id="startTime" name="startTime" required>
                </div><br>

                <label>Exam End Date & Time</label>     
                <div style="display: flex; gap: 2%;">
                    <input type="date" id="endDate" name="endDate" required>
                    <input type="time" id="endTime" name="endTime" required>
                </div>
            </div>

            <div class="form-right">
                <label>Exam Venue(s)</label>
                <div id="venueContainer">
                    <div class="venue-item" style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                        <select name="venue[]" id="editVenue" class="venue-dropdown" required>
                            <option value="" disabled selected>Select Exam Venue</option>
                            {% for venue in venue_data %}
                                <option value="{{ venue.venueNumber }}">[Capacity: {{ venue.venueCapacity }}] - {{ venue.venueNumber }}</option>
                            {% endfor %}
                        </select>

                        <!-- Input for number of students -->   
                        <input type="number" name="venueStudents[]" placeholder="Capacity" min="1" style="width: 100px;" required>

                        <button type="button" id="addVenueBtn" class="add-btn"
                            style="background-color: #28a745; color: white; border: none; border-radius: 5px; padding: 10px; font-size: large;">
                            +
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <input type="hidden" name="form_type" value="edit">
        <br><br>

        <div class="button-wrapper" style="gap: 5%;">
            <button type="submit" name="action" value="update" style="background-color: #d4edda; color: #155724;">
                <i class="fas fa-check"></i> Update Exam
            </button>
            <button type="submit" name="action" value="delete" style="background-color: #f8d7da; color: #721c24;" onclick="return confirm('Are you sure to delete this exam?')">
                <i class="fas fa-trash"></i> Delete Exam
            </button>
        </div>
    </div>
</form>
{% endblock %}

{% block content %}
<div class="menu-section">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>List of Exams</h2>
        <div style="display: flex; align-items: center; gap: 10px;">
            <div style="position: relative;">
                <input type="text" id="searchInput" name="search_exams" placeholder="Search..." value="{{ search_exams }}" style="border-radius: 6px; width: 100%;">
                <i class="fa fa-search" id="searchBtn" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer;"></i>
            </div>
            <div class="button-wrapper">
                <button id="generatePDF" style="background-color: black;">Download as PDF</button>
            </div>
        </div>
    </div>
    <div id="noResults" style="display: none; text-align: center; margin-top: 10px; font-weight: bold; color: #b00;">No results found.</div>

    <div class="user-table-container">
        <table class="user-data-table" id="manageExam">
            <thead>
                <tr>
                    <th>No</th>
                    <th>Exam Status</th>
                    <th>Exam ID</th>
                    <th>Course Details</th>
                    <th>Exam Details</th>
                    <th>Invigilator Filter</th>
                    <th>Number of Invigilators</th>
                    <th>Added/Edit Details</th>
                </tr>
            </thead>    
            <tbody>
                {% for row in exam_data %}
                <tr class="
                    {% if not row.examStatus %}inactive-row-show
                    {% elif row.examStartTime is none %}error-row-show
                    {% endif %}">
                    <td>{{ loop.index }}</td>
                    <td>
                        {% if row.examStatus %}
                            <span class="status frame-completed">ONGOING</span>
                        {% else %}
                            <span class="status frame-expired">EXPIRED</span>
                        {% endif %}
                    </td>
                    <td>{{ row.examId }}</td>
                    <td>
                        <div class="info-grid">
                            <div>Course Name</div><div><strong>: {{ row.course.courseName }}</strong></div>
                            <div>Course Code/Section</div><div><strong>: {{ row.course.courseCodeSectionIntake.split('/')[0] }}</strong></div>
                            <div>Program Code</div><div><strong>: {{ row.course.courseDepartment }}</strong></div>
                            <div>Number of Students</div><div><strong>: {{ row.examTotalStudents }}</strong></div>
                            <div>Practical Lecturer</div><div><strong>: {{ row.course.practicalLecturer.userName if row.course.practicalLecturer else '<span>N/A</span>' | safe }}</strong></div>
                            <div>Tutorial Lecturer</div><div><strong>: {{ row.course.tutorialLecturer.userName if row.course.tutorialLecturer else  '<span>N/A</span>' | safe }}</strong></div>
                        </div>
                    </td>
                    <td>
                        {% if row.examStartTime and row.examEndTime %}
                        <div class="info-grid">
                            <div>Exam Date</div><div><strong>: {{ row.examStartTime.strftime("%d/%b/%Y") }} - {{ row.examEndTime.strftime("%d/%b/%Y") }}</strong></div>
                            <div>Exam Day</div><div><strong>: {{ row.examStartTime.strftime("%A") }} - {{ row.examEndTime.strftime("%A") }}</strong></div>
                            <div>Exam Time</div><div><strong>: {{ row.examStartTime.strftime("%H:%M") }} - {{ row.examEndTime.strftime("%H:%M") }}</strong></div>
                            <div>Exam Period</div><div><strong>: {{ (row.examEndTime - row.examStartTime).seconds // 3600 }}h {{ ((row.examEndTime - row.examStartTime).seconds % 3600) // 60 }}m</strong></div>
                            <div>Exam Venue(s)</div>
                            <div>
                                {% if row.venue_availabilities %}
                                    {% for va in row.venue_availabilities %}
                                        <strong>: {{ va.venueNumber }} [Capacity Use: {{ va.capacity }}]</strong><br>
                                    {% endfor %}
                                {% else %}
                                    <strong>: None</strong>
                                {% endif %}
                            </div>
                        </div>
                        {% else %}
                        <span class="status frame-expired">Exam details not yet assigned</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if row.examOutput %}
                        <div class="info-grid">
                            <div>Total Lecturers</div><div><strong>: {{ row.examOutput[0] }}</strong></div>
                            <div>Eligible Invigilators</div><div><strong>: {{ row.examOutput[1] }}</strong></div>
                            <div>Flexible Invigilators</div><div><strong>: {{ row.examOutput[2] }}</strong></div>
                            <div>Non-Flexible Invigilators</div><div><strong>: {{ row.examOutput[3] }}</strong></div>
                            <div>Non-Flexible List</div><div><strong>: {{ row.examOutput[4] }}</strong></div>
                            <div>Flexible Male</div><div><strong>: {{ row.examOutput[5] }}</strong></div>
                            <div>Flexible Female</div><div><strong>: {{ row.examOutput[6] }}</strong></div>
                        </div>
                        {% else %}None
                        {% endif %}
                    </td>
                    <td>{{ row.examNoInvigilator }}</td>
                    <td>
                        <div class="info-grid">
                            {% if row.examAddedBy and row.examAddedOn %}
                                <div>By</div><div><strong>: {{ row.examAddedBy }}</strong></div>
                                <div>By</div><div><strong>: {{ row.addedBy.userName }}</strong></div>
                                <div>On</div><div><strong>: {{ row.examAddedOn }}</strong></div>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// -------------------------
// Store venue options once
// -------------------------
let venueOptionsHTML = "";
document.addEventListener("DOMContentLoaded", function() {
    const venueSelect = document.getElementById("editVenue");
    if (venueSelect) {
        venueOptionsHTML = Array.from(venueSelect.options)
            .map(opt => `<option value="${opt.value}">${opt.textContent}</option>`)
            .join("");
    }
});

// -------------------------
// Clear edit form
// -------------------------
function clearEditFields() {
    const fieldsToClear = [
        'editProgramCode', 'editStudent',
        'startDate', 'startTime', 'endDate', 'endTime'
    ];
    fieldsToClear.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) field.value = '';
    });

    const venueContainer = document.getElementById('venueContainer');
    if (venueContainer) venueContainer.innerHTML = '';
}

// Create Venue Row (now supports prefill capacity)
function createVenueRow(venueNumber = '', capacity = '', isFirst = false) {
    const venueContainer = document.getElementById('venueContainer');
    const div = document.createElement('div');
    div.classList.add('venue-item');
    div.style.display = "flex";
    div.style.alignItems = "center";
    div.style.gap = "8px";
    div.style.marginBottom = "5px";

    div.innerHTML = `
        <select name="venue[]" class="venue-dropdown" required>
            ${venueOptionsHTML.replace(`value="${venueNumber}"`, `value="${venueNumber}" selected`)}
        </select>
        <input type="number" name="venueStudents[]" placeholder="Capacity" min="1" 
               value="${capacity}" style="width: 100px;" required>
        <button type="button" class="${isFirst ? 'add-btn' : 'removeVenueBtn'}"
            style="background-color: ${isFirst ? '#28a745' : '#dc3545'};
                   color: white; border: none; border-radius: 5px; padding: 10px; font-size: large;">
            ${isFirst ? '+' : '×'}
        </button>
    `;
    venueContainer.appendChild(div);

    if (isFirst) {
        div.querySelector('.add-btn').addEventListener('click', () => {
            if (venueContainer.querySelectorAll('.venue-item').length >= 20) {
                alert("You can only add up to 20 venues.");
                return;
            }
            createVenueRow('', '', false);
        });
    } else {
        div.querySelector(".removeVenueBtn").addEventListener("click", () => div.remove());
    }
}

// Populate Edit Form (with venue capacity)
function populateEditForm(data) {
    document.getElementById('editProgramCode').value = data.courseDepartment || '';
    document.getElementById('editStudent').value = data.courseStudent || '';

    if (data.examStartTime) {   
        const [date, time] = data.examStartTime.split('T');
        document.getElementById('startDate').value = date;
        document.getElementById('startTime').value = time;
    }
    if (data.examEndTime) {
        const [date, time] = data.examEndTime.split('T');
        document.getElementById('endDate').value = date;
        document.getElementById('endTime').value = time;
    }

    const venueContainer = document.getElementById('venueContainer');
    venueContainer.innerHTML = '';

    if (data.examVenues && data.examVenues.length > 0) {
        data.examVenues.forEach((venueObj, index) => {
            createVenueRow(venueObj.venueNumber, venueObj.capacity, index === 0);
        });
    } else {
        createVenueRow('', '', true);
    }
}

// -------------------------
// On Exam Select Change
// -------------------------
document.addEventListener("DOMContentLoaded", function() {
    const courseSelect = document.getElementById("editExamCourseSection");
    if (!courseSelect) return;

    courseSelect.addEventListener("change", function() {
        const selectedValue = this.value;
        clearEditFields();
        if (!selectedValue) return;

        fetch(`/get_exam_details/${encodeURIComponent(selectedValue)}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) alert(data.error);
                else populateEditForm(data);
            })
            .catch(err => console.error("Error fetching exam details:", err));
    });
});

// -------------------------
// Date & Time Restrictions
// -------------------------
document.addEventListener("DOMContentLoaded", function () {
    const startDate = document.getElementById("startDate");
    const startTime = document.getElementById("startTime");
    const endDate = document.getElementById("endDate");
    const endTime = document.getElementById("endTime");
    if (!startDate || !startTime || !endDate || !endTime) return;

    const now = new Date();
    const today = now.toISOString().split("T")[0];
    const nextYear = new Date(now); nextYear.setFullYear(nextYear.getFullYear() + 1);
    const nextYearDate = nextYear.toISOString().split("T")[0];

    startDate.min = today; startDate.max = nextYearDate;
    endDate.min = today; endDate.max = nextYearDate;

    startDate.value = today; endDate.value = today;

    function restrictStartTime() {
        startTime.min = (startDate.value === today) 
            ? String(now.getHours()).padStart(2,"0")+":"+String(now.getMinutes()).padStart(2,"0") 
            : "00:00";
    }
    function restrictEndTime() {
        endTime.min = (endDate.value === today)
            ? String(now.getHours()).padStart(2,"0")+":"+String(now.getMinutes()).padStart(2,"0")
            : "00:00";
    }

    function adjustEndDate() {
        if (!startDate.value || !startTime.value || !endTime.value) return;
        const start = new Date(startDate.value + "T" + startTime.value);
        let end = new Date(endDate.value + "T" + endTime.value);
        if (end < start) {
            let nextDay = new Date(start); nextDay.setDate(nextDay.getDate() + 1);
            endDate.value = nextDay.toISOString().split("T")[0];
        } else endDate.value = startDate.value;
    }

    startDate.addEventListener("change", () => { endDate.value = startDate.value; restrictStartTime(); restrictEndTime(); });
    endDate.addEventListener("change", restrictEndTime);
    startTime.addEventListener("change", adjustEndDate);
    endTime.addEventListener("change", adjustEndDate);

    restrictStartTime(); restrictEndTime();
});

// -------------------------
// PDF Export
// -------------------------
document.addEventListener("DOMContentLoaded", function () {
    const generateBtn = document.getElementById("generatePDF");
    if (!generateBtn) return;

    generateBtn.addEventListener("click", function () {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({orientation: "landscape",unit: "pt",format: "a4"});
        const margin = 20;
        const pageWidth = doc.internal.pageSize.getWidth();

        // ===== Title =====
        doc.setFont("helvetica", "bold");
        doc.setFontSize(18);
        doc.text("Manage Exam", pageWidth / 2, margin, { align: "center" });

        const startY = margin + 25;

        // ===== Prepare table data manually (to preserve readable formatting) =====
        const table = document.querySelector(".user-data-table");
        if (!table) {
            alert("No table found to export!");
            return;
        }

        const headers = Array.from(table.querySelectorAll("thead th")).map(th => th.textContent.trim());
        const rows = Array.from(table.querySelectorAll("tbody tr")).map(tr => {
            const cells = Array.from(tr.querySelectorAll("td")).map(td => {
                let text = td.innerText.trim();

                // Fix multi-line readability
                text = text.replace(/\s*\n\s*/g, " ");

                // Add newlines before each field label, not after colon
                if (td.cellIndex === 2 || td.cellIndex === 4) {
                    text = text
                        .replace(/\s*Course Name\s*:/g, "\nCourse Name:") 
                        .replace(/\s*Course Code\/Section\s*:/g, "\nCourse Code/Section:")
                        .replace(/\s*Program Code\s*:/g, "\nProgram Code:")
                        .replace(/\s*Number of Students\s*:/g, "\nNumber of Students:")
                        .replace(/\s*Practical Lecturer\s*:/g, "\nPractical Lecturer:")
                        .replace(/\s*Tutorial Lecturer\s*:/g, "\nTutorial Lecturer:")
                        .replace(/\s*Exam Date\s*:/g, "\nExam Date:")
                        .replace(/\s*Exam Day\s*:/g, "\nExam Day:")
                        .replace(/\s*Exam Time\s*:/g, "\nExam Time:")
                        .replace(/\s*Exam Period\s*:/g, "\nExam Period:")
                        .replace(/\s*Exam Venue\s*:/g, "\nExam Venue:");

                    // Clean up possible leading newline
                    text = text.trimStart();
                }

                return text;
            });
            return cells;
        });

        // ===== Generate AutoTable =====
        doc.autoTable({
            head: [headers],
            body: rows,
            startY: startY,
            theme: "grid",
            tableWidth: "auto",
            styles: {font: "helvetica", fontSize: 9, cellPadding: 4, overflow: "linebreak", valign: "middle"},
            headStyles: {fillColor: [33, 37, 41], textColor: [255, 255, 255], halign: "center"},
            margin: { top: margin, left: margin, right: margin, bottom: margin },
            didDrawPage: function (data) {
                const pageCount = doc.internal.getNumberOfPages();
                const pageHeight = doc.internal.pageSize.height;
                doc.setFontSize(9);
                doc.setTextColor(100);
                doc.text(`Page ${pageCount}`, pageWidth - margin, pageHeight - 10, { align: "right" });
            },
        });

        // ===== Save =====
        doc.save("Admin_ViewExamList.pdf");
    });
});

document.addEventListener("DOMContentLoaded", function () {
    const uploadForm = document.getElementById("uploadForm");
    const modal = document.getElementById("timeModal");
    const shareInput = document.getElementById("shareTimeInput");
    const expireInput = document.getElementById("expireTimeInput");

    if (!uploadForm) return;

    uploadForm.addEventListener("submit", function(e) {
        e.preventDefault();  // stop submit
        modal.style.display = "block";
    });

    document.getElementById("confirmTimes").addEventListener("click", function() {

        const shareValue = document.getElementById("shareTimePicker").value;
        const expireValue = document.getElementById("expireTimePicker").value;

        if (!shareValue || !expireValue) {
            alert("⚠ Please select both share time and expire time.");
            return;
        }

        shareInput.value = shareValue;
        expireInput.value = expireValue;

        modal.style.display = "none";
        uploadForm.submit();
    });

    document.getElementById("cancelTimes").addEventListener("click", function() {
        modal.style.display = "none";
    });
});
</script>
{% endblock %}



{% extends "admin/adminBase.html" %}
{% set show_tabs = true %}
{% set show_upload = false %}
{% set show_dashboard = true %}
{% set show_manual = true %}
{% set show_edit = true %}
{% block title %}Admin ManageDepartments{% endblock %}
{% block head_title %}<h2>Manage Department</h2>{% endblock %}

{% block dashboard_section %}
<!-- Dashboard Form -->
<form id="dashboardForm" action="{{ url_for('admin_manageDepartment') }}" method="POST">
    <div id="dashboardSection">
        <input type="hidden" name="form_type" value="dashboard">
        <div class="form-left" style="width: 100%">

            <!-- Overview -->
            <div class="dashboard-row">
                <div class="dashboard-frame">
                    <h3>Total Department(s)</h3>
                    <p class="dashboard-text">{{ total_department }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Total Dean</h3>
                    <p class="dashboard-text" style="color:#cf8223;">{{ deans|length }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Total HOS</h3>
                    <p class="dashboard-text" style="color:#47AEF5;">{{ hoss|length }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Total HOP</h3>
                    <p class="dashboard-text" style="color:green;">{{ hops|length }}</p>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}


{% block manual_section %}
<!-- Manual Form -->
<form id="manualForm" action="{{ url_for('admin_manageDepartment') }}" method="POST" enctype="multipart/form-data">
    <div id="manualSection" class="function-frame">
        <h4 style="text-align: center;">Manual Data Entry Section</h4>
        <div class="profile-frame">
            <div class="form-left">
                <label>Department Code</label>
                <input type="text" name="departmentCode" required>
            </div>
            <div class="form-right">
                <label>Department Name</label>
                <input type="text" name="departmentName" required>
            </div>
        </div>
        <input type="hidden" name="form_type" value="manual">
        <br><br>

        <div class="button-wrapper">
            <button type="submit">Add A New Department</button>
        </div>
    </div>
</form>
{% endblock %}


{% block edit_section %}
<!-- Edit Form -->
<form id="editForm" action="{{ url_for('admin_manageDepartment') }}" method="POST" enctype="multipart/form-data">
    <div id="editSection" class="function-frame">
        <h4 style="text-align: center;">Edit Existing Department</h4>
        <div class="profile-frame">
            <div class="form-left">
                <label>Select Department</label>
                <select id="editDepartment" name="editDepartment" required>
                    <option value="" disabled selected>Select Department</option>
                    {% for dept in department_data %}
                        <option value="{{ dept.departmentCode }}"
                                {% if department_select and dept.departmentCode == department_select.departmentCode %}selected{% endif %}>
                            {{ dept.departmentCode }} - {{ dept.departmentName }}
                        </option>
                    {% endfor %}
                </select><br>

                <label>Department Name</label>
                <input type="text" name="departmentName" value="{{ department_select.departmentName if department_select else '' }}" required>
            </div>

            <div class="form-middle">
                <label>Dean Name</label>
                <select id="deanName" name="deanName">
                    <option value="None">None</option>
                    {% for dean in deans %}
                        <option value="{{ dean.userId }}">
                            [{{ dean.userDepartment }}] {{ dean.userName }}
                        </option>
                    {% endfor %}
                </select><br>

                <label>Hos Name</label>
                <select id="hosName" name="hosName">
                    <option value="None">None</option>
                    {% for hos in hoss %}
                        <option value="{{ hos.userId }}">
                            [{{ hos.userDepartment }}] {{ hos.userName }}
                        </option>
                    {% endfor %}
                </select>
            </div> 
            <div class="form-right">
                <label>Hop Name</label>
                <select id="hopName" name="hopName">
                    <option value="None">None</option>
                    {% for hop in hops %}
                        <option value="{{ hop.userId }}">
                            [{{ hop.userDepartment }}] {{ hop.userName }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <input type="hidden" name="form_type" value="edit">
        <br><br>

        <div class="button-wrapper" style="gap: 5%;">
            <button type="submit" name="action" value="update" style="background-color: #d4edda; color: #155724;">
                <i class="fas fa-check"></i> Update Department
            </button>
            <button type="submit" name="action" value="delete" style="background-color: #f8d7da; color: #721c24;"
                    onclick="return confirm('Are you sure to delete this department?')">
                <i class="fas fa-trash"></i> Delete Department
            </button>
        </div>
    </div>
</form>
{% endblock %}



{% block content %}
<div class="menu-section">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>List of Department(s)</h2>
        <div style="display: flex; align-items: center; gap: 10px;">
            <div style="position: relative;">
                <input type="text" id="searchInput" name="search_department" placeholder="Search..." value="{{ search_department }}" style="border-radius: 6px; width: 100%;">
                <i class="fa fa-search" id="searchBtn" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer;"></i>
            </div>
            <div class="button-wrapper">
                <button id="generatePDF" style="background-color: black;">Download as PDF</button>
            </div>
        </div>
    </div>
    <div id="noResults" style="display: none; text-align: center; margin-top: 10px; font-weight: bold; color: #b00;">No results found.</div>

    <div class="user-table-container">
        <table class="user-data-table" id="manageDepartment">
            <thead>
                <tr>
                    <th>No</th>
                    <th>Department Code</th>
                    <th>Department Name</th>
                    <th>Dean Details</th>
                    <th>Hos Details</th>
                    <th>Hop Details</th>
                    <th>Added/Edit Details</th>
                </tr>
            </thead>
            <tbody>
                {% for row in department_data %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ row.departmentCode }}</td>
                    <td>{{ row.departmentName }}</td>
                    <td>
                        {% if row.dean %}
                            <div class="info-grid">
                                <div>ID</div><div><strong>: {{ row.dean.userId }}</strong></div>
                                <div>Name</div><div><strong>: {{ row.dean.userName }}</strong></div>
                                <div>Email</div><div><strong>: {{ row.dean.userEmail }}</strong></div>
                                <div>Contact</div><div><strong>: {{ row.dean.userContact }}</strong></div>
                                <div>Department</div><div><strong>: {{ row.dean.userDepartment }}</strong></div>
                            </div>
                        {% endif %}
                    </td>
                    <td>
                        {% if row.hos %}
                            <div class="info-grid">
                                <div>ID</div><div><strong>: {{ row.hos.userId }}</strong></div>
                                <div>Name</div><div><strong>: {{ row.hos.userName }}</strong></div>
                                <div>Email</div><div><strong>: {{ row.hos.userEmail }}</strong></div>
                                <div>Contact</div><div><strong>: {{ row.hos.userContact }}</strong></div>
                                <div>Department</div><div><strong>: {{ row.hos.userDepartment }}</strong></div>
                            </div>
                        {% endif %}
                    </td>
                    <td>
                        {% if row.hop %}
                            <div class="info-grid">
                                <div>ID</div><div><strong>: {{ row.hop.userId }}</strong></div>
                                <div>Name</div><div><strong>: {{ row.hop.userName }}</strong></div>
                                <div>Email</div><div><strong>: {{ row.hop.userEmail }}</strong></div>
                                <div>Contact</div><div><strong>: {{ row.hop.userContact }}</strong></div>
                                <div>Department</div><div><strong>: {{ row.hop.userDepartment }}</strong></div>
                            </div>
                        {% endif %}
                    </td>
                    <td>
                        <div class="info-grid">
                            {% if row.departmentAddedBy and row.departmentAddedOn %}
                                <div>By</div><div><strong>: {{ row.addedBy.userName.split(' ')[0] }}</strong></div>
                                <div>On</div><div><strong>: {{ row.departmentAddedOn.strftime('%d%b%Y %H:%M') }}</strong></div>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}



{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const departmentSelect    = document.getElementById("editDepartment");
    const departmentNameInput = document.querySelector("#editForm input[name='departmentName']");
    const hosSelect           = document.getElementById("hosName");
    const deanSelect          = document.getElementById("deanName");
    const hopSelect           = document.getElementById("hopName");

    async function fetchDepartmentData(deptCode) {
        if (!deptCode) return;

        try {
            const resp = await fetch(`/get_department/${encodeURIComponent(deptCode)}`);
            const dept = await resp.json();

            if (dept.error) {
                alert(dept.error);
                return;
            }

            // Fill department name
            departmentNameInput.value = dept.departmentName || "";

            // Preselect dean & hop & hos if IDs are provided
            if (dept.deanId && deanSelect) {
                deanSelect.value = dept.deanId;
            } else if (deanSelect) {
                deanSelect.value = ""; // reset if none
            }

            if (dept.hosId && hosSelect) {
                hosSelect.value = dept.hosId;
            } else if (hosSelect) {
                hosSelect.value = ""; // reset if none
            }

            if (dept.hopId && hopSelect) {
                hopSelect.value = dept.hopId;
            } else if (hopSelect) {
                hopSelect.value = "";
            }

        } catch (err) {
            console.error("Error fetching department:", err);
        }
    }

    if (departmentSelect) {
        departmentSelect.addEventListener("change", () => {
            fetchDepartmentData(departmentSelect.value);
        });

        // Auto-fill on page load if already selected
        if (departmentSelect.value) {
            fetchDepartmentData(departmentSelect.value);
        }
    }
});

document.addEventListener("DOMContentLoaded", function () {
    const generateBtn = document.getElementById("generatePDF");
    if (!generateBtn) return;

    generateBtn.addEventListener("click", function () {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: "landscape", unit: "pt", format: "a4" });

        const margin = 20;
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const nowMY = new Date().toLocaleString("en-GB", {timeZone: "Asia/Kuala_Lumpur", day: "2-digit", month: "short", year: "numeric", hour: "2-digit", minute: "2-digit", hour12: true});
        
        // ===== Title =====
        doc.setFont("helvetica", "bold");
        doc.setFontSize(18);
        doc.text("Admin View - Departments Download", pageWidth / 2, margin, { align: "center" });

        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);
        doc.text(`Downloaded on: ${nowMY}`, pageWidth / 2, margin + 18, { align: "center" });
        const startY = margin + 25;

        // ===== Get table =====
        const table = document.querySelector(".user-data-table");
        if (!table) { alert("No table found to export!"); return; }

        const headers = Array.from(table.querySelectorAll("thead th")).map(th => th.textContent.trim());
        const rows = Array.from(table.querySelectorAll("tbody tr")).map(tr =>
            Array.from(tr.querySelectorAll("td")).map((td, idx) => {
                let text = td.innerText.trim();

                // Format long detail columns
                if (idx >= 3) {
                    text = text
                        .replace(/\s*ID\s*:/g, "ID:")
                        .replace(/\s*Name\s*:/g, "\nName:")
                        .replace(/\s*Email\s*:/g, "\nEmail:")
                        .replace(/\s*Contact\s*:/g, "\nContact:")
                        .replace(/\s*Department\s*:/g, "\nDepartment:")
                        .replace(/\s*By\s*:/g, "\nBy:")
                        .replace(/\s*On\s*:/g, "\nOn:")
                        .trim();
                }
                return text;
            })
        );

        // ===== Generate table =====
        doc.autoTable({
            head: [headers],
            body: rows,
            startY: startY,
            theme: "grid",
            styles: {font: "helvetica", fontSize: 8, cellPadding: 4, overflow: "linebreak", valign: "middle"},
            headStyles: {fillColor: [33, 37, 41], textColor: [255, 255, 255], halign: "center"},
            // Automatically scale table to fit page width
            tableWidth: pageWidth - 2 * margin,
            margin: { top: margin, left: margin, right: margin, bottom: margin },
            didDrawPage: function (data) {
                const pageCount = doc.internal.getNumberOfPages();
                doc.setFontSize(9);
                doc.setTextColor(100);
                doc.text(`Page ${pageCount}`, pageWidth - margin, pageHeight - 10, { align: "right" });
            },
        });

        doc.save("Admin_ViewDepartmentList.pdf");
    });
});
</script>
{% endblock %}


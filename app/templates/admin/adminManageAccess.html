{% extends "admin/adminBase.html" %}
{% set show_tabs = true %}
{% set user_access = true %}
{% set show_manual = true %}
{% set show_second_edit = true %}
{% set show_edit = true %}
{% set show_upload = false %}
{% set show_cal = false %}
{% set show_dashboard = false %}
{% block title %}ManageAccess{% endblock %}
{% block head_title %}<h2>Manage Access</h2>{% endblock %}


{% block manual_section %}
<!-- Manual Form -->
<form id="manualForm" action="{{ url_for('admin_manageAccess') }}" method="POST" enctype="multipart/form-data">
    <div id="manualSection" class="function-frame">
        <h4 style="text-align: center;">Manual Data Entry Section</h4>
        <div class="profile-frame">
            <div class="form-profile">
                <label>Role Code</label>
                <input type="text" name="roleCode" required>
            </div>
            <div class="form-profile">
                <label>Role Name</label>
                <input type="text" name="roleName" required>
            </div>
        </div><br>

        <div class="profile-frame" style="justify-content: center; width: 100%;">
            <div class="profile-frame" style="width: 100%">
                <div class="form-profile" style="width: 55%;">
                    <input type="text" name="homepage" value="{{ homepage }}" placeholder="Homepage" readonly>
                    <input type="text" name="course" value="{{ course }}" placeholder="Manage Course" readonly>
                    <input type="text" name="department" value="{{ department }}" placeholder="Manage Department" readonly>
                </div>

                <div class="form-profile" style="width: 40%;">
                    <select name="add_homepage_id" required>
                        <option value="" disabled selected>-- Select Access --</option>
                        <option value="0">Not Allowed</option>
                        <option value="1">Allow</option>
                    </select>
                    <select name="add_course_id" required>
                        <option value="" disabled selected>-- Select Access --</option>
                        <option value="0">Not Allowed</option>
                        <option value="1">Allow</option>
                    </select>
                    <select name="add_department_id" required>
                        <option value="" disabled selected>-- Select Access --</option>
                        <option value="0">Not Allowed</option>
                        <option value="1">Allow</option>
                    </select>
                </div>
            </div>

            <div class="profile-frame" style="width: 100%">
                <div class="form-profile" style="width: 55%;">
                    <input type="text" name="venue" value="{{ venue }}" placeholder="Manage Venue" readonly>
                    <input type="text" name="exam" value="{{ exam }}" placeholder="Manage Exam" readonly>
                    <input type="text" name="staff" value="{{ staff }}" placeholder="Manage/View Staff" readonly>
                </div>

                <div class="form-profile" style="width: 40%;">
                    <select name="add_venue_id" required>
                        <option value="" disabled selected>-- Select Access --</option>
                        <option value="0">Not Allowed</option>
                        <option value="1">Allow</option>
                    </select>
                    <select name="add_exam_id" required>
                        <option value="" disabled selected>-- Select Access --</option>
                        <option value="0">Not Allowed</option>
                        <option value="1">Allow</option>
                    </select>
                    <select name="add_staff_id" required>
                        <option value="" disabled selected>-- Select Access --</option>
                        <option value="0">Not Allowed</option>
                        <option value="1">Allow</option>
                    </select>
                </div>
            </div>
            
            <div class="profile-frame" style="width: 100%">
                <div class="form-profile" style="width: 55%;">
                    <input type="text" name="timetable" value="{{ timetable }}" placeholder="Manage/View Timetable" readonly>
                    <input type="text" name="invTimetable" value="{{ invTimetable }}" placeholder="Manage/View Invigilation Timetable" readonly>
                    <input type="text" name="invReport" value="{{ invReport }}" placeholder="Manage/View Invigilation Report" readonly>
                </div>

                <div class="form-profile" style="width: 40%;">
                    <select name="add_timetable_id" required>
                        <option value="" disabled selected>-- Select Access --</option>
                        <option value="0">Not Allowed</option>
                        <option value="1">Allow</option>
                    </select>
                    <select name="add_inv_timetable_id" required>
                        <option value="" disabled selected>-- Select Access --</option>
                        <option value="0">Not Allowed</option>
                        <option value="1">Allow</option>
                    </select>
                    <select name="add_inv_report_id" required>
                        <option value="" disabled selected>-- Select Access --</option>
                        <option value="0">Not Allowed</option>
                        <option value="1">Allow</option>
                    </select>
                </div>
            </div>
            
            <div class="profile-frame" style="width: 100%">
                <div class="form-profile" style="width: 55%;">
                    <input type="text" name="access" value="{{ access }}" placeholder="Access" readonly>
                    <input type="text" name="activity" value="{{ activity }}" placeholder="Activity" readonly>
                    <input type="text" name="profile" value="{{ profile }}" placeholder="Profile" readonly>
                </div>

                <div class="form-profile" style="width: 40%;">
                    <select name="add_access_id" required>
                        <option value="" disabled selected>-- Select Access --</option>
                        <option value="0">Not Allowed</option>
                        <option value="1">Allow</option>
                    </select>
                    <select name="add_activity_id" required>
                        <option value="" disabled selected>-- Select Access --</option>
                        <option value="0">Not Allowed</option>
                        <option value="1">Allow</option>
                    </select>
                    <select name="add_profile_id" required>
                        <option value="" disabled selected>-- Select Access --</option>
                        <option value="0">Not Allowed</option>
                        <option value="1">Allow</option>
                    </select>
                </div>
            </div>
        </div>
        <input type="hidden" name="form_type" value="manual">
        <br><br>

        <div class="button-wrapper">
            <button type="submit">Add A New Role</button>
        </div>
    </div>
</form>
{% endblock %}

{% block edit_second_section %}
<!-- Edit Form -->
<form id="editSecondForm" action="{{ url_for('admin_manageAccess') }}" method="POST" enctype="multipart/form-data">
    <div id="editSecondSection" class="function-frame">
        <h4 style="text-align: center;">Edit Existing Role</h4>
        <div class="profile-frame">
            <div class="form-profile">
                <label>Select Role</label>
                <select id="editSecondRole" name="editSecondRole" required>
                    <option value="" disabled selected>-- Select Role --</option>
                    {% for role in role_data %}
                        <option value="{{ role.roleCode }}"
                                {% if role_select and role.roleCode == role_select.roleCode %}selected{% endif %}>
                            [{{ role.roleCode }}] - {{ role.roleName }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-profile">
                <label>Role Name</label>
                <input type="text" name="roleName" value="{{ role_select.roleName if role_select else '' }}" required>
            </div>
        </div>
        <input type="hidden" name="form_type" value="second_edit">
        <br><br>

        <div class="button-wrapper" style="gap: 5%;">
            <button type="submit" name="action" value="update" style="background-color: #d4edda; color: #155724;">
                <i class="fas fa-check"></i> Update Role
            </button>
            <button type="submit" name="action" value="delete" style="background-color: #f8d7da; color: #721c24;"
                    onclick="return confirm('Are you sure to delete this role?')">
                <i class="fas fa-trash"></i> Delete Role
            </button>
        </div>
    </div>
</form>
{% endblock %}

{% block edit_section %}
<!-- Edit Form -->
<form id="editForm" action="{{ url_for('admin_manageAccess') }}" method="POST" enctype="multipart/form-data">
    <div id="editSection" class="function-frame">
        <h4 style="text-align: center;">Edit Existing Role Access</h4>
        <div class="profile-frame">
            <div class="form-profile" style="width: 30%;">
                <label>Select Role</label>
                <select id="selectRole" name="selectRole">
                    <option value="" disabled selected>-- Select Role --</option>
                    {% for role in role_data %}
                        <option value="{{ role.roleCode }}"
                                {% if role_select and role.roleCode == role_select.roleCode %}selected{% endif %}>
                            [{{ role.roleCode }}] - {{ role.roleName }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-profile" style="width: 30%;">
                <label>Select Staff</label>
                <select id="selectUser" name="selectUser">
                    <option value="" disabled selected>-- Select Staff --</option>
                    {% for staff in staff_data %}
                        <option value="{{ staff.userId }}"
                                {% if staff_select and staff.userId == staff_select.userId %}selected{% endif %}>
                            [{{ staff.userId }}] - {{ staff.userName }}
                        </option>
                    {% endfor %}
                </select><br>
            </div>
        </div><br>
                
        <div class="profile-frame" style="justify-content: center; width: 100%;">
            <div class="profile-frame" style="width: 100%">
                <div class="form-profile" style="width: 55%;">
                    <input type="text" name="homepage" value="{{ homepage }}" placeholder="Homepage" readonly>
                    <input type="text" name="course" value="{{ course }}" placeholder="Manage Course" readonly>
                    <input type="text" name="department" value="{{ department }}" placeholder="Manage Department" readonly>
                </div>

                <div class="form-profile" style="width: 40%;">
                    <select name="homepage_id" required>
                        <option value="" disabled selected>-- Select Access --</option>
                        <option value="0">Not Allowed</option>
                        <option value="1">Allow</option>
                    </select>
                    <select name="course_id" required>
                        <option value="" disabled selected>-- Select Access --</option>
                        <option value="0">Not Allowed</option>
                        <option value="1">Allow</option>
                    </select>
                    <select name="department_id" required>
                        <option value="" disabled selected>-- Select Access --</option>
                        <option value="0">Not Allowed</option>
                        <option value="1">Allow</option>
                    </select>
                </div>
            </div>

            <div class="profile-frame" style="width: 100%">
                <div class="form-profile" style="width: 55%;">
                    <input type="text" name="venue" value="{{ venue }}" placeholder="Manage Venue" readonly>
                    <input type="text" name="exam" value="{{ exam }}" placeholder="Manage Exam" readonly>
                    <input type="text" name="staff" value="{{ staff }}" placeholder="Manage/View Staff" readonly>
                </div>

                <div class="form-profile" style="width: 40%;">
                    <select name="venue_id" required>
                        <option value="" disabled selected>-- Select Access --</option>
                        <option value="0">Not Allowed</option>
                        <option value="1">Allow</option>
                    </select>
                    <select name="exam_id" required>
                        <option value="" disabled selected>-- Select Access --</option>
                        <option value="0">Not Allowed</option>
                        <option value="1">Allow</option>
                    </select>
                    <select name="staff_id" required>
                        <option value="" disabled selected>-- Select Access --</option>
                        <option value="0">Not Allowed</option>
                        <option value="1">Allow</option>
                    </select>
                </div>
            </div>
            
            <div class="profile-frame" style="width: 100%">
                <div class="form-profile" style="width: 55%;">
                    <input type="text" name="timetable" value="{{ timetable }}" placeholder="Manage/View Timetable" readonly>
                    <input type="text" name="invTimetable" value="{{ invTimetable }}" placeholder="Manage/View Invigilation Timetable" readonly>
                    <input type="text" name="invReport" value="{{ invReport }}" placeholder="Manage/View Invigilation Report" readonly>
                </div>

                <div class="form-profile" style="width: 40%;">
                    <select name="timetable_id" required>
                        <option value="" disabled selected>-- Select Access --</option>
                        <option value="0">Not Allowed</option>
                        <option value="1">Allow</option>
                    </select>
                    <select name="inv_timetable_id" required>
                        <option value="" disabled selected>-- Select Access --</option>
                        <option value="0">Not Allowed</option>
                        <option value="1">Allow</option>
                    </select>
                    <select name="inv_report_id" required>
                        <option value="" disabled selected>-- Select Access --</option>
                        <option value="0">Not Allowed</option>
                        <option value="1">Allow</option>
                    </select>
                </div>
            </div>
            
            <div class="profile-frame" style="width: 100%">
                <div class="form-profile" style="width: 55%;">
                    <input type="text" name="access" value="{{ access }}" placeholder="Access" readonly>
                    <input type="text" name="activity" value="{{ activity }}" placeholder="Activity" readonly>
                    <input type="text" name="profile" value="{{ profile }}" placeholder="Profile" readonly>
                </div>

                <div class="form-profile" style="width: 40%;">
                    <select name="access_id" required>
                        <option value="" disabled selected>-- Select Access --</option>
                        <option value="0">Not Allowed</option>
                        <option value="1">Allow</option>
                    </select>
                    <select name="activity_id" required>
                        <option value="" disabled selected>-- Select Access --</option>
                        <option value="0">Not Allowed</option>
                        <option value="1">Allow</option>
                    </select>
                    <select name="profile_id" required>
                        <option value="" disabled selected>-- Select Access --</option>
                        <option value="0">Not Allowed</option>
                        <option value="1">Allow</option>
                    </select>
                </div>
            </div>
        </div>
        <input type="hidden" name="form_type" value="edit">
        <br><br>

        <div class="button-wrapper" style="gap: 5%;">
            <button type="submit" name="action" value="update" style="background-color: #d4edda; color: #155724;">
                <i class="fas fa-check"></i> Update Access
            </button>
        </div>
    </div>
</form>
{% endblock %}


{% block content %}
<div class="menu-section">
    <h2>List of Role</h2>
    <form method="post" style="border-radius: None; border: None; box-shadow: None;">
        <div style="position: relative;">
            <input type="text" id="searchInput" name="search_data" placeholder="Search..." value="{{ search_data }}" style="border-radius: 6px; width: 100%;">
            <i class="fa fa-search" id="searchBtn" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer;"></i>
        </div>
        <div class="user-table-container">
            <table class="user-data-table" id="access">
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Role Code</th>
                        <th>Role Name</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in role_data %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>{{ row.roleCode }}</td>
                        <td>{{ row.roleName }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </form>
</div>
{% endblock %}


{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const roleSelect    = document.getElementById("editSecondRole");
    const roleNameInput = document.querySelector("#editSecondForm input[name='roleName']");

    async function fetchRoleData(roleCode) {
        if (!roleCode) return;

        try {
            const resp = await fetch(`/get_role/${encodeURIComponent(roleCode)}`);
            const role = await resp.json();

            if (role.error) {
                alert(role.error);
                return;
            }

            // Fill department name
            roleNameInput.value = role.roleName || "";

        } catch (err) {
            console.error("Error fetching role:", err);
        }
    }

    if (roleSelect) {
        roleSelect.addEventListener("change", () => {
            fetchRoleData(roleSelect.value);
        });

        // Auto-fill on page load if already selected
        if (roleSelect.value) {
            fetchRoleData(roleSelect.value);
        }
    }
});

document.addEventListener("DOMContentLoaded", () => {
    const roleSelect = document.getElementById("selectRole"); // Edit section role dropdown
    const userSelect = document.getElementById("selectUser"); // Edit section user dropdown

    // Map dropdown name â†’ bit position
    const permissionMap = {
        "homepage_id": 0,
        "course_id": 1,
        "department_id": 2,
        "venue_id": 3,
        "exam_id": 4,
        "staff_id": 5,
        "timetable_id": 6,
        "inv_timetable_id": 7,
        "inv_report_id": 8,
        "access_id": 9,
        "activity_id": 10,
        "profile_id": 11
    };

    function setDropdownsFromValue(value) {
        Object.entries(permissionMap).forEach(([name, bit]) => {
            const select = document.querySelector(`select[name="${name}"]`);
            if (!select) return;
            const isAllowed = (value & (1 << bit)) !== 0;
            select.value = isAllowed ? "1" : "0";
        });
    }

    async function fetchRoleValue(roleCode) {
        if (!roleCode) return;
        try {
            const resp = await fetch(`/get_role/${encodeURIComponent(roleCode)}`);
            const data = await resp.json();
            if (data.error) return;
            // Role value must be passed from backend, e.g., roleValue
            setDropdownsFromValue(data.roleValue || 0);
        } catch (err) {
            console.error("Error fetching role value:", err);
        }
    }

    async function fetchUserAccess(userId) {
        if (!userId) return;
        try {
            const resp = await fetch(`/get_user/${encodeURIComponent(userId)}`);
            const data = await resp.json();
            if (data.error) return;
            setDropdownsFromValue(data.userAccess || 0);
        } catch (err) {
            console.error("Error fetching user access:", err);
        }
    }

    function resetDropdowns() {
        Object.keys(permissionMap).forEach(name => {
            const select = document.querySelector(`select[name="${name}"]`);
            if (select) select.value = "";
        });
    }

    if (roleSelect) {
        roleSelect.addEventListener("change", () => {
            resetDropdowns();
            fetchRoleValue(roleSelect.value);
        });

        // Prefill if already selected
        if (roleSelect.value) fetchRoleValue(roleSelect.value);
    }

    if (userSelect) {
        userSelect.addEventListener("change", () => {
            resetDropdowns();
            fetchUserAccess(userSelect.value);
        });
    }
});
</script>
{% endblock %}
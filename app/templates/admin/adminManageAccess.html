{% extends "admin/adminBase.html" %}
{% set show_tabs = true %}
{% set user_access = true %}
{% set show_manual = true %}
{% set show_second_edit = true %}
{% set show_edit = true %}
{% set show_upload = false %}
{% set show_cal = false %}
{% set show_dashboard = false %}
{% block title %}ManageAccess{% endblock %}
{% block head_title %}<h2>Manage Access</h2>{% endblock %}

{% block manual_section %}
<!-- Manual Form -->
<form id="manualForm" action="{{ url_for('admin_manageAccess') }}" method="POST" enctype="multipart/form-data">
    <div id="manualSection" class="function-frame">
        <h4 style="text-align: center;">Manual Data Entry Section</h4>
        <div class="profile-frame">
            <div class="form-profile">
                <label>Role Code</label>
                <input type="text" name="roleCode" required>
            </div>
            <div class="form-profile">
                <label>Role Name</label>
                <input type="text" name="roleName" required>
            </div>
        </div><br>

        <!-- Permissions -->
        <div class="profile-frame" style="justify-content: center; width: 100%;">
            {% set perms = ['homepage','course','department','venue','exam','staff','timetable','inv_timetable','inv_report','access','activity','profile'] %}
            {% for i in range(0, perms|length, 3) %}
                <div class="profile-frame" style="width: 100%">
                    <div class="form-profile" style="width: 55%;">
                        {% for j in range(3) %}
                            {% set p = perms[i+j] if perms[i+j] is defined else '' %}
                            {% if p %}
                                <input type="text" name="{{ p }}" value="{{ p|capitalize }}" placeholder="{{ p|capitalize }}" readonly>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <div class="form-profile" style="width: 40%;">
                        {% for j in range(3) %}
                            {% set p = perms[i+j] if perms[i+j] is defined else '' %}
                            {% if p %}
                                <select name="add_{{ p }}_id" required>
                                    <option value="" disabled selected>-- Select Access --</option>
                                    <option value="0">Not Allowed</option>
                                    <option value="1">Allow</option>
                                </select>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        </div>

        <input type="hidden" name="form_type" value="manual">
        <br><br>
        <div class="button-wrapper">
            <button type="submit">Add A New Role</button>
        </div>
    </div>
</form>
{% endblock %}

{% block edit_second_section %}
<!-- Edit Role Name / Delete -->
<form id="editSecondForm" action="{{ url_for('admin_manageAccess') }}" method="POST" enctype="multipart/form-data">
    <div id="editSecondSection" class="function-frame">
        <h4 style="text-align: center;">Edit Existing Role</h4>
        <div class="profile-frame">
            <div class="form-profile">
                <label>Select Role</label>
                <select id="editSecondRole" name="editSecondRole" required>
                    <option value="" disabled selected>-- Select Role --</option>
                    {% for role in role_data %}
                        <option value="{{ role.roleCode }}"
                                {% if role_select and role.roleCode == role_select.roleCode %}selected{% endif %}>
                            [{{ role.roleCode }}] - {{ role.roleName }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-profile">
                <label>Role Name</label>
                <input type="text" name="roleName" value="{{ role_select.roleName if role_select else '' }}" required>
            </div>
        </div>
        <input type="hidden" name="form_type" value="second_edit">
        <br><br>
        <div class="button-wrapper" style="gap: 5%;">
            <button type="submit" name="action" value="update" class="btn-success">
                <i class="fas fa-check"></i> Update Role
            </button>
            <button type="submit" name="action" value="delete" class="btn-danger"
                    onclick="return confirm('Are you sure to delete this role?')">
                <i class="fas fa-trash"></i> Delete Role
            </button>
        </div>
    </div>
</form>
{% endblock %}

{% block edit_section %}
<!-- Edit Role/User Access -->
<form id="editForm" action="{{ url_for('admin_manageAccess') }}" method="POST" enctype="multipart/form-data">
    <div id="editSection" class="function-frame">
        <h4 style="text-align: center;">Edit Existing Role/User Access</h4>
        <div class="profile-frame">
            <div class="form-profile" style="width: 30%;">
                <label>Select Role</label>
                <select id="selectRole" name="selectRole">
                    <option value="" disabled selected>-- Select Role --</option>
                    {% for role in role_data %}
                        <option value="{{ role.roleCode }}"
                                {% if role_select and role.roleCode == role_select.roleCode %}selected{% endif %}>
                            [{{ role.roleCode }}] - {{ role.roleName }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-profile" style="width: 30%;">
                <label>Select Staff</label>
                <select id="selectUser" name="selectUser">
                    <option value="" disabled selected>-- Select Staff --</option>
                    {% for staff in staff_data %}
                        <option value="{{ staff.userId }}"
                                {% if staff_select and staff.userId == staff_select.userId %}selected{% endif %}>
                            [{{ staff.userId }}] - {{ staff.userName }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div><br>

        <!-- Permissions -->
        <div class="profile-frame" style="justify-content: center; width: 100%;">
            {% set perms = ['homepage','course','department','venue','exam','staff','timetable','inv_timetable','inv_report','access','activity','profile'] %}
            {% for i in range(0, perms|length, 3) %}
                <div class="profile-frame" style="width: 100%">
                    <div class="form-profile" style="width: 55%;">
                        {% for j in range(3) %}
                            {% set p = perms[i+j] if perms[i+j] is defined else '' %}
                            {% if p %}
                                <input type="text" name="{{ p }}" value="{{ p|capitalize }}" placeholder="{{ p|capitalize }}" readonly>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <div class="form-profile" style="width: 40%;">
                        {% for j in range(3) %}
                            {% set p = perms[i+j] if perms[i+j] is defined else '' %}
                            {% if p %}
                                <select name="{{ p }}_id" required>
                                    <option value="" disabled selected>-- Select Access --</option>
                                    <option value="0">Not Allowed</option>
                                    <option value="1">Allow</option>
                                </select>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        </div>

        <input type="hidden" name="form_type" value="edit">
        <br><br>
        <div class="button-wrapper" style="gap: 5%;">
            <button type="submit" name="action" value="update" class="btn-success">
                <i class="fas fa-check"></i> Update Access
            </button>
        </div>
    </div>
</form>
{% endblock %}


{% block content %}
<div class="menu-section">
    <h2>List of Role</h2>
    <form method="post" style="border-radius: None; border: None; box-shadow: None;">
        <div style="position: relative;">
            <input type="text" id="searchInput" name="search_data" placeholder="Search..." value="{{ search_data }}" style="border-radius: 6px; width: 100%;">
            <i class="fa fa-search" id="searchBtn" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer;"></i>
        </div>
        <div class="user-table-container">
            <table class="user-data-table" id="access">
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Role Code</th>
                        <th>Role Name</th>
                        <th>Role Value</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in role_data %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>{{ row.roleCode }}</td>
                        <td>{{ row.roleName }}</td>
                        <td>{{ row.roleValue }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const roleSelect    = document.getElementById("editSecondRole");
    const roleNameInput = document.querySelector("#editSecondForm input[name='roleName']");
    const permissionMap = {
        "homepage_id": 0, "course_id": 1, "department_id": 2,
        "venue_id": 3, "exam_id": 4, "staff_id": 5,
        "timetable_id": 6, "inv_timetable_id": 7, "inv_report_id": 8,
        "access_id": 9, "activity_id": 10, "profile_id": 11
    };

    function setDropdownsFromValue(value) {
        Object.entries(permissionMap).forEach(([name, bit]) => {
            const select = document.querySelector(`select[name="${name}"]`);
            if (!select) return;
            select.value = (value & (1 << bit)) ? "1" : "0";
        });
    }

    async function fetchRoleValue(roleCode) {
        if (!roleCode) return;
        const resp = await fetch(`/get_role/${encodeURIComponent(roleCode)}`);
        const data = await resp.json();
        if (!data.error) {
            // Set permission dropdowns
            setDropdownsFromValue(data.roleValue || 0);

            // Set the role name input
            if (roleNameInput) {
                roleNameInput.value = data.roleName || '';
            }
        }
    }

    async function fetchUserAccess(userId) {
        if (!userId) return;
        const resp = await fetch(`/get_user/${encodeURIComponent(userId)}`);
        const data = await resp.json();
        if (!data.error) setDropdownsFromValue(data.userAccess || 0);
    }

    function resetDropdowns() {
        Object.keys(permissionMap).forEach(name => {
            const select = document.querySelector(`select[name="${name}"]`);
            if (select) select.value = "";
        });
    }

    // Edit second role name
    if (roleSelect) {
        roleSelect.addEventListener("change", () => {
            if (!roleSelect.value) {
                roleNameInput.value = '';
                resetDropdowns();
            } else {
                fetchRoleValue(roleSelect.value);
            }
        });
    }

    const roleEdit = document.getElementById("selectRole");
    const userEdit = document.getElementById("selectUser");
    if (roleEdit) roleEdit.addEventListener("change", () => { userEdit.value=""; resetDropdowns(); fetchRoleValue(roleEdit.value); });
    if (userEdit) userEdit.addEventListener("change", () => { roleEdit.value=""; resetDropdowns(); fetchUserAccess(userEdit.value); });
});
</script>
{% endblock %}
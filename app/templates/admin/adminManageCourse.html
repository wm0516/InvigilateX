{% extends "admin/adminBase.html" %}
{% set show_tabs = true %}
{% set show_upload = true %}
{% set show_cal = true %}
{% set show_dashboard = true %}
{% set show_manual = true %}
{% set show_edit = true %}
{% block title %}Admin ManageCourse{% endblock %}
{% block head_title %}<h2>Manage Course</h2>{% endblock %}  

{% block dashboard_section %}
<!-- Dashboard Form -->
<form id="dashboardForm" action="{{ url_for('admin_manageCourse') }}" method="POST">
    <div id="dashboardSection">
        <input type="hidden" name="form_type" value="dashboard">
        <div class="form-left" style="width: 100%">
            <!-- Overview -->
            <div class="dashboard-row" style="grid-template-columns: 1fr 1fr 1fr;">
                <div class="dashboard-frame">
                    <h3>Total Courses</h3>
                    <p class="dashboard-text" id="dashTotalCourse"></p>
                </div>
                <div class="dashboard-frame">
                    <h3>Courses With Missing Data/Error</h3>
                    <p class="dashboard-text" id="dashErrorCourse" style="color:red;"></p>
                </div>
                <div class="dashboard-frame pie">
                    <h3>Courses by Department</h3>
                    <canvas id="courseDeptPieChart"></canvas>
                </div>
                <div class="dashboard-frame">
                    <h3>Active Courses</h3>
                    <p class="dashboard-text" id="dashActiveCourse" style="color:green;"></p>
                </div>
                <div class="dashboard-frame">
                    <h3>Inactive Courses</h3>
                    <p class="dashboard-text" id="dashInactiveCourse" style="color:red;"></p>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}


{% block upload_section %}
<!-- Upload Form -->
<form id="uploadForm" action="{{ url_for('admin_manageCourse') }}" method="POST" enctype="multipart/form-data">
    <div id="uploadSection" class="function-frame" style="width:80%;">
        <div class="form-left" style="width: 100%;">
            <h4 style="text-align: center;">File Upload Section</h4>
            <label for="course_list">
                <div class="upload-container" id="courseUploadContainer">
                    <h4 style="text-align: center;">
                        Download Course Template <a href="{{ url_for('download_course_template') }}"><i>HERE</i></a>
                    </h4><br>
                    <div class="upload-text">
                        Please upload a file with the <b>first row left empty</b>.
                        Data should begin from columns <b>A to G</b>, with headers as follows:<br><br>
                        <i>[Program Code, Course Code, Course Section, Course Intake, Course Name, Credit Hour, No. of Students]</i><br><br>
                        You may also download an Excel template for your department using the links above.<br><br>
                        Click below to upload, or drag and drop a file (accepted formats: <b>XLSX, XLS, XLSM</b>).
                    </div><br>
                    <div id="courseSelectedFileName" class="file-name-display"></div>
                </div>
            </label>
            <input type="file" id="course_list" name="course_file" accept=".xlsx,.xls,.xlsm" style="display: none;">
            <input type="hidden" name="form_type" value="upload">
            <br>
            <div class="button-wrapper">
                <button type="submit">Upload Course</button>
            </div>
        </div>
    </div>
</form>
{% endblock %}


{% block manual_section %}
<!-- Manual Form -->
<form id="manualForm" action="{{ url_for('admin_manageCourse') }}" method="POST" enctype="multipart/form-data">
    <div id="manualSection" class="function-frame">
        <h4 style="text-align: center;">Manual Data Entry Section</h4>
        <div class="profile-frame">
            <div class="form-left">
                <label>Course Program</label>
                <select id="departmentCode" name="departmentCode" required>
                    <option value="" disabled selected>-- Select Department --</option>
                    {% for dept in department_data %}
                        <option value="{{ dept.departmentCode }}">
                            [{{ dept.departmentCode }}] {{ dept.departmentName }}
                        </option>
                    {% endfor %}
                </select><br>

                <div class="profile-frame" style="justify-content: space-between;">
                    <div class="form-left" style="width: 35%;">
                        <label>Course Code</label>
                        <input type="text" name="courseCode" value="{{ courseCode_text }}" required>
                    </div>
                    <div class="form-middle" style="width: 25%;">
                        <label>Course Section</label>
                        <input type="text" name="courseSection" value="{{ courseSection_text }}" required>
                    </div>
                    <div class="form-right" style="width: 35%;">
                        <label>Course Intake</label>
                        <select id="intakeSemester" name="intakeSemester" required>
                            <option value="" selected>-- Select Intake --</option>
                        </select>
                    </div>
                </div><br>

                <label>Course Name</label>
                <input type="text" name="courseName" value="{{ courseName_text }}" required>
            </div>

            <div class="form-middle">
                <label>Course Credit Hour(s)</label>
                <input type="number" name="courseHour" value="{{ courseHour_text }}" min="1" step="1" required><br>

                <label>Course Number of Student(s)</label>
                <input type="number" name="courseStudent" value="{{ courseStudent_text }}" min="1" step="1" required>
            </div>

            <div class="form-right">
                <label>Practical Lecturer (Optional)</label>
                <select id="practicalLecturerSelect" name="practicalLecturerSelect">
                    <option value="" selected>-- Select Practical Lecturer --</option>
                </select><br>

                <label>Tutorial Lecturer (Optional)</label>
                <select id="tutorialLecturerSelect" name="tutorialLecturerSelect">
                    <option value="" selected>-- Select Tutorial Lecturer --</option>
                </select><br>

                <label>Class Lecturer (Optional)</label>
                <select id="lecturerSelect" name="lecturerSelect">
                    <option value="" selected>-- Select Class Lecturer --</option>
                </select>
            </div>
        </div>
        
        <input type="hidden" name="form_type" value="manual">
        <br><br>

        <div class="button-wrapper">
            <button type="submit">Add New Course</button>
        </div>
    </div>
</form>
{% endblock %}

{% block edit_section %}
<!-- Edit Form -->
<form id="editForm" action="{{ url_for('admin_manageCourse') }}" method="POST">
    <div id="editSection" class="function-frame">
        <h4 style="text-align:center;">Edit Existing Courses</h4><br>

        <!-- Prefilled form (like manual section) -->
        <div class="profile-frame">
            <div class="form-left">
                <!-- Select Existing Course -->
                <label>Select Course Code/Section/Intake - Course Name</label>
                <select id="editCourseSelect" name="editCourseSelect" required>
                    <option value="" disabled selected>-- Select Course --</option>
                    {% for row in course_data %}
                        <option value="{{ row.courseCodeSectionIntake }}"
                            {% if course_select and course_select.courseCodeSectionIntake == row.courseCodeSectionIntake %}selected{% endif %}>
                            {{ row.courseCodeSectionIntake }} - {{ row.courseName }}
                        </option>
                    {% endfor %}
                </select><br>

                <div class="profile-frame" style="justify-content: space-between;">
                    <div class="form-left" style="width: 35%;">
                        <label>Course Code</label>
                        <input type="text" id="editCourseCode" name="courseCode" 
                            value="{{ course_select.courseCodeSectionIntake.split('/') [0] if course_select else '' }}" required>
                    </div>
                    <div class="form-middle" style="width: 25%;">
                        <label>Course Section</label>
                        <input type="text" id="editCourseSection" name="courseSection" 
                            value="{{ course_select.courseCodeSectionIntake.split('/') [1] if course_select else '' }}" required>
                    </div>
                    <div class="form-right" style="width: 35%;">
                        <label>Course Intake</label>
                        <select id="intakeSemesterEdit" name="intakeSemesterEdit" required>
                            <option value="{{ course_select.courseCodeSectionIntake.split('/') [2] if course_select else '' }}" selected>
                                {{ course_select.courseCodeSectionIntake.split('/') [2] if course_select else '-- Select Intake --' }}
                            </option>
                        </select>
                    </div>
                </div><br>

                <label>Course Name</label>
                <input type="text" id="editCourseName" name="courseName" value="{{ course_select.courseName if course_select else '' }}" required>
            </div>

            <div class="form-middle">
                <label>Course Program</label>
                <select id="editDepartment" name="departmentCode" required>
                    <option value="" disabled selected>-- Select Department --</option>
                    {% for dept in department_data %}
                        <option value="{{ dept.departmentCode }}">{{ dept.departmentCode }} - {{ dept.departmentName }}</option>
                    {% endfor %}
                </select><br>

                <div class="profile-frame" style="justify-content: space-between;">
                    <div class="form-left" style="width: 48%;">
                        <label>Course Credit Hour(s)</label>
                        <input type="number" id="editCourseHour" name="courseHour" min="1" step="1" value="{{ course_select.courseHour if course_select else '' }}" required>
                    </div>
                    <div class="form-middle" style="width: 48%;">
                        <label>Course Number of Student(s)</label>
                        <input type="number" id="editCourseStudents" name="courseStudent" min="1" step="1" value="{{ course_select.courseStudent if course_select else '' }}" required>
                    </div>
                </div><br>

                <label>Course Status</label>
                <select id="editCourseStatus" name="courseStatus" required>
                    <option value="" disabled selected>-- Select Status --</option>
                    <option value="1">Activated</option>   <!-- True -->
                    <option value="0">Deactivated</option> <!-- False -->
                </select>
            </div>

            <div class="form-right">
                <label>Practical Lecturer (Optional)</label>
                <select id="editPracticalLecturer" name="practicalLecturerSelect">
                    <option value="" selected>-- Select Practical Lecturer --</option>
                </select><br>

                <label>Tutorial Lecturer (Optional)</label>
                <select id="editTutorialLecturer" name="tutorialLecturerSelect">
                    <option value="" selected>-- Select Tutorial Lecturer --</option>
                </select><br>

                <label>Class Lecturer (Optional)</label>
                <select id="editLecturer" name="lecturerSelect">
                    <option value="" selected>-- Select Class Lecturer --</option>
                </select>
            </div>
        </div>
        <input type="hidden" name="form_type" value="edit">
        <br><br>

        <div class="button-wrapper">
            <button type="submit" name="action" value="update" style="background-color: #d4edda; color: #155724;">
                <i class="fas fa-check"></i> Update Course
            </button>
        </div>
    </div>
</form>
{% endblock %}


{% block content %}
<div class="menu-section">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>List of Courses</h2>
        <div style="display: flex; align-items: center; gap: 10px;">
            <div style="position: relative;">
                <input type="text" id="searchInput" name="search_courses" placeholder="Search..." value="{{ search_courses }}" style="border-radius: 6px; width: 100%;">
                <i class="fa fa-search" id="searchBtn" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer;"></i>
            </div>
            <div class="button-wrapper">
                <button id="generatePDF" style="background-color: black;">Download as PDF</button>
            </div>
        </div>
    </div>
    <div id="noResults" style="display: none; text-align: center; font-weight: bold; color: #b00;">No results found.</div>

    <div class="user-table-container">
        <table class="user-data-table" id="manageCourse">
            <thead>
                <tr>
                    <th>No</th>
                    <th>Status</th>
                    <th>Course Code/Section/Intake</th>
                    <th>Course Name</th>
                    <th>Credit Hour(s)</th>
                    <th>Program</th>
                    <th>No. of Students</th>
                    <th>Exam ID</th>
                    <th>Lecturer Details</th>
                </tr>   
            </thead>
            <tbody>
                {% for row in course_data %}
                    <tr class="
                        {% if row.courseStatus == 0 %}
                            inactive-row-show
                        {% elif row.courseDepartment is none %}
                            error-row-show
                        {% endif %}
                    ">
                        <td class="row-number"></td>
                        <td>
                            {% if row.courseStatus %}
                                <span class="status frame-completed">
                                    Activated
                                </span>
                            {% else %}
                                <span class="status frame-expired">Inactivated</span>
                            {% endif %}
                        </td>
                        <td>{{ row.courseCodeSectionIntake }}</td>
                        <td>{{ row.courseName }}</td>
                        <td>{{ row.courseHour }}</td>
                        <td>{{ row.courseDepartment }}</td>
                        <td>{{ row.courseStudent }}</td>
                        <td>
                            {{ row.courseExamId if row.courseExamId else '<span>None</span>' | safe }}
                        </td>                        
                        <td>
                            <div class="info-grid">
                                {% if row.practicalLecturer and row.practicalLecturer.userName %}
                                    <div>Practical</div><div><strong>: {{ row.practicalLecturer.userName }}</strong></div>
                                {% endif %}

                                {% if row.tutorialLecturer and row.tutorialLecturer.userName %}
                                    <div>Tutorial</div><div><strong>: {{ row.tutorialLecturer.userName }}</strong></div>
                                {% endif %}

                                {% if row.classLecturer and row.classLecturer.userName %}
                                    <div>Class</div><div><strong>: {{ row.classLecturer.userName }}</strong></div>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
/* =========================================================
   CORE UTILITIES
========================================================= */

function renumberVisibleRows() {
    const rows = document.querySelectorAll("#manageCourse tbody tr");
    let index = 1;
    rows.forEach(row => {
        if (row.offsetParent !== null) {
            const cell = row.querySelector(".row-number");
            if (cell) cell.textContent = index++;
        }
    });
}

let deptChart = null;
function updateDashboardFromTable() {
    const rows = document.querySelectorAll("#manageCourse tbody tr");
    const visibleRows = [...rows].filter(r => r.offsetParent !== null);

    let active = 0, inactive = 0, error = 0;
    const deptCount = {};

    visibleRows.forEach(r => {
        const statusText = r.children[1].innerText.trim();
        statusText === "Activated" ? active++ : inactive++;

        if (r.classList.contains("error-row-show")) error++;

        const dept = r.children[5].innerText.trim() || "Unknown";
        deptCount[dept] = (deptCount[dept] || 0) + 1;
    });

    document.getElementById("dashTotalCourse").textContent = visibleRows.length;
    document.getElementById("dashActiveCourse").textContent = active;
    document.getElementById("dashInactiveCourse").textContent = inactive;
    document.getElementById("dashErrorCourse").textContent = error;

    if (deptChart) deptChart.destroy();

    deptChart = new Chart(document.getElementById("courseDeptPieChart"), {
        type: "pie",
        data: {
            labels: Object.keys(deptCount),
            datasets: [{
                data: Object.values(deptCount),
                backgroundColor: [
                    "#FF6384", "#36A2EB", "#FFCE56",
                    "#4BC0C0", "#9966FF", "#FF9F40",
                    "#66FFB2", "#C7C7C7"
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { position: "right" } }
        }
    });
}

/* =========================================================
   INITIALIZERS
========================================================= */

function initEditForm() {
    const editCourseSelect = document.getElementById("editCourseSelect");
    if (!editCourseSelect) return;

    const editCourseCode = document.getElementById("editCourseCode");
    const editCourseSection = document.getElementById("editCourseSection");
    const editIntake = document.getElementById("intakeSemesterEdit");
    const editCourseName = document.getElementById("editCourseName");
    const editDept = document.getElementById("editDepartment");
    const editCourseHour = document.getElementById("editCourseHour");
    const editCourseStudents = document.getElementById("editCourseStudents");
    const editStatus = document.getElementById("editCourseStatus");
    const editPractical = document.getElementById("editPracticalLecturer");
    const editTutorial = document.getElementById("editTutorialLecturer");
    const editLecturer = document.getElementById("editLecturer");

    function populateLecturers(deptCode, practicalSel, tutorialSel, lecturerSel, p = null, t = null, l = null) {
        practicalSel.innerHTML = '<option value="">None</option>';
        tutorialSel.innerHTML = '<option value="">None</option>';
        lecturerSel.innerHTML = '<option value="">None</option>';
        if (!deptCode) return;

        fetch(`/get_lecturers_by_department/${encodeURIComponent(deptCode)}`)
            .then(r => r.json())
            .then(list => {
                list.forEach(u => {
                    [[practicalSel, p], [tutorialSel, t], [lecturerSel, l]].forEach(([sel, selected]) => {
                        const opt = new Option(u.userName.trim(), u.userId);
                        if (u.userId == selected) opt.selected = true;
                        sel.appendChild(opt);
                    });
                });
            });
    }

    editCourseSelect.addEventListener("change", e => {
        const value = e.target.value;
        if (!value) return;

        const [code, section, intake] = value.split("/");
        editCourseCode.value = code || "";
        editCourseSection.value = section || "";

        [...editIntake.options].forEach((o, i) => {
            if (o.value === intake) editIntake.selectedIndex = i;
        });

        fetch(`/get_courseCodeSection/${encodeURIComponent(value)}`)
            .then(r => r.json())
            .then(c => {
                if (c.error) return alert(c.error);
                editCourseName.value = c.courseName || "";
                editDept.value = c.courseDepartment || "";
                editCourseHour.value = c.courseHour || "";
                editCourseStudents.value = c.courseStudent || "";
                editStatus.value = c.courseStatus ? "1" : "0";

                populateLecturers(
                    c.courseDepartment,
                    editPractical, editTutorial, editLecturer,
                    c.coursePractical, c.courseTutorial, c.courseLecturer
                );
            });
    });
}

function initPDF() {
    const btn = document.getElementById("generatePDF");
    if (!btn) return;

    btn.addEventListener("click", () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: "landscape", unit: "pt", format: "a4" });

        const table = document.querySelector(".user-data-table");
        if (!table) return alert("No table found");

        const headers = [...table.querySelectorAll("thead th")].map(th => th.innerText);
        const rows = [...table.querySelectorAll("tbody tr")]
            .filter(r => r.offsetParent !== null)
            .map(r => [...r.children].map(td => td.innerText.trim()));

        doc.text("Admin View - Courses", 420, 30, { align: "center" });
        doc.autoTable({ head: [headers], body: rows, startY: 50 });
        doc.save("Admin_ViewCourseList.pdf");
    });
}

function initIntakeDropdowns() {
    const year = new Date().getFullYear();
    const map = {
        [year - 1]: ["AUG", "OCT"],
        [year]: ["JAN", "APR", "AUG", "OCT"],
        [year + 1]: ["JAN", "APR"]
    };

    ["intakeSemester", "intakeSemesterEdit"].forEach(id => {
        const sel = document.getElementById(id);
        if (!sel) return;
        Object.entries(map).forEach(([y, months]) =>
            months.forEach(m => sel.add(new Option(`${m}${y}`, `${m}${y}`)))
        );
    });
}

function initObserver() {
    const tbody = document.querySelector("#manageCourse tbody");
    if (!tbody) return;

    const observer = new MutationObserver(() => {
        renumberVisibleRows();
        updateDashboardFromTable();
    });

    observer.observe(tbody, { subtree: true, attributes: true, attributeFilter: ["style"] });
}

/* =========================================================
   MAIN BOOTSTRAP
========================================================= */

document.addEventListener("DOMContentLoaded", () => {
    initEditForm();
    initPDF();
    initIntakeDropdowns();

    initIntakeSwipe({
        tableId: "manageCourse",
        intakeCol: 2,
        noResults: "noResults"
    });

    initObserver();
    renumberVisibleRows();
    updateDashboardFromTable();
});

window.addEventListener("load", () => {
    renumberVisibleRows();
    updateDashboardFromTable();
});
</script>

{% endblock %}


<!DOCTYPE html>
<html lang="en">
<head>
    <title>{% block title %}{% endblock %}</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
</head>
<body class="{{ body_class | default('') }}">
    <header class="header">
        <div class="toggle-btn" onclick="toggleSidebar()" aria-label="Toggle sidebar">
            <i class="fas fa-bars"></i>
        </div>
        <div class="user-info">
            {{ user_name }} [{{ user_id }}] | ADMIN of {{ user_department }} | <span id="current-datetime"></span>
        </div>
    </header>

    <div class="content-container">
        <nav class="sidebar" id="sidebar">
            <div class="tab-nav">
                <a href="{{ url_for('admin_homepage') }}" class="tab-link {% if active_tab == 'admin_hometab' %}active{% endif %}">
                    <i class="fas fa-house"></i>
                    <span>Home</span>
                </a>
                <a href="{{ url_for('admin_manageCourse') }}" class="tab-link {% if active_tab == 'admin_manageCoursetab' %}active{% endif %}">
                    <i class="fas fa-book-open"></i>
                    <span>Manage Course</span>
                </a>
                <a href="{{ url_for('admin_manageDepartment') }}" class="tab-link {% if active_tab == 'admin_manageDepartmenttab' %}active{% endif %}">
                    <i class="fas fa-building-columns"></i>
                    <span>Manage Department</span>
                </a>
                <a href="{{ url_for('admin_manageVenue') }}" class="tab-link {% if active_tab == 'admin_manageVenuetab' %}active{% endif %}">
                    <i class="fas fa-school"></i>
                    <span>Manage Venue</span>
                </a>
                <a href="{{ url_for('admin_manageExam') }}" class="tab-link {% if active_tab == 'admin_manageExamtab' %}active{% endif %}">
                    <i class="fas fa-clipboard-list"></i>
                    <span>Manage Exam</span>
                </a>
                <a href="{{ url_for('admin_manageStaff') }}" class="tab-link {% if active_tab == 'admin_manageStafftab' %}active{% endif %}">
                    <i class="fas fa-user-tie"></i>
                    <span>Manage Staff</span>
                </a>
                <a href="{{ url_for('admin_manageTimetable') }}" class="tab-link {% if active_tab == 'admin_manageTimetabletab' %}active{% endif %}">
                    <i class="fas fa-calendar-check"></i>
                    <span>Manage Timetable</span>
                </a>
                <a href="{{ url_for('admin_manageInvigilationTimetable') }}" class="tab-link {% if active_tab == 'admin_manageInvigilationTimetabletab' %}active{% endif %}">
                    <i class="fas fa-business-time"></i>
                    <span>Manage Invigilation Timetable</span>
                </a>
                <a href="{{ url_for('admin_manageInvigilationReport') }}" class="tab-link {% if active_tab == 'admin_manageInvigilationReporttab' %}active{% endif %}">
                    <i class="fas fa-file-alt"></i>
                    <span>Manage Invigilation Report</span>
                </a>                
                <a href="{{ url_for('admin_manageAccess') }}" class="tab-link {% if active_tab == 'admin_manageAccesstab' %}active{% endif %}">
                    <i class="fas fa-cog fa-spin"></i>
                    <span>Manage Access</span>
                </a>
                <a href="{{ url_for('admin_activity') }}" class="tab-link {% if active_tab == 'admin_activitytab' %}active{% endif %}">
                    <i class="fas fa-cog fa-spin"></i>
                    <span>Activity</span>
                </a>
                <a href="{{ url_for('admin_profile') }}" class="tab-link {% if active_tab == 'admin_profiletab' %}active{% endif %}">
                    <i class="fas fa-user-circle"></i>
                    <span>Profile</span>
                </a>
                <a href="{{ url_for('logout') }}" class="logout-btn">
                    <i class="fas fa-right-from-bracket"></i>
                    <span>Logout</span>
                </a>
            </div>
        </nav>

        <main class="main-content">
            {% block head_title %}{% endblock %}
            {% if show_tabs %}
                <!-- Top Navigation Tabs -->
                <div class="tab-container">
                    {% if show_cal %}
                    <div class="intake-swipe">
                        <button id="prevIntake" class="intake-btn">
                            <i class="fas fa-chevron-left"></i>
                        </button>

                        <div class="intake-display">
                            <span id="prevLabel" class="intake-side"></span>
                            <span id="currentIntake" class="intake-current"></span>
                            <span id="nextLabel" class="intake-side"></span>
                        </div>

                        <button id="nextIntake" class="intake-btn">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    {% endif %}

                    <div class="second-nav">
                        {% if show_dashboard %}
                            <a href="#dashboard" class="tab-link active" data-section="dashboardSection">
                                <i class="fas fa-chart-line"></i>
                                <span>Dashboard</span>
                            </a>
                        {% endif %}

                        {% if show_upload %}
                            <a href="#upload" class="tab-link" data-section="uploadSection">
                                <i class="fas fa-upload"></i>
                                <span>Upload File</span>
                            </a>
                        {% endif %}

                        {% if show_manual %}
                            <a href="#manual" class="tab-link" data-section="manualSection">
                                <i class="fas fa-plus"></i>
                                {% if access %}
                                    <span>Insert New Role</span>
                                {% else %}
                                    <span>Manually Insert</span>
                                {% endif %}
                            </a>
                        {% endif %}

                        {% if show_second_edit %}
                            <a href="#editSecondSection" class="tab-link" data-section="editSecondSection">
                                <i class="fas fa-edit"></i>
                                <span>Editing Role</span>
                            </a>
                        {% endif %}

                        {% if show_edit %}
                            <a href="#edit" class="tab-link" data-section="editSection">
                                <i class="fas fa-edit"></i>
                                {% if access %}
                                    <span>Editing Role Access</span>
                                {% else %}
                                    <span>Editing</span>
                                {% endif %}
                            </a>
                        {% endif %}
                    </div>
                </div>

                <!-- Flash Message Section -->
                {% set flashes = get_flashed_messages(with_categories=true) %}
                {% if uploadResult or uploadErrors or flashes %}
                    <div class="messages-container">
                        {% if uploadResult %}
                            <div class="result-message">{{ uploadResult }}</div>
                        {% elif uploadErrors %}
                            <div class="error-message">{{ uploadErrors }}</div>
                        {% elif flashes %}
                            {% for category, message in flashes %}
                                <div class="alert alert-{{ category }}">
                                    <strong>{{ category.capitalize() }}:</strong> {{ message }}
                                </div>
                            {% endfor %}
                        {% endif %}
                    </div><br>
                {% endif %}

                <!-- Tab Content Sections -->
                {% if show_cal %}
                    {% block cal_section %}{% endblock %}
                {% endif %}
                {% if show_dashboard %}
                    {% block dashboard_section %}{% endblock %}
                {% endif %}
                {% if show_upload %}
                    {% block upload_section %}{% endblock %}
                {% endif %}
                {% if show_manual %}
                    {% block manual_section %}{% endblock %}
                {% endif %}
                {% if show_second_edit %}
                    {% block edit_second_Section %}{% endblock %}
                {% endif %}
                {% if show_edit %}
                    {% block edit_section %}{% endblock %}
                {% endif %}
            {% endif %}
            <br>

            <!-- Main Page-Specific Content -->
            {% block content %}{% endblock %}
        </main>
    </div>

    <!-- Javascript control the navigation -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-3d@1.0.0"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/highcharts-3d.js"></script>
    <script src="{{ url_for('static', filename='js/function.js') }}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        function updateDateTime() {
            const now = new Date();
            const options = { weekday: 'long',day: '2-digit', month: 'short', year: 'numeric',hour: '2-digit', minute: '2-digit', second: '2-digit',hour12: false };
            const formatted = now.toLocaleString('en-GB', options).replace(',', ':');
            document.getElementById("current-datetime").textContent = formatted;
        }
        updateDateTime(); // initial run
        setInterval(updateDateTime, 1000); // update every second
        
       function initIntakeSwipe({tableId, intakeCol, dashboardUpdater, noResultsId = null}) {
        const $ = id => document.getElementById(id);
        const rows = document.querySelectorAll(`#${tableId} tbody tr`);

        // Auto-generate JANâ€“DEC
        const order = Array.from({ length: 12 }, (_, i) =>
            new Date(2000, i).toLocaleString('en', { month: 'short' }).toUpperCase()
        );

        const now = new Date();
        let state = {
            year: now.getFullYear(),
            intake: order[now.getMonth()]
        };

        function shift(dir) {
            let i = order.indexOf(state.intake) + dir;
            let y = state.year;

            if (i < 0) { i = order.length - 1; y--; }
            if (i >= order.length) { i = 0; y++; }
            state = { intake: order[i], year: y };
            render();
        }

        function getAdjacent(dir) {
            let i = order.indexOf(state.intake) + dir;
            let y = state.year;

            if (i < 0) { i = order.length - 1; y--; }
            if (i >= order.length) { i = 0; y++; }
            return { intake: order[i], year: y };
        }

        function render() {
            const key = state.intake + state.year;
            $("currentIntake").textContent = key;

            const prev = getAdjacent(-1);
            const next = getAdjacent(1);
            $("prevLabel").textContent = prev.intake + prev.year;
            $("nextLabel").textContent = next.intake + next.year;

            let visible = 0;
            rows.forEach(r => {
                const cellText = r.children[intakeCol]?.innerText || "";
                const match = cellText.includes(key);
                r.style.display = match ? "" : "none";
                if (match) visible++;
            });

            if (noResultsId) {
                $(noResultsId).style.display = visible ? "none" : "block";
            }
            renumberVisibleRowsExam?.();
            dashboardUpdater?.();
        }
        $("prevIntake").onclick = () => shift(-1);
        $("nextIntake").onclick = () => shift(1);
        render();
    }

    </script>
    {% block extra_scripts %}{% endblock %}
</body>
</html>
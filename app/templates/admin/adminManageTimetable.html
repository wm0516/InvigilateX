{% extends "admin/adminBase.html" %}
{% set show_tabs = true %}
{% set show_upload = true %}
{% set show_announce = true %}
{% set show_manual = false %}
{% block title %}Admin ManageTimetable{% endblock %}
{% block head_title %}<h2>Manage Timetable</h2>{% endblock %}

{% block announce_section %}
<!-- Announce Form -->
<form id="announceForm" action="{{ url_for('admin_manageTimetable') }}" method="POST" enctype="multipart/form-data">
    <div id="announceSection" class="function-frame">
        <input type="hidden" name="form_type" value="announce">
        <div class="form-left" style="width: 100%">
        </div>
    </div>  
</form>
{% endblock %}

{% block upload_section %}
<form id="uploadForm" action="{{ url_for('admin_manageTimetable') }}" method="POST" enctype="multipart/form-data">
    {% if not files %}
        {% if not authorized %}
            <a href="{{ url_for('authorize') }}" class="btn btn-primary">Click here to authorize Google Drive</a>
        {% else %}
            <a href="{{ url_for('fetch_drive_files') }}" class="btn btn-success">Click here to load files from Google Drive</a>
        {% endif %}
    {% endif %}

    {% if files %}
        <!-- Refresh Button -->
        <a href="{{ url_for('fetch_drive_files') }}" class="btn btn-warning">Click here to refresh the files from Google Drive</a>
        <br><br>

        <h3>PDF Files from SOC Folder:</h3>
        <a href="{{ url_for('extract_all') }}" class="btn btn-danger">
            Extract & Save All Timetables to Database
        </a>
        <br><br><br>

        <div class="menu-grid" style="grid-template-columns: repeat(4, 1fr);">
            {% for file in files %}
                <div>
                    <button type="button" onclick="previewTimetable('{{ file.id }}')">Preview</button>
                    <a href="{{ file.webViewLink }}" target="_blank">
                        {{ loop.index }}. {{ file.name }}
                    </a>
                </div>
            {% endfor %}
        </div>
        <br><br><br>

        <div id="previewArea" style="max-height: 400px; overflow-y: auto; border:1px solid #ccc; padding:1%;">
            <h4>Preview Result</h4>
            <pre id="previewContent">Click a preview button to load timetable...</pre>
        </div>
    {% endif %}
</form>
{% endblock %}


{% block content %}
<div class="menu-section">
    <h2>Timetable</h2>
    <div class="profile-frame">
        <!-- Filter Section -->
        <div class="form-right">
            <form method="get" style="display:flex; align-items:center; gap:8px;">
                <label for="lecturer">Select Lecturer:</label>
                <select name="lecturer" id="lecturer" onchange="this.form.submit()">
                    <option value="">All Lecturers</option>
                    {% for lecturer in lecturers %}
                        <option value="{{ lecturer }}" {% if lecturer == selected_lecturer %}selected{% endif %}>
                            {{ lecturer }}
                        </option>
                    {% endfor %}
                </select>
            </form>
        </div>
    </div>
    
    {% set time_slots = ["07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"] %}
    {% set week_days = ["MON", "TUE", "WED", "THU", "FRI"] %}

    <!-- Timetable Grid -->
    <div class="user-table-container">
        <table class="user-data-table" border="1">
            <thead>
                <tr>
                    <th>Day / Time</th>
                    {% for time in time_slots %}
                        <th>{{ time }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for day in week_days %}
                <tr>
                    <td><strong>{{ day }}</strong></td>
                    {% for time in time_slots %}
                    <td>
                        {% for row in timetable_data %}
                            {% set class_day = row.classDay.upper() %}
                            {% set class_time = row.classTime %}
                            {% set start_time = class_time.split('-')[0] %}
                            {% set end_time = class_time.split('-')[1] %}
                            {% if class_day == day and time >= start_time and time < end_time %}
                                <div style="border: 1px solid #999; margin: 2px; padding: 2px;">
                                    <strong>{{ row.lecturerName }}</strong><br>
                                    <strong>[{{ row.classType }}]</strong><br>
                                    {{ row.courseName }}<br>
                                    Room: {{ row.classRoom }}
                                </div>
                            {% endif %}
                        {% endfor %}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
function previewTimetable(fileId) {
    document.getElementById("previewContent").textContent = "Loading...";
    fetch(`/admin/preview_timetable/${fileId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById("previewContent").textContent = JSON.stringify(data, null, 2);
        })
        .catch(err => {
            document.getElementById("previewContent").textContent = "Error: " + err;
        });
}
</script>

{% endblock %}

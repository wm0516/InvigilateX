{% extends "admin/adminBase.html" %}
{% set show_tabs = true %}
{% set show_upload = true %}
{% set show_dashboard = true %}
{% set show_manual = false %}
{% block title %}Admin ManageTimetable{% endblock %}
{% block head_title %}<h2>Manage Timetable</h2>{% endblock %}

{% block dashboard_section %}
<!-- Dashboard Form -->
<form id="dashboardForm" action="{{ url_for('admin_manageTimetable') }}" method="POST">
    <div id="dashboardSection" class="function-frame">
        <input type="hidden" name="form_type" value="dashboard">
        <div class="form-left" style="width: 100%">
        </div>
    </div>  
</form>
{% endblock %} 

{% block upload_section %}
<!-- Upload Form -->
<form id="uploadForm" action="{{ url_for('admin_manageTimetable') }}" method="POST" enctype="multipart/form-data">
    <div id="uploadSection" style="margin: auto;">
        <div class="form-left" style="width: 100%">
            <h4 style="text-align: center;">File Upload Section</h4>
            <label for="timetable_list">
                <div class="upload-container" style="width: 80%;" id="timetableUploadContainer">
                    <div class="upload-text">
                        Upload in PDF file format<br><br><br>
                        Click to upload or drag and drop with below file format
                    </div>
                    <div class="file-types">PDF ONLY</div><br>
                    <!-- Selected file display -->
                    <div id="timetableSelectedFileName" class="file-name-display"></div>
                </div>
            </label>
            <input type="file" id="timetable_list" name="timetable_file[]" accept=".pdf" style="display: none;" multiple>
            <input type="hidden" name="form_type" value="upload">
            <br>

            <!-- Upload Form Submit -->
            <div class="button-wrapper">
                <button type="submit">Upload and Preview Lecturer Timetable</button>
            </div>

            {% if results %}
            <h3>Uploaded Files:</h3>
            <div class="menu-grid" style="grid-template-columns: repeat(4, 1fr);">
                {% for file in results %}
                    <div>
                        <button type="button" onclick='previewUploadedTimetable({{ file | tojson | safe }})'>Preview</button>
                        {{ loop.index }}. {{ file.filename }}
                    </div>
                {% endfor %}
            </div>
            <br><br>

            <div id="uploadPreviewArea" style="max-height: 400px; overflow-y: auto; border:1px solid #ccc; padding:1%;">
                <h4>Preview Result</h4>
                <pre id="uploadPreviewContent">Click a preview button to load timetable...</pre>
            </div>
            {% endif %}
        </div>
    </div>
</form>
{% endblock %}

{% block content %}
<div class="menu-section">
    <h2>Timetable</h2>
    <div class="profile-frame">
        <!-- Filter Section -->
        <div class="form-right" style="width: None;">
            <form method="get" style="display:flex; align-items:center; gap:8px;">
                <label for="lecturer">Select_Lecturer:</label>
                <select name="lecturer" id="lecturer" onchange="this.form.submit()">
                    <option value="">All Lecturers</option>
                    {% for lecturer in lecturers %}
                        <option value="{{ lecturer }}" {% if lecturer == selected_lecturer %}selected{% endif %}>
                            {{ lecturer }}
                        </option>
                    {% endfor %}
                </select>
                
                <!-- Add a "Clear Filter" button -->
                {% if selected_lecturer %}
                <button type="button" onclick="window.location.href='{{ url_for('admin_manageTimetable') }}'" 
                        style="margin-left: 10px; padding: 4px 8px;">
                    Clear_Filter
                </button>
                {% endif %}
            </form>
        </div>
    </div>
    
    {% set time_slots = ["07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"] %}
    {% set week_days = ["MON", "TUE", "WED", "THU", "FRI"] %}

    <!-- Timetable Grid -->
    <div class="user-table-container">
        <table class="user-data-table" border="1">
            <thead>
                <tr>
                    <th>Day / Time</th>
                    {% for time in time_slots %}
                        <th>{{ time }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for day in week_days %}
                <tr>
                    <td><strong>{{ day }}</strong></td>
                    {% set displayed_keys = [] %}
                    {% set i = 0 %}
                    {% for _ in range(time_slots | length) %}
                        {% if i >= time_slots | length %}
                            {% break %}
                        {% endif %}

                        {% set time = time_slots[i] %}
                        {% set matched_row = None %}
                        {% for row in timetable_data %}
                            {% if row.classDay == day %}
                                {% set start_time = row.classTime.split('-')[0] %}
                                {% set end_time = row.classTime.split('-')[1] %}
                                {% if time == start_time %}
                                    {% set key = row.lecturerName ~ row.classType ~ row.classDay ~ row.classTime ~ row.classRoom ~ row.courseName %}
                                    {% if key not in displayed_keys %}
                                        {% set _ = displayed_keys.append(key) %}
                                        {% set matched_row = row %}
                                        {% break %}
                                    {% endif %}
                                {% endif %}
                            {% endif %}
                        {% endfor %}

                        {% if matched_row %}
                            {% set start = matched_row.classTime.split('-')[0] %}
                            {% set end = matched_row.classTime.split('-')[1] %}
                            {% set start_index = time_slots.index(start) %}
                            {% set end_index = time_slots.index(end) %}
                            {% set colspan = end_index - start_index %}

                            <td colspan="{{ colspan }}" style="background-color: #eef; border: 1px solid #999; padding: 4px;">
                                <strong>{{ matched_row.lecturerName }}</strong><br>
                                <strong>[{{ matched_row.classType }}]</strong><br>
                                {{ matched_row.courseName }}<br>
                                Room: {{ matched_row.classRoom }}
                            </td>

                            {% set i = i + colspan %}
                        {% else %}
                            <td></td>
                            {% set i = i + 1 %}
                        {% endif %}
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
// Function to preview uploaded files (upload section)
function previewUploadedTimetable(data) {
    const previewElement = document.getElementById("uploadPreviewContent");
    if (data) {
        previewElement.textContent = JSON.stringify(data, null, 2);
    } else {
        previewElement.textContent = "No structured data found.";
    }
}
</script>

{% endblock %}
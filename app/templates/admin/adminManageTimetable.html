{% extends "admin/adminBase.html" %}

{% block title %}Admin Manage Timetable{% endblock %}

{% block content %}
<div class="menu-section">
    <h2>Manage Timetable</h2>
    <form style="max-height: 500px; overflow-y: auto;">
        {% if not files %}
            {% if not authorized %}
                <a href="{{ url_for('authorize') }}" class="btn btn-primary">Click here to authorize Google Drive</a>
            {% else %}
                <a href="{{ url_for('fetch_drive_files') }}" class="btn btn-success">Click here to load files from Google Drive</a>
            {% endif %}
        {% endif %}

        {% if files %}
            <!-- Refresh Button -->
            <a href="{{ url_for('fetch_drive_files') }}" class="btn btn-warning">Click here to refresh the files from Google Drive</a>
            <br><br>

            <h3>PDF Files from SOC Folder:</h3>
            <div class="menu-grid" style="grid-template-columns: repeat(4, 1fr);">
                {% for file in files %}
                    <div>
                        <a href="{{ file.webViewLink }}" target="_blank">
                            {{ loop.index }}. {{ file.name }}
                        </a>
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <br><br>
        {% if get_flashed_messages(with_categories=true) %}
            {% for category, message in get_flashed_messages(with_categories=true) %}
                <div class="alert alert-{{ category }}">
                    <strong>{{ category.capitalize() }}:</strong> {{ message }}
                </div>
            {% endfor %}
        {% endif %}
        <br>
    </form>

    <br><br>
    {% if structured_timetables %}
        {% for timetable in structured_timetables %}
            <h3>{{ timetable.file.name }}</h3>
            {% for day, activities in timetable.structured_timetable.days.items() %}
                <h4>{{ day }}</h4>
                <div class="menu-grid">
                    {% for act in activities %}
                        <div class="activity-card">
                            <b>Lecturer Name:   </b> {{ timetable.structured_timetable.lecturer }} <br>
                            <b>Session Type:    </b> {{ act.class_type }} <br>
                            <b>Time:            </b> {{ act.time }} <br>
                            <b>Course Name:     </b> {{ act.course }} <br>
                            <b>Venue:           </b> {{ act.room }} <br>
                            <b>Weeks Effective: </b> {{ act.weeks_range | join(", ") }} <br>
                            <b>Date Range:      </b> {{ act.weeks_date }} <br>

                            {% if act.sections %}
                                <b>Sections:    </b><br>
                                {% for sec in act.sections %}
                                    {{ sec.intake }} | {{ sec.course_code }} | {{ sec.section }}<br>
                                {% endfor %}
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
                <hr>
            {% endfor %}
        {% endfor %}
    {% endif %}
</div>
{% endblock %}

{% extends "admin/adminBase.html" %}
{% set show_tabs = true %}
{% set show_upload = true %}
{% set show_dashboard = true %}
{% set show_manual = false %}
{% set show_edit = true %}
{% block title %}Admin ManageTimetable{% endblock %}
{% block head_title %}<h2>Manage Timetable</h2>{% endblock %}

{% block dashboard_section %}
<!-- Dashboard Form -->
<form id="dashboardForm" action="{{ url_for('admin_manageTimetable') }}" method="POST">
    <div id="dashboardSection" style="width: 90%; margin:auto; padding:1%">
        <input type="hidden" name="form_type" value="dashboard">    
        <div class="form-left" style="width: 100%">
            <div class="dashboard-row">
                <div class="dashboard-frame pie">
                    <h3>Total TimetableSets</h3>
                    <p class="dashboard-text" style="color:#1E90FF">{{ total_timetable }}</p>
                </div>

                <div class="dashboard-frame">
                    <h3>Lecturers without Assigned Timetable</h3>
                    <p class="dashboard-text" style="color:#e63e3e">{{ unassigned_summary|length }}</p>
                </div>

                {% set days = [
                    {'name':'Monday','value':mon_timetable,'color':'#007bff'},
                    {'name':'Tuesday','value':tue_timetable,'color':'#28a745'},
                    {'name':'Wednesday','value':wed_timetable,'color':'#fd7e14'},
                    {'name':'Thursday','value':thu_timetable,'color':'#dc3545'},
                    {'name':'Friday','value':fri_timetable,'color':'#6f42c1'}
                ] %}

                {% for day in days %}
                <div class="dashboard-frame">
                    <h3>{{ day.name }} Scheduled Classes</h3>
                    <p class="dashboard-text" style="color:{{ day.color }}">{{ day.value }}</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block upload_section %}
<!-- Upload Form -->
<form id="uploadForm" action="{{ url_for('admin_manageTimetable') }}" method="POST" enctype="multipart/form-data">
    <div id="uploadSection" style="margin: auto;">
        <div class="form-left" style="width: 100%">
            <h4 style="text-align: center;">File Upload Section</h4>
            <label for="timetable_list">
                <div class="upload-container" style="width: 80%;" id="timetableUploadContainer">
                    <div class="upload-text">
                        Upload in PDF file format<br><br><br>
                        Click to upload or drag and drop with below file format
                    </div>
                    <div class="file-types">PDF ONLY</div><br>
                    <div id="timetableSelectedFileName" class="file-name-display"></div>
                </div>
            </label>
            <input type="file" id="timetable_list" name="timetable_file[]" accept=".pdf" style="display: none;" multiple>
            <input type="hidden" name="form_type" value="upload">
            <br>

            <div class="button-wrapper">
                <button type="submit" id="uploadButton">Upload Lecturer Timetable</button>
            </div>
        </div>
    </div>
</form>
{% endblock %}



{% block edit_section %}
<form id="editForm" action="{{ url_for('admin_manageTimetable') }}" method="POST">
    <div id="editSection" style="width: 90%; margin:auto;">
        <h4 style="text-align: center;">Link Timetable With Staff</h4>
        <div class="profile-frame">
            <div class="form-left">
                <label>Unassigned Lecturers</label>
                <select name="lecturerName" id="lecturerName" required>
                    <option value="" disabled selected>Select Lecturer</option>
                    {% for item in unassigned_summary %}
                        <option value="{{ item.lecturer }}">
                            [{{ item.count }}row(s)] {{ item.lecturer }} 
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-right">
                <label>Staff Linked</label>
                <select name="staffList" id="staffList" required>
                    <option value="" disabled selected>Select Staff</option>
                    {% for staff in staff_list %}
                        <option value="{{ staff.userId }}">[{{ staff.userId }}] {{ staff.userName }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <input type="hidden" name="form_type" value="edit">
        <br><br>

        <div class="button-wrapper">
            <button type="submit" id="linkButton">Link Timetable</button>
        </div>
    </div>
</form>
{% endblock %}





{% block content %}
<div class="menu-section">
    <h2>Timetable</h2>
    <!-- Lecturer Filter -->
    <div class="profile-frame" style="margin-bottom: 20px;">
        <form method="get" style="display:flex; align-items:center; gap:8px;">
            <label for="lecturer">Select_Lecturer:</label>
            <select name="lecturer" id="lecturer" onchange="this.form.submit()">
                <option value="">All Lecturers</option>
                {% for lecturer in lecturers %}
                    <option value="{{ lecturer }}" {% if lecturer == selected_lecturer %}selected{% endif %}>
                        {{ lecturer }}
                    </option>
                {% endfor %}
            </select>

            {% if selected_lecturer %}
                <button type="button" onclick="window.location.href='{{ url_for('admin_manageTimetable') }}'"
                        style="margin-left: 10px; padding: 4px 8px;">
                    Clear_Filter
                </button>
            {% endif %}
        </form>
    </div>

    {% set time_slots = ["07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"] %}
    {% set week_days = ["MON", "TUE", "WED", "THU", "FRI"] %}

    <!-- Timetable Grid -->
    <div class="user-table-container">
        <table class="user-data-table" border="1">
            <thead>
                <tr>
                    <th>Day / Time</th>
                    {% for time in time_slots %}
                        <th>{{ time }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for day in week_days %}
                    {% if timetable_data %}
                    <tr>
                        <td><strong>{{ day }}</strong></td>
                        {% for time in time_slots %}
                        <td>
                            {% set ns = namespace(displayed=[]) %}
                            {% for row in timetable_data %}
                                {% if not selected_lecturer or row.lecturerName == selected_lecturer %}
                                    {% set class_day = row.classDay %}
                                    {% set class_time = row.classTime %}
                                    {% set start_time = class_time.split('-')[0] %}
                                    {% set end_time = class_time.split('-')[1] %}
                                    {% if class_day == day and time >= start_time and time < end_time %}
                                        {% set key = row.lecturerName ~ row.classType ~ row.classDay ~ row.classTime ~ row.classRoom ~ row.courseName %}
                                        {% if key not in ns.displayed %}
                                            {% set ns.displayed = ns.displayed + [key] %}
                                            <div style="border: 1px solid #999; margin: 2px; padding: 2px;">
                                                <strong>{{ row.lecturerName }}</strong><br>
                                                <strong>[{{ row.classType }}]</strong><br>
                                                {{ row.courseName }}<br>
                                                Room: {{ row.classRoom }}
                                            </div>
                                        {% endif %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    $(document).ready(function() {
        $('#lecturer').select2({
            placeholder: "Type to search...",
            allowClear: true
        });
    });
</script>
{% endblock %}
{% extends "admin/adminBase.html" %}
{% set show_tabs = true %}
{% set show_upload = true %}
{% set show_cal = true %}
{% set show_dashboard = true %}
{% set show_manual = true %}
{% set show_edit = true %}
{% block title %}Admin ManageTimetable{% endblock %}
{% block head_title %}<h2>Manage Timetable</h2>{% endblock %}

{% block dashboard_section %}
<form id="dashboardForm" action="{{ url_for('admin_manageTimetable') }}" method="POST">
    <div id="dashboardSection">
        <input type="hidden" name="form_type" value="dashboard">    
        <div class="form-profile" style="width: 100%">
            <div class="dashboard-row" style="grid-template-columns: 1fr 1fr;">
                <div class="dashboard-frame">
                    <h3>Total Timetable Sets</h3>
                    <p class="dashboard-text" id="total_timetable" style="color:#1E90FF">{{ total_timetable }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Lecturers without Assigned Timetable</h3>
                    <p class="dashboard-text" id="total_havent_assign" style="color:#e63e3e">{{ total_unassigned }}</p>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block upload_section %}
<form id="uploadForm" action="{{ url_for('admin_manageTimetable') }}" method="POST" enctype="multipart/form-data">
    <div id="uploadSection" style="margin: auto;">
        <div class="form-profile" style="width: 100%">
            <h4 style="text-align: center;">File Upload Section</h4>
            <label for="timetable_list">
                <div class="upload-container" style="width: 80%;" id="timetableUploadContainer">
                    <br>
                    <div class="upload-text">
                        Please upload your timetable files in <b>PDF format only</b>.<br><br>
                        You may click below to upload or drag and drop your files here.<br>
                        <b>Note:</b> Upload <i>one timetable per PDF file</i>. Multiple files are allowed,<br>
                        but <i>merged PDFs containing multiple timetables in a single file are not supported</i>.
                    </div>
                    <br>
                    <div id="timetableSelectedFileName" class="file-name-display"></div>
                </div>
            </label>
            <input type="file" id="timetable_list" name="timetable_file[]" accept=".pdf" style="display: none;" multiple>
            <input type="hidden" name="form_type" value="upload">
            <br>
            <div class="button-wrapper">
                <button type="submit" id="uploadButton">Upload Lecturer Timetable</button>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block manual_section %}
<form id="manualForm" action="{{ url_for('admin_manageTimetable') }}" method="POST">
    <div id="manualSection" style="width: 100%; margin:auto;">
        <h4 style="text-align: center;">Link Timetable With Staff</h4>
        <div class="profile-frame">
            <div class="form-profile">
                <label>Unassigned Lecturers</label>
                <select name="lecturerName" id="lecturerName" required>
                    <option value="" disabled selected>-- Select Lecturer --</option>
                    {% for item in unassigned_summary %}
                        <option value="{{ item.lecturer }}">[{{ item.count }} row(s)] {{ item.lecturer }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-profile">
                <label>Staff Linked</label>
                <select name="staffList" id="staffList" required>
                    <option value="" disabled selected>-- Select Staff --</option>
                    {% for staff in unassigned_staff_list %}
                        <option value="{{ staff.userId }}">[{{ staff.userId }}] {{ staff.userName }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <input type="hidden" name="form_type" value="manual">
        <br><br>
        <div class="button-wrapper">
            <button type="submit" id="linkButton">Link Timetable</button>
        </div>
    </div>
</form>
{% endblock %}

{% block edit_section %}
<form id="editForm" action="{{ url_for('admin_manageTimetable') }}" method="POST">
    <div id="editSection" style="width: 100%; margin:auto;">
        <h4 style="text-align: center;">Edit or Delete Timetable Link</h4>
        <div class="profile-frame">
            <div class="form-profile">
                <label>Existing Timetable List</label>
                <select name="editTimetableList" id="editTimetableList" required>
                    <option value="" disabled selected>-- Select Timetable --</option>
                    {% for t in timetable_list %}
                        <option value="{{ t.timetableId }}">
                            [{{ t.timetableId }}] {{ t.rows[0].lecturerName if t.rows else "No Lecturer" }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-profile">
                <label>Staff Linked</label>
                <select name="editStaffList" id="editStaffList" required>
                    <option value="" disabled selected>-- Select Staff --</option>
                    {% for staff in staff_list %}
                        {% set tid = timetable_map.get(staff.userId) %}
                        <option value="{{ staff.userId }}" {% if timetable_select and staff.userId == timetable_select.user_id %}selected{% endif %}>
                            {% if tid %}[Already With Timetable ID[{{ tid }}]]{% endif %}
                            [{{ staff.userId }}] {{ staff.userName }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <input type="hidden" name="form_type" value="edit">
        <br><br>
        <div class="button-wrapper" style="gap: 5%;">
            <button type="submit" name="action" value="update" style="background-color: #d4edda; color: #155724;">
                <i class="fas fa-check"></i> Update Timetable Relationship
            </button> 
            <button type="submit" name="action" value="delete" style="background-color: #f8d7da; color: #721c24;" 
                    onclick="return confirm('Are you sure to delete this timetable relationship?')">
                <i class="fas fa-trash"></i> Delete Timetable Relationship
            </button>
        </div>
    </div>
</form>
{% endblock %}

{% block content %}
<div class="menu-section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1%;">
        <h2>Timetable(s)</h2>
        <div style="display: flex; align-items: center; gap: 10px;">
            <div style="position: relative;">
                <input type="text" id="searchInput" name="search_timetable" placeholder="Search..." value="{{ search_timetable }}" style="border-radius: 6px; width: 100%;">
                <i class="fa fa-search" id="searchBtn" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer;"></i>
            </div>
            <div class="button-wrapper">
                <button id="generatePDF" style="background-color: black;">Download as PDF</button>
            </div>
        </div>
    </div>
    <div id="noResults" style="display: none; text-align: center; font-weight: bold; color: #b00; margin-bottom: 1%;">No results found.</div>

    <form method="get" action="{{ url_for('admin_manageTimetable') }}">
        <div class="profile-frame" style="margin-top: 1%;">
            <div class="form-profile">
                <label for="department">Select Department:</label>
                <select name="department" id="department" onchange="this.form.submit()">
                    <option value="">All Departments</option>
                    {% for dept in department_data %}
                        <option value="{{ dept.departmentCode }}" {% if dept.departmentCode == selected_department %}selected{% endif %}>
                            {{ dept.departmentName }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-profile">
                <label for="lecturer">Select Lecturer:</label>
                <select name="lecturer" id="lecturer" onchange="this.form.submit()">
                    <option value="">All Lecturers</option>
                    {% for lecturer in lecturers %}
                        <option value="{{ lecturer }}" {% if lecturer == selected_lecturer %}selected{% endif %}>
                            {{ lecturer }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="button-wrapper" style="padding: 1%;">
                <button type="button" id="clearFilter">Clear Filter</button>
            </div>
        </div>
    </form> 

    <br><div id="dayLegend" style="display:flex;gap:15px;align-items:center;"></div>
    {% set time_slots = ["07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"] %}
    <div class="user-table-container">
        <table class="user-data-table" id="manageTimetable" border="1">
            <thead>
                <tr>
                    <th>Day / Time</th>
                    {% for time in time_slots %}
                        <th>{{ time }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% set day_colors = {
                    "MON": "#e3f2fd", 
                    "TUE": "#fce4ec", 
                    "WED": "#e8f5e9",  
                    "THU": "#fff3e0",  
                    "FRI": "#ede7f6" 
                } %}
                {% for day in ["MON", "TUE", "WED", "THU", "FRI"] %}
                <tr style="background-color: {{ day_colors[day] }}">
                    <td><strong>{{ day }}</strong><br></td>
                        {% for time in time_slots %}
                            <td>
                                {% set ns = namespace(displayed=[]) %}
                                {% for row in timetable_data %}
                                {% if (not selected_lecturer or row.lecturerName == selected_lecturer) %}
                                        {% set class_day = row.classDay %}
                                        {% set start_time = row.classTime.split('-')[0] %}
                                        {% set end_time = row.classTime.split('-')[1] %}
                                        {% if class_day == day and time >= start_time and time < end_time %}
                                            {% set key = row.lecturerName ~ row.classType ~ row.classDay ~ row.classTime ~ row.classRoom ~ row.courseName %}
                                            {% if key not in ns.displayed %}
                                                {% set ns.displayed = ns.displayed + [key] %}
                                                <div data-intake="{{ row.courseIntake }}"
                                                    data-lecturer="{{ row.lecturerName }}"
                                                    {% if row.timetable_id %}data-timetable="{{ row.timetable_id }}"{% endif %}>
                                                    <strong>Lecturer:</strong> <i>{{ row.lecturerName }}</i><br>
                                                    <strong>Course:</strong> <i>{{ row.courseName }}</i><br>
                                                    <strong>Class Type:</strong> <i>{{ row.classType }}</i><br>
                                                    <strong>Room:</strong> <i>{{ row.classRoom }}</i>
                                                </div>
                                            {% endif %}
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                            </td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.getElementById('clearFilter').addEventListener('click', function() {
    window.location.href = "{{ url_for('admin_manageTimetable') }}";
});

const days = {
    Monday: '#e3f2fd',
    Tuesday: '#fce4ec',
    Wednesday: '#e8f5e9',
    Thursday: '#fff3e0',
    Friday: '#ede7f6'
};
const container = document.getElementById('dayLegend');
Object.entries(days).forEach(([day, color]) => {
    const div = document.createElement('div');
    div.style.display = 'flex';
    div.style.alignItems = 'center';
    div.style.gap = '5px';
    div.innerHTML = `<span style="width:20px; height:20px; background:${color}; display:inline-block; border-radius:4px; border: 1px solid black;"></span><span>${day}</span>`;
    container.appendChild(div);
});

document.addEventListener("DOMContentLoaded", function () {
    const timetableSelect = document.getElementById('editTimetableList');
    const staffSelect = document.getElementById('editStaffList');

    timetableSelect.addEventListener('change', function () {
        const timetableId = this.value;
        if (!timetableId) return;

        fetch(`/get_linkTimetable/${timetableId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) { alert(data.error); return; }
                staffSelect.value = data.user_id;
            })
            .catch(err => console.error(err));
    });
});

document.getElementById('generatePDF')?.addEventListener('click', () => {
    const { jsPDF } = window.jspdf;
    const table = document.querySelector('.user-table-container table');
    if (!table) return alert("No timetable table found!");

    const headerText = "Admin View - Merge Timetable Download";
    const nowMY = new Date().toLocaleString("en-GB", {timeZone: "Asia/Kuala_Lumpur",day: "2-digit",month: "short",year: "numeric",hour: "2-digit",minute: "2-digit",hour12: true});
    const filename = `Admin_ViewMergeTimetable.pdf`;

    html2canvas(table, { scale: 2 }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF('l', 'pt', 'a4'); // landscape
        const pdfWidth = pdf.internal.pageSize.getWidth();
        let yOffset = 40; // initial top margin

        // Title
        pdf.setFontSize(18);
        pdf.setFont(undefined, 'bold');
        pdf.text(headerText, pdfWidth / 2, yOffset, { align: "center" });

        // Timestamp
        pdf.setFontSize(10);
        pdf.setFont(undefined, 'normal');
        pdf.text(`Downloaded on: ${nowMY}`, pdfWidth / 2, yOffset + 20, { align: "center" });

        // Add table image
        const pdfHeight = (canvas.height * (pdfWidth - 40)) / canvas.width;
        pdf.addImage(imgData, 'PNG', 20, yOffset + 40, pdfWidth - 40, pdfHeight);

        pdf.save(filename);
    });
});


document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("searchInput");
    const noResults = document.getElementById("noResults");
    const table = document.getElementById("manageTimetable");

    function searchTimetable() {
        const filter = searchInput.value.toLowerCase();
        let anyVisible = false;

        if (!table) return;

        const rows = table.getElementsByTagName("tr");
        // Skip header row
        for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            const cells = row.getElementsByTagName("td");
            let rowHasMatch = false;

            for (let j = 0; j < cells.length; j++) {
                const divs = cells[j].getElementsByTagName("div");
                let cellHasMatch = false;

                for (let k = 0; k < divs.length; k++) {
                    const div = divs[k];
                    const text = div.textContent.toLowerCase();
                    if (text.includes(filter)) {
                        div.style.display = ""; // show matching
                        cellHasMatch = true;
                    } else {
                        div.style.display = "none"; // hide non-matching
                    }
                }

                if (cellHasMatch) rowHasMatch = true;
            }

            row.style.display = rowHasMatch ? "" : "none"; // hide row if no matches at all
            if (rowHasMatch) anyVisible = true;
        }

        noResults.style.display = anyVisible ? "none" : "block";
    }

    searchInput.addEventListener("keyup", searchTimetable);
    document.getElementById("searchBtn")?.addEventListener("click", searchTimetable);
});


function initTimetableIntakeSwipe({containerId, noResultsId = null, dashboardUpdater = null}) {
    const order = ["JAN", "APR", "AUG", "OCT"];
    const blocks = document.querySelectorAll(`#${containerId} div[data-intake]`);
    const $ = id => document.getElementById(id);

    if (!blocks.length) return;
    const now = new Date();
    const m = now.getMonth();

    let state = {
        year: now.getFullYear(),
        intake:
            m <= 2 ? "JAN" :
            m <= 6 ? "APR" :
            m <= 9 ? "AUG" :
            "OCT"
    };

    function shift(dir) {
        let i = order.indexOf(state.intake) + dir;
        let y = state.year;

        if (i < 0) { i = order.length - 1; y--; }
        if (i >= order.length) { i = 0; y++; }
        state = { intake: order[i], year: y };
        render();
    }

    function adjacent(dir) {
        let i = order.indexOf(state.intake) + dir;
        let y = state.year;

        if (i < 0) { i = order.length - 1; y--; }
        if (i >= order.length) { i = 0; y++; }
        return { intake: order[i], year: y };
    }

    function render() {
        const key = state.intake + state.year;
        $("currentIntake").textContent = key;

        const p = adjacent(-1);
        const n = adjacent(1);
        $("prevLabel")?.textContent = p.intake + p.year;
        $("nextLabel")?.textContent = n.intake + n.year;

        let visible = 0;
        blocks.forEach(b => {
            const show = b.dataset.intake === key;
            b.style.display = show ? "" : "none";
            if (show) visible++;
        });

        if (noResultsId) {
            $(noResultsId).style.display = visible ? "none" : "block";
        }

        // Update dashboard counts per current intake
        dashboardUpdater?.();
    }
}

function updateTimetableDashboardFromTable() {
    const table = document.getElementById("manageTimetable");
    if (!table) return;

    const timetableSet = new Set();     // lecturer + intake combos linked to staff
    const unassignedSet = new Set();    // lecturer + intake combos without staff

    table.querySelectorAll("div[data-intake]").forEach(div => {
        if (div.style.display === "none") return; // only visible intake

        const lecturer = div.dataset.lecturer;
        const intake = div.dataset.intake;
        const key = lecturer + "|" + intake;

        if (div.dataset.timetable) {
            timetableSet.add(key);
        } else {
            unassignedSet.add(key);
        }
    });

    document.getElementById("total_timetable").textContent = timetableSet.size;
    document.getElementById("total_havent_assign").textContent = unassignedSet.size;
}



document.addEventListener("DOMContentLoaded", () => {
    initTimetableIntakeSwipe({
        containerId: "manageTimetable",
        noResultsId: "noResults",
        dashboardUpdater: updateTimetableDashboardFromTable
    });
    updateTimetableDashboardFromTable();
});

window.addEventListener("load", () => {
    updateTimetableDashboardFromTable();
});
</script>
{% endblock %}  

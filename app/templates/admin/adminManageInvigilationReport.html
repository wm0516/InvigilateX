{% extends "admin/adminBase.html" %}
{% set show_tabs = true %}
{% set show_upload = true %}
{% set show_cal = true %}
{% set show_dashboard = true %}
{% set show_manual = false %}
{% set show_edit = true %}
{% block title %}Admin ManageInvigilationReport{% endblock %}
{% block head_title %}<h2>Manage Invigilation Report</h2>{% endblock %}

{% block dashboard_section %}
<!-- Dashboard Form -->
<form id="dashboardForm" action="{{ url_for('admin_manageInvigilationReport') }}" method="POST">
    <div id="dashboardSection">
        <input type="hidden" name="form_type" value="dashboard">
        <div class="form-profile" style="width: 100%">
            <div class="dashboard-row" style="grid-template-columns: 1fr 1fr 1fr 1fr 1fr;">
                <div class="dashboard-frame">
                    <h3>Pending Invigilation Duties</h3>
                    <p class="dashboard-text">{{ accept_report }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Rejected Invigilation Duties</h3>
                    <p class="dashboard-text">{{ reject_report }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Completed Invigilation Duties</h3>
                    <p class="dashboard-text">{{ total_report - reject_report - total_pendingReport }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Checked In Late</h3>
                    <p class="dashboard-text" style="color:red;">{{ total_checkInLate }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Checked Out Early</h3>
                    <p class="dashboard-text" style="color:red;">{{ total_checkOutEarly }}</p>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block upload_section %}
<!-- Upload Form -->
<form id="uploadForm" action="{{ url_for('admin_manageInvigilationReport') }}" method="POST" enctype="multipart/form-data">
    <div id="uploadSection" class="function-frame" style="width:80%">
        <div class="form-profile" style="width: 100%">
            <h4 style="text-align: center;">File Upload Section</h4>
            <label for="attendance_list">
                <div class="upload-container" id="attendanceUploadContainer">
                    <div class="upload-text">
                        Please upload an Excel file with the sheet name <b>Clock_IO</b>.<br>
                        Data should begin from columns <b>A to E</b>, with headers as follows:<br><br>
                        <i>[CARD UID, Name, Date, Time, In/Out]</i><br><br>
                        Click below to upload, or drag and drop a file (accepted formats: <b>XLSX, XLS, XLSM</b>).
                    </div><br>
                    <div id="attendanceSelectedFileName" class="file-name-display"></div>
                </div>
            </label>
            <input type="file" id="attendance_list" name="attendance_file" accept=".xlsx,.xls,.xlsm" style="display: none;">
            <input type="hidden" name="form_type" value="upload">
            <br>
            <div class="button-wrapper">
                <button type="submit">Upload Attendance Record</button>
            </div>
        </div>
    </div>
</form>
{% endblock %}


{% block edit_section %}
<form id="editForm" action="{{ url_for('admin_manageInvigilationReport') }}" method="POST">
    <div id="editSection" class="function-frame">
        <h4 style="text-align:center;">Edit Invigilation Report</h4>
        <div class="profile-frame" style="gap: 30px; padding: 1%">
            <div class="form-profile" style="flex:1;">
                <label>Select Venue Session</label>
                <select id="editSession" name="venueSessionId" required>
                    <option value="" disabled selected>-- Select Session --</option>
                    {% for (session_id, venue, start, end), data in grouped_att.items() %}
                        {% set first_att = data.invigilators[0] %}
                        <option value="{{ first_att.venueSessionId }}">
                            {{ first_att.venueSessionId }} | {{ start.strftime("%d/%b/%Y %H:%M") }} → {{ end.strftime("%d/%b/%Y %H:%M") }} - Venue [{{ venue }}]
                        </option>
                    {% endfor %}
                </select><br>

                <label>Course Code - Name</label>
                <div id="courseInfo" style="display: flex; flex-direction: column; gap: 5px;"></div>

                <br><label>Exam Time</label>
                <input type="text" id="examTime" readonly>
            </div>

            <div class="form-profile" style="flex:1;">
                <label style="font-weight:bold;">Current Invigilator</label>
                <div id="currentInvigilatorContainer"></div>
            </div>

            <div class="form-profile" style="flex:1;">
                <label style="font-weight:bold;">Replace With</label>
                <div id="replaceInvigilatorContainer"></div>
            </div>
        </div>
        <input type="hidden" name="form_type" value="edit">
        <div class="button-wrapper">
            <button type="submit" style="background:#d4edda;color:#155724;">Update Invigilators</button>
        </div>
    </div>
</form>
{% endblock %}



{% block content %}
<div class="menu-section">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h3>List of Invigilator's Invigilation Reports</h3>
        <div style="display: flex; align-items: center; gap: 10px;">
            <div style="position: relative;">
                <input type="text" id="searchInput" name="search_report" placeholder="Search..." value="{{ search_report }}" style="border-radius: 6px; width: 100%;">
                <i class="fa fa-search" id="searchBtn" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer;"></i>
            </div>
            <div class="button-wrapper">
                <button id="generatePDF" style="background-color: black;">Download as PDF</button>
            </div>
        </div>
    </div>
    <div id="noResults" style="display: none; text-align: center; font-weight: bold; color: #b00;">No results found.</div>
    <table class="user-data-table" id="manageInvigilationReport">
        <thead>
            <tr>
                <th>No</th>
                <th>Exam Date</th>
                <th>Exam Venue</th>
                <th>Exam CourseCode</th>
                <th>Invigilator Details</th>
                <th>Invigilation Status</th>
                <th>Attendance Status</th>
                <th>Check-in/out</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% set ns = namespace(rowno=1) %}
            {% for (session_id, venue, start, end), data in grouped_att.items() %}
                {% set num_invigilators = data.invigilators | length %}
                {% set has_backup = data.backup is not none %}
                {% set total_rows = num_invigilators %}

                {% for att in data.invigilators %}
                    {% set duration = end - start %}
                    {% set total_seconds = duration.total_seconds() %}
                    {% set days = total_seconds // 86400 %}
                    {% set hours = (total_seconds % 86400) // 3600 %}
                    {% set minutes = (total_seconds % 3600) // 60 %}
                    <tr>
                        {% if loop.first %}
                            <td rowspan="{{ total_rows }}">{{ ns.rowno }}</td>
                            <td rowspan="{{ total_rows }}">
                                <div class="info-grid">
                                    <div>Date</div><div><strong>: {{ start.strftime("%d/%b/%Y") }} - {{ end.strftime("%d/%b/%Y") }}</strong></div>
                                    <div>Time</div><div><strong>: {{ start.strftime("%H:%M") }} - {{ end.strftime("%H:%M") }}</strong></div>
                                    <div>Duration</div><div><strong>: {% if days > 0 %}{{ days|int }}d {% endif %}{{ hours|int }}h {{ minutes|int }}m</strong></div>
                                </div>
                            </td>
                            <td rowspan="{{ total_rows }}">{{ venue }}</td>
                            <td rowspan="{{ total_rows }}">
                                {% for c in data.courses %}
                                    <div><strong>{{ c.code }}</strong> - {{ c.name }}</div>
                                {% endfor %}
                            </td>
                        {% endif %}

                        <td>
                            <div class="info-grid">
                                <div>Position</div><div><strong>: {{ att.position if att.position else "None" }}</strong></div>
                                <div>Staff ID</div><div><strong>: {{ att.invigilator.userId }}</strong></div>
                                <div>Name</div><div><strong>: {{ att.invigilator.userName }}</strong></div>
                                <div>Email</div><div><strong>: {{ att.invigilator.userEmail }}</strong></div>
                                <div>Contact</div><div><strong>: {{ att.invigilator.userContact if att.invigilator.userContact else "None" }}</strong></div>
                            </div>
                        </td>
                        <td>
                            {% if att.invigilationStatus %}
                                <span class="status frame-completed invigilation-status">ACCEPTED</span>
                            {% elif not att.invigilationStatus and att.rejectReason %}
                                <span class="status frame-expired invigilation-status">REJECTED</span>
                                <div style="max-width: 200px;"><strong>Reason: </strong>{{ att.rejectReason }}</div>
                            {% else %}
                                <span class="status frame-pending invigilation-status">PENDING</span>
                            {% endif %} 
                        </td>
                        <td>
                            {% set remark_classes = {
                                "PENDING": "frame-pending",
                                "CHECK IN": "frame-completed",
                                "COMPLETED": "frame-completed",
                                "CHECK IN LATE": "frame-expired",
                                "CHECK OUT EARLY": "frame-expired",
                                "EXPIRED": "frame-expired"
                            } %}
                            <span class="status {{ remark_classes.get(att.remark, '') }} attendance-remark">{{ att.remark }}</span>
                        </td>
                        <td>
                            <div class="info-grid">
                                <div>CheckIn</div><div><strong class="checkin-text">: {{ att.checkIn.strftime("%d/%b/%Y %H:%M:%S") if att.checkIn else "None" }}</strong></div>
                                <div>CheckOut</div><div><strong class="checkout-text">: {{ att.checkOut.strftime("%d/%b/%Y %H:%M:%S") if att.checkOut else "None" }}</strong></div>
                            </div>
                        </td>
                        <td>
                            <button type="button" class="edit-btn" data-session="{{ att.venueSessionId }}" data-invigilator="{{ att.invigilatorId }}">
                                <i class="fa fa-edit"></i>
                            </button>
                        </td>
                    </tr>
                {% endfor %}
                {% set ns.rowno = ns.rowno + 1 %}
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.getElementById("generatePDF").addEventListener("click", function () {

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: "landscape", unit: "pt", format: "a4" });
    const margin = 20;
    const pageWidth = doc.internal.pageSize.getWidth();
    const nowMY = new Date().toLocaleString("en-GB", {
        timeZone: "Asia/Kuala_Lumpur",
        day: "2-digit",
        month: "short",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
        hour12: true
    });

    doc.setFont("helvetica", "bold");
    doc.setFontSize(18);
    doc.text("Admin View - Invigilation Report Download", pageWidth / 2, margin, { align: "center" });

    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);
    doc.text(`Downloaded on: ${nowMY}`, pageWidth / 2, margin + 18, { align: "center" });

    const headers = ["No", "Exam Date & Time", "Venue", "Exam Course", "Invigilator Details", "Invigilation Status", "Attendance Status", "Check-in/out Time"];
    const rows = [];

    function getInvigilatorText(td) {
        const lines = [];
        td.querySelectorAll("div.info-grid div").forEach((div, i) => {
            if (i % 2 === 0) {
                lines.push(div.innerText.trim() + " ");
            } else {
                lines[lines.length - 1] += div.innerText.trim();
            }
        });
        return lines.join("\n");
    }

    document.querySelectorAll("#manageInvigilationReport tbody tr").forEach((tr) => {
        const tds = tr.querySelectorAll("td");
        if (tds.length === 0) return;

        const firstCellText = tds[0].innerText.trim();
        const isNewExamRow = !isNaN(firstCellText);

        if (isNewExamRow) {
            rows.push([
                tds[0].innerText.trim(),
                tds[1].innerText.trim(),
                tds[2].innerText.trim(),
                tds[3].innerText.trim(),
                getInvigilatorText(tds[4]),
                tds[5].innerText.trim(),
                tds[6].innerText.trim(),
                tds[7].innerText.trim()
            ]);
        } else {
            rows.push([
                "", "", "", "",
                getInvigilatorText(tds[0]),
                tds[1].innerText.trim(),
                tds[2].innerText.trim(),
                tds[3].innerText.trim()
            ]);
        }
    });

    doc.autoTable({
        head: [headers],
        body: rows,
        startY: margin + 30,
        theme: "grid",
        styles: { fontSize: 7, cellPadding: 4 }
    });

    doc.save("Admin_ViewInvigilationReport.pdf");
});


document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("searchInput");
    const noResults = document.getElementById("noResults");

    if (searchInput) {
        searchInput.addEventListener("input", function () {
            const filter = this.value.toLowerCase().trim();
            let foundAny = false;

            document.querySelectorAll("#manageInvigilationReport tbody tr").forEach(row => {
                const text = row.innerText.toLowerCase();
                if (!filter || text.includes(filter)) {
                    row.style.display = "";
                    foundAny = true;
                } else {
                    row.style.display = "none";
                }
            });

            noResults.style.display = foundAny ? "none" : "block";
        });
    }

    document.querySelectorAll(".edit-btn").forEach(btn => {
        btn.addEventListener("click", async function () {

            const tr = btn.closest("tr");
            if (tr.classList.contains("editing")) return;
            tr.classList.add("editing");

            const venueSessionId = btn.dataset.session;
            const invigilatorId = btn.dataset.invigilator;

            const checkInSpan = tr.querySelector(".checkin-text");
            const checkOutSpan = tr.querySelector(".checkout-text");
            const statusSpan = tr.querySelector(".invigilation-status");
            const remarkSpan = tr.querySelector(".attendance-remark");

            const originalCheckIn = checkInSpan.textContent.trim();
            const originalCheckOut = checkOutSpan.textContent.trim();
            const originalStatus = statusSpan.textContent.trim();
            const originalRemark = remarkSpan.textContent.trim();

            function toLocalInput(dateText) {
                if (!dateText || dateText === "None") return "";
                const d = new Date(dateText.replace(" ", "T"));
                return d.toISOString().slice(0, 19);
            }

            checkInSpan.innerHTML = `<input type="datetime-local" step="1" value="${toLocalInput(originalCheckIn)}">`;
            checkOutSpan.innerHTML = `<input type="datetime-local" step="1" value="${toLocalInput(originalCheckOut)}">`;

            statusSpan.innerHTML = `
                <select>
                    <option value="true" ${originalStatus === "ACCEPTED" ? "selected" : ""}>ACCEPTED</option>
                    <option value="false" ${originalStatus === "PENDING" ? "selected" : ""}>PENDING</option>
                </select>`;

            remarkSpan.innerHTML = `
                <select>
                    <option>PENDING</option>
                    <option>CHECK IN</option>
                    <option>CHECK IN LATE</option>
                    <option>CHECK OUT EARLY</option>
                    <option>COMPLETED</option>
                    <option>EXPIRED</option>
                </select>`;

            remarkSpan.querySelector("select").value = originalRemark;

            const actionTd = btn.closest("td");
            actionTd.innerHTML = `
                <button class="save-btn">Save</button>
                <button class="cancel-btn">Cancel</button>`;

            actionTd.querySelector(".save-btn").addEventListener("click", async () => {

                const newCheckIn = tr.querySelector(".checkin-text input").value;
                const newCheckOut = tr.querySelector(".checkout-text input").value;
                const newStatus = tr.querySelector(".invigilation-status select").value === "true";
                const newRemark = tr.querySelector(".attendance-remark select").value;

                const response = await fetch("/admin/updateAttendanceTime", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        venueSessionId,
                        invigilatorId,
                        check_in: newCheckIn,
                        check_out: newCheckOut,
                        invigilation_status: newStatus,
                        remark: newRemark
                    })
                });

                const result = await response.json();
                if (result.success) location.reload();
                else alert(result.message);
            });

            actionTd.querySelector(".cancel-btn").addEventListener("click", () => location.reload());
        });
    });

    const sessionSelect = document.getElementById("editSession");
    const courseInfo = document.getElementById("courseInfo");
    const examTime = document.getElementById("examTime");
    const currentContainer = document.getElementById("currentInvigilatorContainer");
    const replaceContainer = document.getElementById("replaceInvigilatorContainer");

    if (!sessionSelect) return;

    sessionSelect.addEventListener("change", async function () {

        if (!this.value) return;

        const resp = await fetch(`/admin/get_session_details/${this.value}`);
        const data = await resp.json();

        if (data.error) {
            alert(data.error);
            return;
        }

        courseInfo.innerHTML = "";
        currentContainer.innerHTML = "";
        replaceContainer.innerHTML = "";

        data.courses.forEach(c => {
            const input = document.createElement("input");
            input.type = "text";
            input.readOnly = true;
            input.value = `${c.code} - ${c.name}`;
            courseInfo.appendChild(input);
        });

        examTime.value = `${data.start} → ${data.end}`;

        const invResp = await fetch("/admin/get_valid_invigilators");
        const invigilators = await invResp.json();

        data.attendances.forEach(att => {

            const currentDiv = document.createElement("div");
            currentDiv.innerHTML =
                `<input type="text" value="[${att.position}] ${att.invigilatorName}" readonly>`;
            currentContainer.appendChild(currentDiv);

            const replaceDiv = document.createElement("div");
            const select = document.createElement("select");
            select.name = `replace_${att.invigilatorId}`;

            const noneOption = document.createElement("option");
            noneOption.value = "";
            noneOption.textContent = "None";
            select.appendChild(noneOption);

            invigilators.forEach(u => {
                const option = document.createElement("option");
                option.value = u.userId;
                option.textContent = u.userName;
                if (u.userId == att.invigilatorId) option.selected = true;
                select.appendChild(option);
            });

            replaceDiv.appendChild(select);
            replaceContainer.appendChild(replaceDiv);
        });
    });
});
</script>
{% endblock %}
{% extends "admin/adminBase.html" %}
{% set show_tabs = false %}
{% set show_upload = false %}
{% set show_dashboard = false %}
{% set show_manual = false %}
{% set show_edit = false %}
{% block title %}Admin ManageInvigilationReport{% endblock %}
{% block head_title %}<h2>Manage Invigilation Report</h2>{% endblock %}
{% block content %}
<div class="menu-section">
    <div id="dashboardSection">
        <input type="hidden" name="form_type" value="dashboard">
        <div class="form-left" style="width: 100%">
            <div class="dashboard-row">
                <div class="dashboard-frame">
                    <h3>Pending Invigilation Duties</h3>
                    <p class="dashboard-text">{{ total_activeReport }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Completed Invigilation Duties</h3>
                    <p class="dashboard-text">{{ total_report - total_activeReport }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Checked In Late</h3>
                    <p class="dashboard-text" style="color:red;">{{ total_checkInLate }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Checked Out Early</h3>
                    <p class="dashboard-text" style="color:red;">{{ total_checkOutEarly }}</p>
                </div>
            </div>
        </div>
    </div>

    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h3>List of Lecturer Invigilation Report</h3>
        <div style="display: flex; align-items: center; gap: 10px;">
            <div style="position: relative;">
                <input type="text" id="searchInput" name="search_report" placeholder="Search..." value="{{ search_report }}" style="border-radius: 6px; width: 100%;">
                <i class="fa fa-search" id="searchBtn" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer;"></i>
            </div>
            <div class="button-wrapper">
                <button id="generatePDF" style="background-color: black;">Download as PDF</button>
            </div>
        </div>
    </div>
    <div id="noResults" style="display: none; text-align: center; margin-top: 10px; font-weight: bold; color: #b00;">No results found.</div>

    <div class="user-table-container">
        <table class="user-data-table" id="manageInvigilationReport">
            <thead>
                <tr>
                    <th>Exam ID</th>
                    <th>Exam Details</th>
                    <th>Invigilators</th>
                    <th>Invigilator Details</th>
                    <th>Check-in/out Time</th>
                    <th>Attendance Status</th>
                    <th>Invigilation Status</th>
                    <th>Action</th>
                </tr>
            </thead>

            {% for (status, start_time), grouped in attendances|groupby("group_key") %}
            <tbody data-exam="{{ grouped[0].report.exam.examId }}" 
                data-exam-start="{{ grouped[0].report.exam.examStartTime.isoformat() }}"
                data-exam-end="{{ grouped[0].report.exam.examEndTime.isoformat() }}">
                {% for att in grouped %}
                <tr data-exam="{{ grouped[0].report.exam.examId }}"
                    class="{% if not att.report.exam.examStatus %}inactive-row-show{% elif att.report.exam.examStartTime is none %}error-row-show{% endif %}">

                    {% if loop.first %}
                    <!-- Exam ID -->
                    <td rowspan="{{ grouped|length }}" style="text-align:center;">
                        [{{ grouped[0].report.exam.examId }}]
                    </td>

                    <!-- Exam Details -->
                    <td rowspan="{{ grouped|length }}">
                        <div class="info-grid">
                            <div>Course Name</div><div><strong>: {{ grouped[0].report.exam.course.courseName }}</strong></div>
                            <div>Course Code/Section</div><div><strong>: {{ grouped[0].report.exam.course.courseCodeSectionIntake }}</strong></div>
                            <div>Number of Students</div><div><strong>: {{ grouped[0].report.exam.course.courseStudent }}</strong></div>
                            <div>Program Code</div><div><strong>: {{ grouped[0].report.exam.course.courseDepartment }}</strong></div>
                            <div>Exam Date</div><div><strong>: {{ grouped[0].report.exam.examStartTime.strftime("%d/%b/%Y") }} - {{ grouped[0].report.exam.examEndTime.strftime("%d/%b/%Y") }}</strong></div>
                            <div>Exam Day</div><div><strong>: {{ grouped[0].report.exam.examStartTime.strftime("%A") }} - {{ grouped[0].report.exam.examEndTime.strftime("%A") }}</strong></div>
                            <div>Exam Time</div><div><strong>: {{ grouped[0].report.exam.examStartTime.strftime("%H:%M") }} - {{ grouped[0].report.exam.examEndTime.strftime("%H:%M") }}</strong></div>
                            <div>Exam Period</div><div><strong>: {{ ((grouped[0].report.exam.examEndTime - grouped[0].report.exam.examStartTime).seconds // 3600) }}h {{ ((grouped[0].report.exam.examEndTime - grouped[0].report.exam.examStartTime).seconds % 3600) // 60 }}m</strong></div>
                            <div>Exam Venue(s)</div>
                            <div>
                                {% if grouped[0].report.exam.venue_availabilities %}
                                    {% for va in grouped[0].report.exam.venue_availabilities %}
                                        <strong>: {{ va.venueNumber }} [Capacity Use: {{ va.capacity }}]</strong><br>
                                    {% endfor %}
                                {% else %}
                                    <strong>: None</strong>
                                {% endif %}
                            </div>
                        </div>
                    </td>
                    <td rowspan="{{ grouped|length }}">[{{ grouped[0].report.exam.examNoInvigilator }}]</td>
                    {% endif %}

                    <!-- Invigilator Details -->
                    <td>
                        <div class="info-grid">
                            <div>ID</div><div><strong>: {{ att.invigilator.userId }}</strong></div>
                            <div>Name</div><div><strong>: {{ att.invigilator.userName }}</strong></div>
                            <div>Contact</div><div><strong>: {{ att.invigilator.userContact }}</strong></div>
                            <div>Gender</div><div><strong>: {{ att.invigilator.userGender }}</strong></div>
                        </div>
                    </td>

                    <!-- Check-in/out Time -->
                    <td>
                        <div class="info-grid">
                            <div>Check-in Time</div><div><strong>: <span class="checkin-text">{{ att.checkIn.strftime("%d/%b/%Y %H:%M:%S") if att.checkIn else "None" }}</span></strong></div>
                            <div>Check-out Time</div><div><strong>: <span class="checkout-text">{{ att.checkOut.strftime("%d/%b/%Y %H:%M:%S") if att.checkOut else "None" }}</span></strong></div>
                        </div>
                        {% if att.checkIn and att.checkOut %}
                            {% set exam_start = att.report.exam.examStartTime %}
                            {% set exam_end = att.report.exam.examEndTime %}
                            {% set check_in = att.checkIn %}
                            {% set check_out = att.checkOut %}
                            {% set actual_start = [check_in, exam_start] | max %}
                            {% set actual_end = [check_out, exam_end] | min %}
                            {% set total_seconds = (actual_end - actual_start).total_seconds() %}
                            {% if total_seconds < 0 %}{% set total_seconds = 0 %}{% endif %}
                            <div style="color: green;">Total Invigilation Time: {{ (total_seconds / 3600)|hours_format }} hours</div>
                        {% endif %}
                    </td>

                    <!-- Attendance Status -->
                    <td>
                        {% set remark_classes = {
                            "PENDING": "frame-pending",
                            "CHECK IN": "frame-completed",
                            "COMPLETED": "frame-completed",
                            "CHECK IN LATE": "frame-expired",
                            "CHECK OUT EARLY": "frame-expired",
                            "EXPIRED": "frame-expired"
                        } %}
                        <span class="status {{ remark_classes.get(att.remark, '') }}">{{ att.remark }}</span>
                    </td>

                    <!-- Invigilation Status -->
                    <td>
                        {% if att.invigilationStatus %}
                            <span class="status frame-completed">ACCEPTED</span>
                        {% else %}
                            <span class="status frame-pending">PENDING</span>
                        {% endif %}
                    </td>
                    
                    <!-- Action -->
                    <td><button type="button" class="edit-btn" data-id="{{ att.attendanceId }}"><i class="fa fa-edit"></i></button></td>
                </tr>
                {% endfor %}
            </tbody>
            {% endfor %}
        </table>
    </div>
</div>
{% endblock %}


{% block extra_scripts %}
<script>
document.getElementById("generatePDF").addEventListener("click", function () {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: "landscape", unit: "pt", format: "a4" });
    const margin = 20;
    const pageWidth = doc.internal.pageSize.getWidth();

    // Title
    doc.setFont("helvetica", "bold");
    doc.setFontSize(18);
    doc.text("Lecturer Invigilation Report", pageWidth / 2, margin, { align: "center" });

    const startY = margin + 30;

    // Table headers
    const headers = ["Exam ID", "Exam Details", "Invigilators", "Invigilator Details", "Check-in/out Time", "Attendance Status", "Invigilation Status"];
    const rows = [];
    let lastExamID = "", lastExamDetails = "", lastInvCount = "";

    document.querySelectorAll(".user-data-table tbody tr").forEach(tr => {
        const tds = tr.querySelectorAll("td");
        const tdCount = tds.length;

        // Handle rowspan — fill missing columns from previous values
        let examID = "";
        let examDetails = "";
        let invCount = "";
        let invDetails = "";
        let checkTimes = "";
        let attendance = "";
        let invStatus = "";

        if (tdCount === 8) {
            // Normal full row
            examID = tds[0]?.innerText.trim() || "";
            examDetails = tds[1]?.innerText.trim() || "";
            invCount = tds[2]?.innerText.trim() || "";
            invDetails = tds[3]?.innerText.trim() || "";
            checkTimes = tds[4]?.innerText.trim() || "";
            attendance = tds[5]?.innerText.trim() || "";
            invStatus = tds[6]?.innerText.trim() || "";

        } else if (tdCount === 5) {
            // This is a "continuation row" — missing rowspan columns
            invDetails = tds[0]?.innerText.trim() || "";
            checkTimes = tds[1]?.innerText.trim() || "";
            attendance = tds[2]?.innerText.trim() || "";
            invStatus = tds[3]?.innerText.trim() || "";
        }

        // Clean up text formatting
        [examDetails, invDetails, checkTimes] = [examDetails, invDetails, checkTimes].map(text =>
            text.replace(/\s*:\s*/g, " : ")
        );

        rows.push([examID, examDetails, invCount, invDetails, checkTimes, attendance, invStatus]);
    });

    // Generate PDF table
    doc.autoTable({
        head: [headers],
        body: rows,
        startY: startY,
        theme: "grid",
        styles: {font: "helvetica", fontSize: 8, cellPadding: 4, overflow: "linebreak", valign: "top", halign: "left"},
        headStyles: {fillColor: [33, 37, 41], textColor: 255, fontStyle: "bold" },
        tableWidth: "auto",
        margin: { top: margin, left: margin, right: margin, bottom: margin },
        didDrawPage: function (data) {
            const pageCount = doc.internal.getNumberOfPages();
            const pageHeight = doc.internal.pageSize.height;
            doc.setFontSize(9);
            doc.setTextColor(100);
            doc.text(`Page ${pageCount}`, pageWidth - margin, pageHeight - 10, { align: "right" });
        }
    });
    doc.save("Admin_ViewInvigilationReport.pdf");
});

document.addEventListener("DOMContentLoaded", function () {
    const checkinClass = "checkin-text";
    const checkoutClass = "checkout-text";

    // Convert displayed date text to ISO format for input[type="datetime-local"]
    function toLocalInput(dateText) {
        if (!dateText || dateText === "None") return "";

        // Parse browser-local date
        const parsed = new Date(dateText);
        // Add 8 hours if necessary
        parsed.setHours(parsed.getHours());
        // Format as: yyyy-MM-ddTHH:mm:ss (for datetime-local with seconds)
        const pad = (n) => n.toString().padStart(2, "0");

        const yyyy = parsed.getFullYear();
        const mm = pad(parsed.getMonth() + 1);
        const dd = pad(parsed.getDate());
        const hh = pad(parsed.getHours());
        const min = pad(parsed.getMinutes());
        const ss = pad(parsed.getSeconds());
        return `${yyyy}-${mm}-${dd}T${hh}:${min}:${ss}`;
    }

    // Attach edit listener to a single button
    function attachEditListener(btn) {
        btn.addEventListener("click", () => makeRowEditable(btn));
    }

    // Main function to handle row editing
    function makeRowEditable(btn) {
        const tr = btn.closest("tr");
        const attendanceId = btn.dataset.id;
        const tbody = tr.closest("tbody");

        const checkInSpan = tr.querySelector(`.${checkinClass}`);
        const checkOutSpan = tr.querySelector(`.${checkoutClass}`);
        const originalCheckIn = checkInSpan.textContent.trim();
        const originalCheckOut = checkOutSpan.textContent.trim();

        if (tr.classList.contains("editing")) return;
        tr.classList.add("editing");

        const checkInValue = toLocalInput(originalCheckIn);
        const checkOutValue = toLocalInput(originalCheckOut);
        checkInSpan.innerHTML = `<input type="datetime-local" step="1" class="checkin-input" value="${checkInValue}" style="width: 180px;">`;
        checkOutSpan.innerHTML = `<input type="datetime-local" step="1" class="checkout-input" value="${checkOutValue}" style="width: 180px;">`;

        const actionTd = btn.closest("td");
        actionTd.innerHTML = `
            <div class="action-buttons">
                <button type="button" class="save-btn" title="Save"><i class="fa fa-save"></i></button>
                <button type="button" class="cancel-btn" title="Cancel"><i class="fa fa-times"></i></button>
            </div>
        `;

        const saveBtn = actionTd.querySelector(".save-btn");
        const cancelBtn = actionTd.querySelector(".cancel-btn");

        // Save button
        saveBtn.addEventListener("click", async () => {
            const newCheckIn = tr.querySelector(".checkin-input").value;
            const newCheckOut = tr.querySelector(".checkout-input").value;
            try {
                const response = await fetch("/admin/updateAttendanceTime", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        attendance_id: attendanceId,
                        check_in: newCheckIn,
                        check_out: newCheckOut
                    })
                });

                const result = await response.json();
                if (result.success) {
                    alert(result.message);

                    checkInSpan.textContent = result.check_in;
                    checkOutSpan.textContent = result.check_out;

                    tr.querySelector(".status").textContent = result.remark;

                    // Update Total Invigilation Time
                    const totalDiv = tr.querySelector("div[style*='color: green']");
                    if (totalDiv) {
                        totalDiv.textContent = `Total Invigilation Time: ${result.new_hours} hours (Adjusted)`;
                    } else {
                        const newDiv = document.createElement("div");
                        newDiv.style.color = "green";
                        newDiv.textContent = `Total Invigilation Time: ${result.new_hours} hours (Adjusted)`;
                        tr.querySelector("td:nth-child(5)").appendChild(newDiv);
                    }
                                        
                    // Restore Edit button
                    actionTd.innerHTML = `<button type="button" class="edit-btn" data-id="${attendanceId}" title="Edit"><i class="fa fa-edit"></i></button>`;
                    attachEditListener(actionTd.querySelector(".edit-btn"));
                    tr.classList.remove("editing");
                } else {
                    alert("Error: " + result.message);
                }
            } catch (err) {
                alert("Failed to update attendance. Please try again.");
                console.error(err);
            }
        });

        // Cancel button
        cancelBtn.addEventListener("click", () => {
            checkInSpan.textContent = originalCheckIn;
            checkOutSpan.textContent = originalCheckOut;

            actionTd.innerHTML = `<button type="button" class="edit-btn" data-id="${attendanceId}" title="Edit"><i class="fa fa-edit"></i></button>`;
            attachEditListener(actionTd.querySelector(".edit-btn"));
            tr.classList.remove("editing");
        });
    }

    // Attach edit to all edit buttons on page load
    document.querySelectorAll(".edit-btn").forEach(attachEditListener);
});

document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("searchInput");
    const noResults = document.getElementById("noResults");
    const allGroups = document.querySelectorAll("#manageInvigilationReport tbody");

    searchInput.addEventListener("input", function () {
        const filter = this.value.toLowerCase().trim();
        let foundAny = false;

        allGroups.forEach(tbody => {
            const rows = Array.from(tbody.querySelectorAll("tr"));
            let groupMatch = false;

            // Check if any row matches the filter
            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                if (!filter || text.includes(filter)) {
                    groupMatch = true;
                }
            });

            if (groupMatch) {
                // Show all rows in the group, so rowspan cells are preserved
                rows.forEach(row => row.style.display = "");
                foundAny = true;
            } else {
                // Hide all rows in the group
                rows.forEach(row => row.style.display = "none");
            }
        });

        // Toggle "No results found"
        noResults.style.display = foundAny ? "none" : "block";
    });
});
</script>
{% endblock %}
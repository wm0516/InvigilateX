{% extends "admin/adminBase.html" %}
{% set show_tabs = true %}
{% set show_upload = true %}
{% set show_cal = true %}
{% set show_dashboard = true %}
{% set show_manual = false %}
{% set show_edit = true %}
{% block title %}Admin ManageInvigilationReport{% endblock %}
{% block head_title %}<h2>Manage Invigilation Report</h2>{% endblock %}

{% block dashboard_section %}
<!-- Dashboard Form -->
<form id="dashboardForm" action="{{ url_for('admin_manageInvigilationReport') }}" method="POST">
    <div id="dashboardSection">
        <input type="hidden" name="form_type" value="dashboard">
        <div class="form-profile" style="width: 100%">
            <div class="dashboard-row">
                <div class="dashboard-frame">
                    <h3>Pending Invigilation Duties</h3>
                    <p class="dashboard-text">{{ total_activeReport }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Completed Invigilation Duties</h3>
                    <p class="dashboard-text">{{ total_report - total_activeReport }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Checked In Late</h3>
                    <p class="dashboard-text" style="color:red;">{{ total_checkInLate }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Checked Out Early</h3>
                    <p class="dashboard-text" style="color:red;">{{ total_checkOutEarly }}</p>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block upload_section %}
<!-- Upload Form -->
<form id="uploadForm" action="{{ url_for('admin_manageInvigilationReport') }}" method="POST" enctype="multipart/form-data">
    <div id="uploadSection" class="function-frame" style="width:80%">
        <div class="form-profile" style="width: 100%">
            <h4 style="text-align: center;">File Upload Section</h4>
            <label for="attendance_list">
                <div class="upload-container" id="attendanceUploadContainer">
                    <div class="upload-text">
                        Please upload an Excel file with the sheet name <b>Clock_IO</b>.<br>
                        Data should begin from columns <b>A to E</b>, with headers as follows:<br><br>
                        <i>[CARD UID, Name, Date, Time, In/Out]</i><br><br>
                        Click below to upload, or drag and drop a file (accepted formats: <b>XLSX, XLS, XLSM</b>).
                    </div><br>
                    <div id="attendanceSelectedFileName" class="file-name-display"></div>
                </div>
            </label>
            <input type="file" id="attendance_list" name="attendance_file" accept=".xlsx,.xls,.xlsm" style="display: none;">
            <input type="hidden" name="form_type" value="upload">
            <br>
            <div class="button-wrapper">
                <button type="submit">Upload Attendance Record</button>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block edit_section %}
<form id="editForm" action="{{ url_for('admin_manageInvigilationReport') }}" method="POST">
    <div id="editSection" class="function-frame">
        <h4 style="text-align:center;">Edit Invigilation Assignments</h4>
        <div class="profile-frame">
            <div class="form-profile">
                <label>Select Venue Session</label>
                <select id="editSession" name="venueSessionId" required>
                    <option value="" disabled selected>-- Select Session --</option>
                    {% for (venue, start, end), data in grouped_att.items() %}
                        {% set first_att = data.invigilators[0] %}
                        <option value="{{ first_att.venueSessionId }}">
                            Venue [{{ venue }}] - {{ start.strftime("%d/%b/%Y %H:%M") }} → {{ end.strftime("%d/%b/%Y %H:%M") }}
                        </option>
                    {% endfor %}
                </select><br>
                <label>Assigned Invigilators</label>
                <div id="invigilatorList"></div>
            </div>
        </div>

        <input type="hidden" name="form_type" value="edit">
        <div class="button-wrapper">
            <button type="submit" style="background:#d4edda;color:#155724;">Update Invigilators</button>
        </div>
    </div>
</form>
{% endblock %}


{% block content %}
<div class="menu-section">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h3>List of Invigilator's Invigilation Report(s)</h3>
        <div style="display: flex; align-items: center; gap: 10px;">
            <div style="position: relative;">
                <input type="text" id="searchInput" name="search_report" placeholder="Search..." value="{{ search_report }}" style="border-radius: 6px; width: 100%;">
                <i class="fa fa-search" id="searchBtn" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer;"></i>
            </div>
            <div class="button-wrapper">
                <button id="generatePDF" style="background-color: black;">Download as PDF</button>
            </div>
        </div>
    </div>
    <div id="noResults" style="display: none; text-align: center; font-weight: bold; color: #b00;">No results found.</div>
    <table class="user-data-table" id="manageInvigilationReport">
        <thead>
            <tr>
                <th>Exam Venue</th>
                <th>Exam Date</th>
                <th>Exam CourseCode</th>
                <th>Invigilator Details</th>
                <th>Invigilation Status</th>
                <th>Attendance Status</th>
                <th>Check-in/out</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for (venue, start, end), data in grouped_att.items() %}
                {% set num_invigilators = data.invigilators | length %}
                {% for att in data.invigilators %}
                    <tr>
                        {% if loop.first %}
                            <td rowspan="{{ num_invigilators }}">[{{ venue }}]</td>
                            <td rowspan="{{ num_invigilators }}">{{ start.strftime("%d/%b/%Y %H:%M") }} - {{ end.strftime("%d/%b/%Y %H:%M") }}</td>
                            <td rowspan="{{ num_invigilators }}">
                                {% for c in data.courses %}
                                    <div><strong>{{ c.code }}</strong> - {{ c.name }}</div>
                                {% endfor %}
                            </td>
                        {% endif %}

                        <td>{{ att.invigilator.userName }} ({{ att.invigilator.userId }})</td>
                        <td>{{ "ACCEPTED" if att.invigilationStatus else "PENDING" }}</td>
                        <td>{{ att.remark or "PENDING" }}</td>
                        <td>
                            {{ att.checkIn.strftime("%d/%b/%Y %H:%M:%S") if att.checkIn else "None" }} /
                            {{ att.checkOut.strftime("%d/%b/%Y %H:%M:%S") if att.checkOut else "None" }}
                        </td>
                        <td>
                            <form method="POST" style="display:inline-block;">
                                <input type="hidden" name="form_type" value="edit">
                                <input type="hidden" name="venueSessionId" value="{{ att.venueSessionId }}">
                                <input type="hidden" name="invigilatorId" value="{{ att.invigilatorId }}">
                                <button type="submit" class="edit-btn">Edit</button>
                            </form>
                        </td>
                    </tr>
                {% endfor %}
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}


{% block extra_scripts %}
<script>
document.getElementById("generatePDF").addEventListener("click", function () {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: "landscape", unit: "pt", format: "a4" });
    const margin = 20;
    const pageWidth = doc.internal.pageSize.getWidth();
    const nowMY = new Date().toLocaleString("en-GB", {timeZone: "Asia/Kuala_Lumpur", day: "2-digit", month: "short", year: "numeric", hour: "2-digit", minute: "2-digit", hour12: true});
    
    // ===== Title =====
    doc.setFont("helvetica", "bold");
    doc.setFontSize(18);
    doc.text("Admin View - Invigilation Report Download", pageWidth / 2, margin, { align: "center" });

    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);
    doc.text(`Downloaded on: ${nowMY}`, pageWidth / 2, margin + 18, { align: "center" });
    const startY = margin + 30;

    // Table headers
    const headers = ["Venue", "Exam Date", "Courses", "Invigilator", "Status", "Attendance", "Check-in/out"];
    const rows = [];

    document.querySelectorAll("#manageInvigilationReport tbody tr").forEach(tr => {
        const tds = tr.querySelectorAll("td");
        let venue = "", examDate = "", courses = "";
        let invigilator = "", status = "", attendance = "", checkTimes = "";

        if (tds.length === 8) { // first row with venue/exam/course
            venue = tds[0].innerText.trim();
            examDate = tds[1].innerText.trim();
            courses = tds[2].innerText.trim();
            invigilator = tds[3].innerText.trim();
            status = tds[4].innerText.trim();
            attendance = tds[5].innerText.trim();
            checkTimes = tds[6].innerText.trim();
        } else if (tds.length === 7) { // continuation rows (venue/course/exam blank)
            invigilator = tds[0]?.innerText.trim() || "";
            status = tds[1]?.innerText.trim() || "";
            attendance = tds[2]?.innerText.trim() || "";
            checkTimes = tds[3]?.innerText.trim() || "";
        }

        // For subsequent invigilators, blank venue/exam/courses
        if (tds[0].hasAttribute("rowspan") === false) {
            venue = "";
            examDate = "";
            courses = "";
        }

        rows.push([venue, examDate, courses, invigilator, status, attendance, checkTimes]);
    });
    
    // Generate PDF table
    doc.autoTable({
        head: [headers],
        body: rows,
        startY: startY,
        theme: "grid",
        styles: {font: "helvetica", fontSize: 8, cellPadding: 4, overflow: "linebreak", valign: "top", halign: "left"},
        headStyles: {fillColor: [33, 37, 41], textColor: 255, fontStyle: "bold" },
        tableWidth: "auto",
        margin: { top: margin, left: margin, right: margin, bottom: margin },
        didDrawPage: function (data) {
            const pageCount = doc.internal.getNumberOfPages();
            const pageHeight = doc.internal.pageSize.height;
            doc.setFontSize(9);
            doc.setTextColor(100);
            doc.text(`Page ${pageCount}`, pageWidth - margin, pageHeight - 10, { align: "right" });
        }
    });
    doc.save("Admin_ViewInvigilationReport.pdf");
});

document.addEventListener("DOMContentLoaded", function () {
    const checkinClass = "checkin-text";
    const checkoutClass = "checkout-text";

    // Convert displayed date text to ISO format for input[type="datetime-local"]
    function toLocalInput(dateText) {
        if (!dateText || dateText === "None") return "";

        // Parse browser-local date
        const parsed = new Date(dateText);
        // Add 8 hours if necessary
        parsed.setHours(parsed.getHours());
        // Format as: yyyy-MM-ddTHH:mm:ss (for datetime-local with seconds)
        const pad = (n) => n.toString().padStart(2, "0");

        const yyyy = parsed.getFullYear();
        const mm = pad(parsed.getMonth() + 1);
        const dd = pad(parsed.getDate());
        const hh = pad(parsed.getHours());
        const min = pad(parsed.getMinutes());
        const ss = pad(parsed.getSeconds());
        return `${yyyy}-${mm}-${dd}T${hh}:${min}:${ss}`;
    }

    // Attach edit listener to a single button
    function attachEditListener(btn) {
        btn.addEventListener("click", () => makeRowEditable(btn));
    }

    // Main function to handle row editing
    function makeRowEditable(btn) {
        const tr = btn.closest("tr");
        const attendanceId = btn.dataset.id;
        const tbody = tr.closest("tbody");

        const checkInSpan = tr.querySelector(`.${checkinClass}`);
        const checkOutSpan = tr.querySelector(`.${checkoutClass}`);
        const statusSpan = tr.querySelector(`.invigilation-status`);
        
        const originalCheckIn = checkInSpan.textContent.trim();
        const originalCheckOut = checkOutSpan.textContent.trim();
        const originalStatus = statusSpan.textContent.trim();
        const originalStatusBoolean = originalStatus === "ACCEPTED";

        if (tr.classList.contains("editing")) return;
        tr.classList.add("editing");

        const checkInValue = toLocalInput(originalCheckIn);
        const checkOutValue = toLocalInput(originalCheckOut);
        
        checkInSpan.innerHTML = `<input type="datetime-local" step="1" class="checkin-input" value="${checkInValue}" style="width: 180px;">`;
        checkOutSpan.innerHTML = `<input type="datetime-local" step="1" class="checkout-input" value="${checkOutValue}" style="width: 180px;">`;
        
        // Create dropdown for status
        statusSpan.innerHTML = `
            <select class="status-select" style="width: 120px;">
                <option value="true" ${originalStatusBoolean ? 'selected' : ''}>ACCEPTED</option>
                <option value="false" ${!originalStatusBoolean ? 'selected' : ''}>PENDING</option>
            </select>
        `;

        const actionTd = btn.closest("td");
        actionTd.innerHTML = `
            <div class="action-buttons">
                <button type="button" class="save-btn" title="Save"><i class="fa fa-save"></i></button>
                <button type="button" class="cancel-btn" title="Cancel"><i class="fa fa-times"></i></button>
            </div>
        `;

        const saveBtn = actionTd.querySelector(".save-btn");
        const cancelBtn = actionTd.querySelector(".cancel-btn");

        // Save button
        saveBtn.addEventListener("click", async () => {
            const newCheckIn = tr.querySelector(".checkin-input").value;
            const newCheckOut = tr.querySelector(".checkout-input").value;
            const newStatus = tr.querySelector(".status-select").value === "true";
            
            try {
                const response = await fetch("/admin/updateAttendanceTime", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        venueSessionId: att.venueSessionId,
                        invigilatorId: att.invigilatorId,
                        check_in: newCheckIn,
                        check_out: newCheckOut,
                        invigilation_status: newStatus
                    })
                });

                const result = await response.json();
                if (result.success) {
                    alert(result.message);

                    // Restore Check-in/out text
                    checkInSpan.textContent = result.check_in;
                    checkOutSpan.textContent = result.check_out;

                    // Update attendance remark
                    tr.querySelector(".status").textContent = result.remark;

                    // Update invigilation status
                    const statusClass = result.invigilation_status ? "frame-completed" : "frame-pending";
                    const statusText = result.invigilation_status ? "ACCEPTED" : "PENDING";

                    statusSpan.className = `status ${statusClass} invigilation-status`;
                    statusSpan.textContent = statusText;

                    // Remove total time display (regenerated on refresh)
                    const totalDiv = tr.querySelector("div[style*='color: green']");
                    if (totalDiv) totalDiv.remove();

                    // Restore Edit button
                    actionTd.innerHTML = `
                        <button type="button" class="edit-btn" data-id="${attendanceId}">
                            <i class="fa fa-edit"></i>
                        </button>
                    `;
                    attachEditListener(actionTd.querySelector(".edit-btn"));

                    tr.classList.remove("editing");
                } else {
                    alert("Failed: " + result.message);
                }
            } catch (err) {
                console.error(err);
                alert("An error occurred while updating attendance.");
            }
        });

        // Cancel button
        cancelBtn.addEventListener("click", () => {
            checkInSpan.textContent = originalCheckIn;
            checkOutSpan.textContent = originalCheckOut;
            statusSpan.textContent = originalStatus;

            const statusClass = originalStatusBoolean ? "frame-completed" : "frame-pending";
            statusSpan.className = `status ${statusClass} invigilation-status`;

            // Restore Edit button
            actionTd.innerHTML = `
                <button type="button" class="edit-btn" data-id="${attendanceId}">
                    <i class="fa fa-edit"></i>
                </button>
            `;
            attachEditListener(actionTd.querySelector(".edit-btn"));

            tr.classList.remove("editing");
        });
    }

    // Attach edit to all edit buttons on page load
    document.querySelectorAll(".edit-btn").forEach(attachEditListener);
});

document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("searchInput");
    const noResults = document.getElementById("noResults");
    const tableRows = document.querySelectorAll("#manageInvigilationReport tbody tr");

    searchInput.addEventListener("input", function () {
        const filter = this.value.toLowerCase().trim();
        let foundAny = false;

        tableRows.forEach(row => {
            const text = row.innerText.toLowerCase();
            if (!filter || text.includes(filter)) {
                row.style.display = ""; // show row
                foundAny = true;
            } else {
                row.style.display = "none"; // hide row
            }
        });

        noResults.style.display = foundAny ? "none" : "block";
    });
});

function formatExamDateTime(dtString) {
    // Make it a proper Date object
    const d = new Date(dtString.replace(" ", "T")); // '2026-02-04 12:00' → ISO

    const day = String(d.getDate()).padStart(2, "0");
    const month = d.toLocaleString("en-GB", { month: "short" }); // Feb
    const year = d.getFullYear();
    
    const hours = String(d.getHours()).padStart(2, "0");
    const minutes = String(d.getMinutes()).padStart(2, "0");

    return `${day}${month}${year} ${hours}:${minutes}`;
}

document.addEventListener("DOMContentLoaded", () => {
    const reportSelect = document.getElementById("editReport");
    const courseInfo = document.getElementById("courseInfo");
    const examTime = document.getElementById("examTime");
    const middleSlots = document.getElementById("middleSlots");
    const rightSlots = document.getElementById("rightSlots");

    async function loadReport(id) {
        const resp = await fetch(`/get_report/${id}`);
        const data = await resp.json();
        if (data.error) { alert(data.error); return; }

        // ✔ Combined Course field
        courseInfo.value = `${data.courseCode} - ${data.courseName}`;
        // ✔ Combined Exam Time
        examTime.value = `${formatExamDateTime(data.examStart)} → ${formatExamDateTime(data.examEnd)}`;
        middleSlots.innerHTML = "";
        rightSlots.innerHTML = "";

        for (let i = 0; i < data.attendances.length; i++) {
            const att = data.attendances[i];

            middleSlots.innerHTML += `
                <div>
                    <label>Assigned Invigilator [<b>Venue</b>: ${att.venue}]</label>
                    <input type="text" value="${att.invigilatorName}" readonly>
                </div>
                ${i < data.attendances.length - 1 ? '<br>' : ''}
            `;

            const slotWrapper = document.createElement("div");
            slotWrapper.innerHTML = `
                <label>New Invigilator [<b>Gender</b>: ${att.gender}]</label>
                <select name="slot_${att.attendanceId}" required>
                    <option disabled>Loading...</option>
                </select>
            `;

            rightSlots.appendChild(slotWrapper);
            if (i < data.attendances.length - 1) {
                rightSlots.appendChild(document.createElement("br"));
            }

            const dropdown = slotWrapper.querySelector("select");
            fetch(`/get_valid_invigilators`)
                .then(res => res.json())
                .then(invigilators => {
                    dropdown.innerHTML = "";
                    for (let u of invigilators) {
                        dropdown.innerHTML += `
                            <option value="${u.userId}" ${u.userId == att.invigilatorId ? "selected" : ""}>
                                ${u.userName}
                            </option>`;
                    }
                });
        }
    }
    reportSelect.addEventListener("change", () => loadReport(reportSelect.value));
});
</script>
{% endblock %}
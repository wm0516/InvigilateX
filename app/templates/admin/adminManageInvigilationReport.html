{% extends "admin/adminBase.html" %}
{% set show_tabs = true %}
{% set show_upload = false %}
{% set show_dashboard = true %}
{% set show_manual = false %}
{% set show_edit = true %}
{% block title %}Admin ManageInvigilationReport{% endblock %}
{% block head_title %}<h2>Manage Invigilation Report</h2>{% endblock %}

{% block dashboard_section %}
<!-- Dashboard Form -->
<form id="dashboardForm" action="{{ url_for('admin_manageInvigilationReport') }}" method="POST">
    <div id="dashboardSection" style="width: 90%; margin:auto; padding:1%">
        <input type="hidden" name="form_type" value="dashboard">
        <div class="form-left" style="width: 100%">
            <div class="dashboard-row" style="grid-template-columns: repeat(7, 1fr);">
                <div class="dashboard-frame">
                    <h3>Active Reports</h3>
                    <p class="dashboard-text">{{ total_report }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Exam In Going</h3>
                    <p class="dashboard-text" style="color:green;">{{ total_inProgress   }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Pending Check-In/Out</h3>
                    <p class="dashboard-text" style="color:red;">{{ total_checkInOut }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Checked In On Time</h3>
                    <p class="dashboard-text" style="color:green;">{{ total_checkInOnTime }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Checked Out On Time</h3>
                    <p class="dashboard-text" style="color:green;">{{ total_checkOutOnTime }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Checked In Late</h3>
                    <p class="dashboard-text" style="color:red;">{{ total_checkInLate }}</p>
                </div>
                <div class="dashboard-frame">
                    <h3>Checked Out Early</h3>
                    <p class="dashboard-text" style="color:red;">{{ total_checkOutEarly }}</p>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block edit_section %}
<!-- Edit Form -->
<form id="editForm" action="{{ url_for('admin_manageInvigilationReport') }}" method="POST">
    <div id="editSection" style="width: 100%; margin:auto;">
        <input type="hidden" name="form_type" value="edit">
        <div class="form-left" style="width: 100%">
        </div>
    </div>
</form>
{% endblock %}


{% block content %}
<div class="menu-section">
    <h3>List of Lecturer Invigilation Report</h3>
    <div class="user-table-container">
        <table class="user-data-table">
            <thead>
                <tr>
                    <th>Exam ID</th>
                    <th>Exam Details</th>
                    <th>Number of Invigilators</th>
                    <th>Invigilator Details</th>
                    <th>Check-in/out Time</th>
                    <th>Attendance Status</th>
                    <th>Invigilation Status</th>
                </tr>
            </thead>
            <tbody>
                {% for (status, start_time), grouped in attendances|groupby("group_key") %}
                    {% set inv_count = grouped|length %}
                    {% set expected_count = grouped[0].report.exam.examNoInvigilator %}
                    {% set missing_count = expected_count - inv_count %}

                    {% for att in grouped %}
                        <tr class="
                            {% if not att.report.exam.examStatus %}
                                inactive-row-show
                            {% elif att.report.exam.examVenue is none %}
                                error-row-show
                            {% endif %}
                        "> 
                            {% if loop.first %}
                                <!-- Exam ID -->
                                <td rowspan="{{ expected_count }}" style="text-align:center;">[{{ att.report.exam.examId }}]</td>

                                <!-- Exam Details -->
                                <td rowspan="{{ expected_count }}">
                                    {{ att.report.exam.course.courseName }} ({{ att.report.exam.course.courseCodeSectionIntake }})
                                </td>

                                <!-- Number of Invigilators -->
                                <td rowspan="{{ expected_count }}">[{{ expected_count }}]</td>
                            {% endif %}

                            <!-- Invigilator Details -->
                            <td>
                                {% if att.invigilationStatus %}
                                    ID: {{ att.invigilator.userId }}<br>
                                    Name: {{ att.invigilator.userName }}<br>
                                    Contact: {{ att.invigilator.userContact }}<br>
                                    Gender: {{ att.invigilator.userGender }}
                                {% else %}
                                    <em>In Processing</em>
                                {% endif %}
                            </td>

                            <!-- Check-in/out Time -->
                            <td>
                                {% if att.invigilationStatus %}
                                    Check-in: {{ att.checkIn }}<br>
                                    Check-out: {{ att.checkOut }}
                                {% else %}
                                    <em>--</em>
                                {% endif %}
                            </td>

                            <!-- Attendance Status -->
                            <td>
                                {% if att.invigilationStatus %}
                                    [{{ att.remark }}]
                                {% else %}
                                    <em>--</em>
                                {% endif %}
                            </td>

                            <!-- Invigilation Status -->
                            <td>
                                {% if att.invigilationStatus %}
                                    Accepted
                                {% else %}
                                    <span style="color:red;">In Processing</span>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}

                    <!-- Fill missing rows if some invigilators not present -->
                    {% for i in range(missing_count) %}
                        <tr>
                            <td><em>In Processing</em></td>
                            <td><em>--</em></td>
                            <td><em>--</em></td>
                            <td><span style="color:red;">In Processing</span></td>
                        </tr>
                    {% endfor %}
                {% endfor %}
            </tbody>    
        </table>
    </div>
</div>

{% endblock %}
